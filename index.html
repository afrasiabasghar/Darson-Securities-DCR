<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darson Securities Limited - Commission Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence // Or browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            collection, 
            addDoc,
            query, 
            where, 
            getDocs,
            Timestamp,
            writeBatch,
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        let app;
        let auth;
        let db;
        let userId;
        let currentView = 'login'; // Initial view

        // App configuration
        const APP_NAME = "Darson Securities Limited";
        const APP_SUBTITLE = "Commission Report";
        const DEVELOPER_INFO = "Developed by Afrasiab Asghar. Visit www.Nexgensites.org or Contact +923060406003";
        const LOGIN_USERNAME = "DARSON";
        const LOGIN_PASSWORD = "AFRASIAB"; // Also used for report deletion

        // Firestore collection paths
        const getTransactionsCollectionPath = () => `artifacts/${appId}/users/${userId}/transactions`;
        const getDailySummariesCollectionPath = () => `artifacts/${appId}/users/${userId}/dailySummaries`;
        const getMonthlySummariesCollectionPath = () => `artifacts/${appId}/users/${userId}/monthlySummaries`;
        const getPaymentRequestsCollectionPath = () => `artifacts/${appId}/users/${userId}/paymentRequests`;
        const getAppStateDocPath = () => `artifacts/${appId}/users/${userId}/appState/currentUserState`;
        
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'brokerage-app-dev';


        // State variables
        let dailyEntries = [];
        let currentBalance = 0;
        let balanceVisible = true;
        let selectedDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

        // Commission Rates Structure
        const commissionRates = [
            { min: 0.01, max: 3.00, rate: 0.03, type: 'flat' },
            { min: 3.01, max: 20.00, rate: 0.07, type: 'flat' },
            { min: 20.01, max: 40.00, rate: 0.09, type: 'flat' },
            { min: 40.01, max: 50.00, rate: 0.12, type: 'flat' },
            { min: 50.01, max: 90.00, rate: 0.14, type: 'flat' },
            { min: 90.01, max: 100.00, rate: 0.17, type: 'flat' },
            { min: 100.01, max: Infinity, rate: 0.0017, type: 'percentage' } // 0.17%
        ];

        // Deduction percentages
        const HEAD_OFFICE_DEDUCTION_RATE = 0.40; // 40%
        const TAX_ON_REMAINING_RATE = 0.12; // 12% on the remaining 60%

        // DOM Elements (to be assigned in DOMContentLoaded)
        let loginSection, appSection, mainContent, sidebar;
        let usernameInput, passwordInput, loginError;
        let currentViewTitle, currentDateDisplay, mainHeaderTitleEl, footerDevInfoP, loginDevInfoP;
        // Dashboard elements
        let stockNameInput, quantityInput, rateInput, addEntryButton, entriesTableBody, dailySummaryDiv;
        let dashboardDateInput, totalGrossCommissionEl, headOfficeDeductionEl, taxableAmountEl, taxDeductionEl, netCommissionEl;
        let previousBalanceEl, currentDayNetCommissionEl, newBalanceEl, saveDayButton, printDayButton;
        let balanceDisplayEl, toggleBalanceButton;
        // Report elements
        let reportDateInput, reportMonthInput, viewDateReportButton, viewMonthReportButton, reportContentDiv, deleteReportButton;
        // Payment elements
        let prDateInput, prAmountInput, prAddButton, prListDiv;
        // Month Closure elements
        let mcMonthInput, mcCloseMonthButton, mcReportDiv;
        let modal, modalContent, modalCloseButton, modalTitle, modalBody, modalActions;


        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => `PKR ${Number(amount).toFixed(2)}`;
        const formatDate = (dateStrOrObj) => {
            const date = new Date(dateStrOrObj);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const getMonthYear = (dateStrOrObj) => {
            const date = new Date(dateStrOrObj);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        const showToast = (message, type = 'info') => {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            if (!toast || !toastMessage) {
                console.warn("Toast elements not found for message:", message);
                return;
            }
            toastMessage.textContent = message;
            
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500', 'bg-yellow-500');
            if (type === 'success') toast.classList.add('bg-green-500');
            else if (type === 'error') toast.classList.add('bg-red-500');
            else if (type === 'warning') toast.classList.add('bg-yellow-500');
            else toast.classList.add('bg-blue-500');
            
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 3000);
        };
        
        const showModal = (title, bodyContent, actions = []) => {
            if (!modal || !modalTitle || !modalBody || !modalActions) {
                console.error("Modal elements not found.");
                return;
            }
            modalTitle.textContent = title;
            modalBody.innerHTML = ''; // Clear previous content
            if (typeof bodyContent === 'string') {
                const p = document.createElement('p');
                p.innerHTML = bodyContent; // Use innerHTML to allow basic HTML like <br>
                modalBody.appendChild(p);
            } else {
                modalBody.appendChild(bodyContent); // Append DOM element directly
            }

            modalActions.innerHTML = '';
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.label;
                button.className = action.className || 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                button.onclick = () => {
                    action.callback(); // Consider if callback should prevent hideModal
                    hideModal();
                };
                modalActions.appendChild(button);
            });
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'px-4 py-2 bg-gray-300 text-black rounded hover:bg-gray-400 ml-2';
            cancelButton.onclick = hideModal;
            modalActions.appendChild(cancelButton);

            modal.classList.remove('hidden');
        };

        const hideModal = () => {
            if(modal) modal.classList.add('hidden');
        };

        const promptPassword = (callbackOnSuccess) => {
            const passwordPromptDiv = document.createElement('div');
            passwordPromptDiv.innerHTML = `
                <label for="modalPasswordInput" class="block text-sm font-medium text-gray-700">Enter Password:</label>
                <input type="password" id="modalPasswordInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" autocomplete="current-password">
                <p id="modalPasswordError" class="text-red-500 text-sm mt-1 hidden"></p>
            `;
            const actions = [{
                label: 'Submit',
                className: 'px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600',
                callback: () => {
                    const enteredPassword = document.getElementById('modalPasswordInput').value;
                    const errorEl = document.getElementById('modalPasswordError');
                    if (enteredPassword === LOGIN_PASSWORD) {
                        if (errorEl) errorEl.classList.add('hidden');
                        callbackOnSuccess();
                        // hideModal() will be called by the showModal's action wrapper
                    } else {
                        if (errorEl) {
                           errorEl.textContent = 'Incorrect password.';
                           errorEl.classList.remove('hidden');
                        }
                         showToast('Incorrect password.', 'error');
                         // Modal remains open for re-try if showModal's callback doesn't auto-hide on error.
                         // Current implementation hides it.
                    }
                }
            }];
            showModal('Password Required', passwordPromptDiv, actions);
        };


        // --- FIREBASE SETUP ---
        const initializeFirebase = async () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                if (!firebaseConfig.apiKey) { 
                    console.error("Firebase config is missing or invalid.");
                    if (loginError) {
                        loginError.textContent = "Application configuration error. Cannot initialize.";
                        loginError.classList.remove('hidden');
                    }
                    return false;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 

                await setPersistence(auth, browserLocalPersistence); 

                return new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User is signed in with UID:", userId);
                            await loadInitialData();
                            resolve(true);
                        } else {
                            console.log("No user signed in. Attempting sign in...");
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Error during automated sign-in:", error);
                                if(loginError) {
                                    loginError.textContent = "Authentication failed. Please try again later.";
                                    loginError.classList.remove('hidden');
                                }
                                resolve(false);
                            }
                        }
                    });
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                if (loginError) {
                    loginError.textContent = "Failed to initialize application services.";
                    loginError.classList.remove('hidden');
                }
                return false;
            }
        };

        // --- DATA HANDLING ---
        const loadInitialData = async () => {
            if (!userId) return;
            try {
                const appStateRef = doc(db, getAppStateDocPath());
                const appStateSnap = await getDoc(appStateRef);
                if (appStateSnap.exists()) {
                    const data = appStateSnap.data();
                    currentBalance = data.currentBalance || 0;
                } else {
                    await setDoc(appStateRef, { currentBalance: 0, lastMonthClosed: null });
                    currentBalance = 0;
                }
                updateBalanceDisplay();
                if (currentView === 'dashboard') {
                    loadDashboardData(); 
                }
            } catch (error) {
                console.error("Error loading initial data:", error);
                showToast("Error loading initial application state.", "error");
            }
        };

        const updateAppState = async (data) => {
            if (!userId) return;
            try {
                const appStateRef = doc(db, getAppStateDocPath());
                await updateDoc(appStateRef, data);
            } catch (error) {
                console.error("Error updating app state:", error);
                showToast("Error saving application state.", "error");
            }
        };

        // --- COMMISSION CALCULATION ---
        const calculateCommissionForItem = (quantity, stockRate) => {
            let commissionPerStock = 0;
            let totalCommission = 0;

            for (const tier of commissionRates) {
                if (stockRate >= tier.min && stockRate <= tier.max) {
                    if (tier.type === 'flat') {
                        commissionPerStock = tier.rate;
                        totalCommission = quantity * commissionPerStock;
                    } else if (tier.type === 'percentage') {
                        commissionPerStock = (stockRate * tier.rate); 
                        totalCommission = quantity * stockRate * tier.rate;
                    }
                    break;
                }
            }
            return { commissionPerStock, totalCommission };
        };
        
        const calculateDailySummary = () => {
            const gross = dailyEntries.reduce((sum, entry) => sum + entry.totalCommission, 0);
            const hoDeduction = gross * HEAD_OFFICE_DEDUCTION_RATE;
            const remainingAfterHO = gross - hoDeduction;
            const tax = remainingAfterHO * TAX_ON_REMAINING_RATE;
            const net = remainingAfterHO - tax;

            return {
                grossCommission: gross,
                headOfficeDeduction: hoDeduction,
                taxableAmount: remainingAfterHO, 
                taxDeduction: tax,
                netCommission: net
            };
        };

        // --- UI UPDATES & NAVIGATION ---
        const switchView = (viewName) => {
            currentView = viewName;
            document.querySelectorAll('#mainContent > div[data-view]').forEach(div => div.classList.add('hidden'));
            const targetView = document.getElementById(`view-${viewName}`);
            
            if (targetView) {
                targetView.classList.remove('hidden');
                if(currentViewTitle) currentViewTitle.textContent = APP_SUBTITLE + (viewName !== 'dashboard' ? ` - ${viewName.charAt(0).toUpperCase() + viewName.slice(1).replace(/([A-Z])/g, ' $1')}` : '');
            } else {
                console.error(`View "${viewName}" not found.`);
                const dashboardView = document.getElementById('view-dashboard');
                if (dashboardView) dashboardView.classList.remove('hidden'); 
                if(currentViewTitle) currentViewTitle.textContent = APP_SUBTITLE;
            }
            
            document.querySelectorAll('#sidebar a').forEach(a => {
                a.classList.remove('bg-gray-700', 'text-white');
                a.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                if (a.getAttribute('data-view') === viewName) {
                    a.classList.add('bg-gray-700', 'text-white');
                }
            });

            if (viewName === 'dashboard') loadDashboardData();
            if (viewName === 'dailyReports' || viewName === 'monthlyReports') clearReportContent();
            if (viewName === 'paymentRequests') loadPaymentRequests();
            if (viewName === 'monthClosure') clearMonthClosureReport();

            if(currentDateDisplay) currentDateDisplay.textContent = formatDate(new Date()); 
        };

        const updateBalanceDisplay = () => {
            if (balanceDisplayEl) {
                balanceDisplayEl.textContent = balanceVisible ? formatCurrency(currentBalance) : 'PKR ******';
            }
            if (previousBalanceEl) previousBalanceEl.textContent = formatCurrency(currentBalance); 
            updateDashboardSummary(); 
        };

        const toggleBalanceVisibility = () => {
            balanceVisible = !balanceVisible;
            if(toggleBalanceButton) toggleBalanceButton.innerHTML = balanceVisible ? eyeIconSVG() : eyeSlashIconSVG();
            updateBalanceDisplay();
        };
        
        // --- DASHBOARD FUNCTIONS ---
        const loadDashboardData = () => {
            if(dashboardDateInput) dashboardDateInput.value = selectedDate;
            dailyEntries = []; 
            renderEntriesTable();
            updateDashboardSummary();
            updateBalanceDisplay(); 
            checkExistingDailySummary(selectedDate);
        };

        const checkExistingDailySummary = async (date) => {
            if (!userId || !db) return;
            const summaryRef = doc(db, getDailySummariesCollectionPath(), date);
            try {
                const docSnap = await getDoc(summaryRef);
                if (docSnap.exists()) {
                    showToast(`Data for ${date} already saved. Editing will overwrite.`, "warning");
                    const data = docSnap.data();
                    dailyEntries = data.transactions || [];
                    renderEntriesTable();
                    updateDashboardSummary();
                }
            } catch (error) {
                console.error("Error checking existing summary:", error);
            }
        };

        const handleAddEntry = () => {
            if (!stockNameInput || !quantityInput || !rateInput) return;
            const stockName = stockNameInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const rate = parseFloat(rateInput.value);

            if (!stockName || isNaN(quantity) || quantity <= 0 || isNaN(rate) || rate <= 0) {
                showToast("Please enter valid stock name, quantity, and rate.", "error");
                return;
            }

            const { commissionPerStock, totalCommission } = calculateCommissionForItem(quantity, rate);
            
            dailyEntries.push({
                id: `temp-${Date.now()}`, 
                stockName,
                quantity,
                rate,
                commissionPerStock,
                totalCommission
            });

            renderEntriesTable();
            updateDashboardSummary();

            stockNameInput.value = '';
            quantityInput.value = '';
            rateInput.value = '';
            stockNameInput.focus();
        };

        const renderEntriesTable = () => {
            if (!entriesTableBody) return;
            entriesTableBody.innerHTML = ''; 
            if (dailyEntries.length === 0) {
                entriesTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">No entries added yet.</td></tr>`; // colspan updated to 7
                return;
            }
            dailyEntries.forEach((entry, index) => {
                const row = entriesTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-2 border">${index + 1}</td>
                    <td class="px-4 py-2 border">${entry.stockName}</td>
                    <td class="px-4 py-2 border text-right">${entry.quantity}</td>
                    <td class="px-4 py-2 border text-right">${formatCurrency(entry.rate)}</td>
                    <td class="px-4 py-2 border text-right">${formatCurrency(entry.commissionPerStock)}</td>
                    <td class="px-4 py-2 border text-right">${formatCurrency(entry.totalCommission)}</td>
                    <td class="px-4 py-2 border print-hidden"><button data-id="${entry.id}" class="text-red-500 hover:text-red-700 remove-entry-btn">Remove</button></td>
                `;
            });
            document.querySelectorAll('.remove-entry-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const entryId = e.target.getAttribute('data-id');
                    dailyEntries = dailyEntries.filter(item => item.id !== entryId);
                    renderEntriesTable();
                    updateDashboardSummary();
                });
            });
        };

        const updateDashboardSummary = () => {
            if (!totalGrossCommissionEl || !headOfficeDeductionEl || !taxableAmountEl || !taxDeductionEl || !netCommissionEl || !previousBalanceEl || !currentDayNetCommissionEl || !newBalanceEl) return;
            const summary = calculateDailySummary();
            totalGrossCommissionEl.textContent = formatCurrency(summary.grossCommission);
            headOfficeDeductionEl.textContent = formatCurrency(summary.headOfficeDeduction);
            taxableAmountEl.textContent = formatCurrency(summary.taxableAmount);
            taxDeductionEl.textContent = formatCurrency(summary.taxDeduction);
            netCommissionEl.textContent = formatCurrency(summary.netCommission);
            
            previousBalanceEl.textContent = formatCurrency(currentBalance); 
            currentDayNetCommissionEl.textContent = formatCurrency(summary.netCommission);
            newBalanceEl.textContent = formatCurrency(currentBalance + summary.netCommission);
        };

        const handleSaveDay = async () => {
            if (dailyEntries.length === 0) {
                showToast("No entries to save.", "warning");
                return;
            }
            if (!userId || !db) {
                showToast("User not authenticated or database not ready. Cannot save.", "error");
                return;
            }
            if (!dashboardDateInput) return;
            const dateToSave = dashboardDateInput.value;
            if (!dateToSave) {
                showToast("Please select a valid date.", "error");
                return;
            }

            const summary = calculateDailySummary();
            const dailySummaryData = {
                date: dateToSave,
                monthYear: getMonthYear(dateToSave),
                totalGrossCommission: summary.grossCommission,
                headOfficeDeduction: summary.headOfficeDeduction,
                taxableAmount: summary.taxableAmount,
                taxDeduction: summary.taxDeduction,
                netCommission: summary.netCommission,
                transactions: dailyEntries.map(e => ({ 
                    stockName: e.stockName, 
                    quantity: e.quantity, 
                    rate: e.rate, 
                    commissionPerStock: e.commissionPerStock, 
                    totalCommission: e.totalCommission 
                })),
                openingBalance: currentBalance, 
                closingBalance: currentBalance + summary.netCommission,
                createdAt: Timestamp.now()
            };

            try {
                const dailySummaryRef = doc(db, getDailySummariesCollectionPath(), dateToSave);
                const existingSummarySnap = await getDoc(dailySummaryRef);
                let oldNetCommission = 0;
                if (existingSummarySnap.exists()) {
                    oldNetCommission = existingSummarySnap.data().netCommission || 0;
                    showToast(`Overwriting existing data for ${dateToSave}.`, "info");
                }

                const batch = writeBatch(db);
                batch.set(dailySummaryRef, dailySummaryData); 

                const newOverallBalance = currentBalance - oldNetCommission + summary.netCommission;
                batch.update(doc(db, getAppStateDocPath()), { currentBalance: newOverallBalance });
                
                await batch.commit();

                currentBalance = newOverallBalance; 
                updateBalanceDisplay();
                showToast(`Day ${dateToSave} saved successfully. New balance: ${formatCurrency(currentBalance)}`, "success");
                dailyEntries = []; 
                renderEntriesTable();
                updateDashboardSummary(); 
            } catch (error) {
                console.error("Error saving day:", error);
                showToast(`Error saving day: ${error.message}`, "error");
            }
        };
        
        const handlePrintDay = () => {
            if (dailyEntries.length === 0 && (!reportContentDiv || !reportContentDiv.querySelector('div'))) { 
                 showToast("No data to print.", "warning");
                 return;
            }
            window.print();
        };


        // --- REPORT FUNCTIONS ---
        const clearReportContent = () => {
            if(reportContentDiv) reportContentDiv.innerHTML = '<p class="text-gray-500">Select date or month to view report.</p>';
            if(deleteReportButton) deleteReportButton.classList.add('hidden');
        };

        const viewDailyReport = async () => {
            if(!reportDateInput) return;
            const date = reportDateInput.value;
            if (!date) {
                showToast("Please select a date.", "warning");
                return;
            }
            if (!userId || !db) return;

            try {
                const summaryRef = doc(db, getDailySummariesCollectionPath(), date);
                const docSnap = await getDoc(summaryRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderReport(data, 'daily');
                    if(deleteReportButton){
                        deleteReportButton.classList.remove('hidden');
                        deleteReportButton.setAttribute('data-report-id', date);
                        deleteReportButton.setAttribute('data-report-type', 'daily');
                    }
                } else {
                    if(reportContentDiv) reportContentDiv.innerHTML = `<p class="text-red-500">No report found for ${date}.</p>`;
                    if(deleteReportButton) deleteReportButton.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching daily report:", error);
                showToast(`Error fetching report: ${error.message}`, "error");
                if(reportContentDiv) reportContentDiv.innerHTML = `<p class="text-red-500">Error fetching report.</p>`;
                if(deleteReportButton) deleteReportButton.classList.add('hidden');
            }
        };
        
        const viewMonthlyReport = async () => {
            if(!reportMonthInput) return;
            const monthYear = reportMonthInput.value; 
            if (!monthYear) {
                showToast("Please select a month.", "warning");
                return;
            }
            if (!userId || !db) return;

            try {
                const monthlySummaryRef = doc(db, getMonthlySummariesCollectionPath(), monthYear);
                const monthlySnap = await getDoc(monthlySummaryRef);

                if (monthlySnap.exists()) {
                     renderReport(monthlySnap.data(), 'monthlySummary');
                     if(deleteReportButton) {
                        deleteReportButton.classList.remove('hidden');
                        deleteReportButton.setAttribute('data-report-id', monthYear);
                        deleteReportButton.setAttribute('data-report-type', 'monthly');
                     }
                } else {
                    const q = query(collection(db, getDailySummariesCollectionPath()), where("monthYear", "==", monthYear));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        if(reportContentDiv) reportContentDiv.innerHTML = `<p class="text-red-500">No data found for ${monthYear}.</p>`;
                        if(deleteReportButton) deleteReportButton.classList.add('hidden');
                        return;
                    }

                    let aggregatedData = {
                        monthYear: monthYear,
                        totalGrossCommission: 0,
                        totalHeadOfficeDeduction: 0,
                        totalTaxableAmount: 0,
                        totalTaxDeduction: 0,
                        totalNetCommission: 0,
                        dailySummaries: []
                    };

                    querySnapshot.forEach(docSnap => {
                        const dailyData = docSnap.data();
                        aggregatedData.totalGrossCommission += dailyData.totalGrossCommission || 0;
                        aggregatedData.totalHeadOfficeDeduction += dailyData.headOfficeDeduction || 0;
                        aggregatedData.totalTaxableAmount += dailyData.taxableAmount || 0;
                        aggregatedData.totalTaxDeduction += dailyData.taxDeduction || 0;
                        aggregatedData.totalNetCommission += dailyData.netCommission || 0;
                        aggregatedData.dailySummaries.push(dailyData); 
                    });
                    aggregatedData.dailySummaries.sort((a,b) => new Date(a.date) - new Date(b.date));

                    renderReport(aggregatedData, 'monthlyAggregation');
                    if(deleteReportButton) deleteReportButton.classList.add('hidden'); 
                }

            } catch (error) {
                console.error("Error fetching monthly report:", error);
                showToast(`Error fetching monthly report: ${error.message}`, "error");
                if(reportContentDiv) reportContentDiv.innerHTML = `<p class="text-red-500">Error fetching monthly report.</p>`;
                if(deleteReportButton) deleteReportButton.classList.add('hidden');
            }
        };

        const renderReport = (data, type) => {
            if(!reportContentDiv) return;
            let html = `<div class="printable-area p-4 border rounded-md bg-white">`;
            html += `<div class="text-center mb-4 print-header">
                        <h2 class="text-2xl font-bold">${APP_NAME}</h2>
                        <p class="text-lg">${APP_SUBTITLE}</p>
                        <p class="text-md">Date: ${type === 'daily' ? formatDate(data.date) : (type === 'monthlySummary' || type === 'monthlyAggregation' ? data.monthYear : formatDate(new Date()))}</p>
                     </div>`;

            if (type === 'daily') {
                html += `<h3 class="text-xl font-semibold mb-2">Transactions for ${formatDate(data.date)}</h3>`;
                html += `<table class="w-full text-sm border-collapse border border-gray-300 report-table">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-2 py-1 border">#</th>
                                    <th class="px-2 py-1 border">Stock Name</th>
                                    <th class="px-2 py-1 border text-right">Qty</th>
                                    <th class="px-2 py-1 border text-right">Rate</th>
                                    <th class="px-2 py-1 border text-right">Comm/Stock</th>
                                    <th class="px-2 py-1 border text-right">Total Comm.</th>
                                </tr>
                            </thead>
                            <tbody>`;
                (data.transactions || []).forEach((item, index) => {
                    html += `<tr>
                                <td class="px-2 py-1 border">${index + 1}</td>
                                <td class="px-2 py-1 border">${item.stockName}</td>
                                <td class="px-2 py-1 border text-right">${item.quantity}</td>
                                <td class="px-2 py-1 border text-right">${formatCurrency(item.rate)}</td>
                                <td class="px-2 py-1 border text-right">${formatCurrency(item.commissionPerStock)}</td>
                                <td class="px-2 py-1 border text-right">${formatCurrency(item.totalCommission)}</td>
                             </tr>`;
                });
                html += `   </tbody>
                         </table>`;
                html += `<div class="mt-4 p-4 border rounded-md bg-gray-50 report-summary">
                            <h4 class="font-semibold text-lg mb-2">Daily Summary:</h4>
                            <div class="grid grid-cols-2 gap-x-4">
                                <p>Opening Balance:</p><p class="text-right font-medium">${formatCurrency(data.openingBalance || 0)}</p>
                                <p>Total Gross Commission:</p><p class="text-right font-medium">${formatCurrency(data.totalGrossCommission || 0)}</p>
                                <p>Head Office Deduction (40%):</p><p class="text-right font-medium">${formatCurrency(data.headOfficeDeduction || 0)}</p>
                                <p>Amount Before Tax:</p><p class="text-right font-medium">${formatCurrency(data.taxableAmount || 0)}</p>
                                <p>Tax Deduction (12% on Rem.):</p><p class="text-right font-medium">${formatCurrency(data.taxDeduction || 0)}</p>
                                <p class="font-bold">Net Commission for Day:</p><p class="text-right font-bold">${formatCurrency(data.netCommission || 0)}</p>
                                <p class="font-bold text-blue-600">Closing Balance:</p><p class="text-right font-bold text-blue-600">${formatCurrency(data.closingBalance || 0)}</p>
                            </div>
                         </div>`;
            } else if (type === 'monthlySummary' || type === 'monthlyAggregation') {
                html += `<h3 class="text-xl font-semibold mb-2">Summary for ${data.monthYear}</h3>`;
                 html += `<div class="mt-4 p-4 border rounded-md bg-gray-50 report-summary">
                            <div class="grid grid-cols-2 gap-x-4">
                                ${data.openingBalanceForMonth !== undefined ? `<p>Opening Balance for Month:</p><p class="text-right font-medium">${formatCurrency(data.openingBalanceForMonth)}</p>` : ''}
                                <p>Total Gross Commission:</p><p class="text-right font-medium">${formatCurrency(data.totalGrossCommission || 0)}</p>
                                <p>Total Head Office Deduction:</p><p class="text-right font-medium">${formatCurrency(data.totalHeadOfficeDeduction || 0)}</p>
                                <p>Total Taxable Amount:</p><p class="text-right font-medium">${formatCurrency(data.totalTaxableAmount || 0)}</p>
                                <p>Total Tax Deduction:</p><p class="text-right font-medium">${formatCurrency(data.totalTaxDeduction || 0)}</p>
                                <p class="font-bold">Total Net Commission for Month:</p><p class="text-right font-bold">${formatCurrency(data.totalNetCommission || 0)}</p>
                                ${data.totalPaymentsMade !== undefined ? `<p>Total Payments Made:</p><p class="text-right font-medium">${formatCurrency(data.totalPaymentsMade)}</p>` : ''}
                                ${data.closingBalanceForMonth !== undefined ? `<p class="font-bold text-blue-600">Closing Balance for Month:</p><p class="text-right font-bold text-blue-600">${formatCurrency(data.closingBalanceForMonth)}</p>` : ''}
                            </div>
                         </div>`;
                if (type === 'monthlyAggregation' && data.dailySummaries && data.dailySummaries.length > 0) {
                    html += `<h4 class="text-lg font-semibold mt-4 mb-2">Daily Breakdown:</h4>`;
                    data.dailySummaries.forEach(daily => {
                        html += `<div class="mb-3 p-2 border rounded">
                                    <strong>${formatDate(daily.date)}:</strong> Net Commission: ${formatCurrency(daily.netCommission || 0)} (Gross: ${formatCurrency(daily.totalGrossCommission || 0)})
                                 </div>`;
                    });
                }
            }
            html += `<div class="mt-6 text-xs text-gray-500 print-footer">${DEVELOPER_INFO}</div>`;
            html += `</div>`; 
            reportContentDiv.innerHTML = html;
        };

        const handleDeleteReport = () => {
            if(!deleteReportButton) return;
            const reportId = deleteReportButton.getAttribute('data-report-id');
            const reportType = deleteReportButton.getAttribute('data-report-type');

            if (!reportId || !reportType) {
                showToast("Cannot identify report to delete.", "error");
                return;
            }

            promptPassword(async () => {
                if (!userId || !db) return;
                showToast(`Deleting ${reportType} report: ${reportId}...`, "info");
                try {
                    if (reportType === 'daily') {
                        const summaryRef = doc(db, getDailySummariesCollectionPath(), reportId);
                        const summarySnap = await getDoc(summaryRef);
                        if (!summarySnap.exists()) {
                            showToast("Report already deleted or not found.", "warning");
                            clearReportContent();
                            return;
                        }
                        const deletedNetCommission = summarySnap.data().netCommission || 0;
                        
                        const batch = writeBatch(db);
                        batch.delete(summaryRef);
                        
                        const newOverallBalance = currentBalance - deletedNetCommission;
                        batch.update(doc(db, getAppStateDocPath()), { currentBalance: newOverallBalance });
                        
                        await batch.commit();

                        currentBalance = newOverallBalance;
                        updateBalanceDisplay();
                        showToast(`Daily report ${reportId} deleted. Balance updated.`, "success");
                        clearReportContent();

                    } else if (reportType === 'monthly') { 
                        const summaryRef = doc(db, getMonthlySummariesCollectionPath(), reportId);
                        await deleteDoc(summaryRef);
                        showToast(`Monthly summary ${reportId} deleted. Note: This does not delete individual daily records or adjust balance automatically. Recalculate if needed.`, "success");
                        clearReportContent();
                    }
                } catch (error) {
                    console.error(`Error deleting ${reportType} report:`, error);
                    showToast(`Error deleting report: ${error.message}`, "error");
                }
            });
        };

        // --- PAYMENT REQUESTS FUNCTIONS ---
        const loadPaymentRequests = async () => {
            if (!userId || !db || !prListDiv) return;
            prListDiv.innerHTML = '<p class="text-gray-500">Loading payment requests...</p>';
            try {
                const q = query(collection(db, getPaymentRequestsCollectionPath())); 
                const querySnapshot = await getDocs(q);
                const requests = [];
                querySnapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
                renderPaymentRequests(requests);
            } catch (error) {
                console.error("Error loading payment requests:", error);
                prListDiv.innerHTML = '<p class="text-red-500">Failed to load payment requests.</p>';
                showToast("Error loading payment requests.", "error");
            }
        };

        const renderPaymentRequests = (requests) => {
            if (!prListDiv) return;
            prListDiv.innerHTML = '';
            if (requests.length === 0) {
                prListDiv.innerHTML = '<p class="text-gray-500">No payment requests found.</p>';
                return;
            }
            const ul = document.createElement('ul');
            ul.className = 'space-y-3';
            requests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'p-3 border rounded-md bg-white shadow-sm';
                let statusColor = 'text-yellow-600';
                if (req.status === 'Approved') statusColor = 'text-blue-600';
                if (req.status === 'Paid') statusColor = 'text-green-600';

                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">Requested: ${formatCurrency(req.requestedAmount)} on ${formatDate(req.requestDate)}</p>
                            <p class="text-sm ${statusColor}">Status: ${req.status}</p>
                            ${req.approvedAmount ? `<p class="text-sm">Approved: ${formatCurrency(req.approvedAmount)} ${req.approvalDate ? `on ${formatDate(req.approvalDate)}` : ''}</p>` : ''}
                            ${req.paidAmount ? `<p class="text-sm">Paid: ${formatCurrency(req.paidAmount)} ${req.paymentDate ? `on ${formatDate(req.paymentDate)}` : ''}</p>` : ''}
                        </div>
                        <div class="space-x-2 print-hidden">
                            ${req.status === 'Pending' ? `<button data-id="${req.id}" class="approve-pr-btn px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">Approve</button>` : ''}
                            ${req.status === 'Approved' ? `<button data-id="${req.id}" data-approved="${req.approvedAmount}" class="markpaid-pr-btn px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">Mark Paid</button>` : ''}
                            <button data-id="${req.id}" class="delete-pr-btn px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `;
                ul.appendChild(li);
            });
            prListDiv.appendChild(ul);

            document.querySelectorAll('.approve-pr-btn').forEach(btn => btn.addEventListener('click', handleApprovePR));
            document.querySelectorAll('.markpaid-pr-btn').forEach(btn => btn.addEventListener('click', handleMarkPaidPR));
            document.querySelectorAll('.delete-pr-btn').forEach(btn => btn.addEventListener('click', handleDeletePR));
        };

        const handleAddPaymentRequest = async () => {
            if(!prDateInput || !prAmountInput) return;
            const requestDate = prDateInput.value;
            const requestedAmount = parseFloat(prAmountInput.value);

            if (!requestDate || isNaN(requestedAmount) || requestedAmount <= 0) {
                showToast("Please enter a valid date and requested amount.", "error");
                return;
            }
            if (!userId || !db) return;

            const newRequest = {
                requestDate,
                requestedAmount,
                status: 'Pending', 
                approvedAmount: null,
                approvalDate: null,
                paidAmount: null,
                paymentDate: null,
                createdAt: Timestamp.now()
            };

            try {
                await addDoc(collection(db, getPaymentRequestsCollectionPath()), newRequest);
                showToast("Payment request added successfully.", "success");
                prAmountInput.value = ''; 
                loadPaymentRequests(); 
            } catch (error) {
                console.error("Error adding payment request:", error);
                showToast(`Error adding payment request: ${error.message}`, "error");
            }
        };

        const handleApprovePR = (e) => {
            const prId = e.target.getAttribute('data-id');
            const approvalFormDiv = document.createElement('div');
            approvalFormDiv.innerHTML = `
                <label for="modalApprovedAmount" class="block text-sm font-medium text-gray-700">Approved Amount (PKR):</label>
                <input type="number" id="modalApprovedAmount" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p id="modalApprovalError" class="text-red-500 text-sm mt-1 hidden"></p>
            `;
            const actions = [{
                label: 'Approve Payment',
                className: 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600',
                callback: async () => {
                    const approvedAmountInputEl = document.getElementById('modalApprovedAmount');
                    const errorEl = document.getElementById('modalApprovalError');
                    if (!approvedAmountInputEl) return;

                    const approvedAmount = parseFloat(approvedAmountInputEl.value);
                    
                    if (isNaN(approvedAmount) || approvedAmount <= 0) {
                        if(errorEl) {
                            errorEl.textContent = 'Please enter a valid positive amount.';
                            errorEl.classList.remove('hidden');
                        }
                        // showToast('Invalid approved amount.', 'error'); // Toast is good, but modal should stay
                        return; // Prevent modal from closing by not calling hideModal implicitly
                    }
                    if(errorEl) errorEl.classList.add('hidden');

                    if (!userId || !db) return;
                    try {
                        const prRef = doc(db, getPaymentRequestsCollectionPath(), prId);
                        
                        const batch = writeBatch(db);
                        batch.update(prRef, {
                            approvedAmount: approvedAmount,
                            status: 'Approved',
                            approvalDate: formatDate(new Date())
                        });

                        const newOverallBalance = currentBalance - approvedAmount;
                        batch.update(doc(db, getAppStateDocPath()), { currentBalance: newOverallBalance });
                        
                        await batch.commit();

                        currentBalance = newOverallBalance;
                        updateBalanceDisplay();
                        showToast(`Payment request approved for ${formatCurrency(approvedAmount)}. Balance updated.`, "success");
                        loadPaymentRequests();
                        // hideModal() is called by showModal wrapper if this callback doesn't prevent it
                    } catch (error) {
                        console.error("Error approving payment request:", error);
                        showToast(`Error approving: ${error.message}`, "error");
                    }
                }
            }];
            showModal('Approve Payment Request', approvalFormDiv, actions);
        };
        
        const handleMarkPaidPR = async (e) => {
            const prId = e.target.getAttribute('data-id');
            const approvedAmount = parseFloat(e.target.getAttribute('data-approved')); 

            const paidFormDiv = document.createElement('div');
            paidFormDiv.innerHTML = `
                <p class="mb-2">Approved amount was ${formatCurrency(approvedAmount)}.</p>
                <label for="modalPaidAmount" class="block text-sm font-medium text-gray-700">Paid Amount (PKR):</label>
                <input type="number" id="modalPaidAmount" step="0.01" value="${approvedAmount.toFixed(2)}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p id="modalPaidError" class="text-red-500 text-sm mt-1 hidden"></p>
            `;
             const actions = [{
                label: 'Mark as Paid',
                className: 'px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600',
                callback: async () => {
                    const paidAmountInputEl = document.getElementById('modalPaidAmount');
                    const errorEl = document.getElementById('modalPaidError');
                    if(!paidAmountInputEl) return;

                    const paidAmount = parseFloat(paidAmountInputEl.value);

                    if (isNaN(paidAmount) || paidAmount <= 0) {
                         if(errorEl) {
                            errorEl.textContent = 'Please enter a valid positive paid amount.';
                            errorEl.classList.remove('hidden');
                        }
                        return; 
                    }
                     if(errorEl) errorEl.classList.add('hidden');

                    if (!userId || !db) return;
                    try {
                        const prRef = doc(db, getPaymentRequestsCollectionPath(), prId);
                        await updateDoc(prRef, {
                            paidAmount: paidAmount,
                            status: 'Paid',
                            paymentDate: formatDate(new Date())
                        });
                        showToast("Payment request marked as Paid.", "success");
                        loadPaymentRequests();
                    } catch (error) {
                        console.error("Error marking as paid:", error);
                        showToast(`Error: ${error.message}`, "error");
                    }
                }
            }];
            showModal('Mark Payment as Paid', paidFormDiv, actions);
        };

        const handleDeletePR = (e) => {
            const prId = e.target.getAttribute('data-id');
            showModal(
                'Confirm Deletion',
                'Are you sure you want to delete this payment request? This action cannot be undone. If it was an approved request, the balance will NOT be automatically readjusted.',
                [{
                    label: 'Delete',
                    className: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700',
                    callback: async () => {
                         if (!userId || !db) return;
                        try {
                            const prRef = doc(db, getPaymentRequestsCollectionPath(), prId);
                            const prSnap = await getDoc(prRef);
                            if (prSnap.exists() && prSnap.data().status === 'Approved' && (prSnap.data().approvedAmount || 0) > 0) {
                                showToast("Warning: Deleting an approved request. Balance was already deducted. Manual adjustment might be needed if this is an error.", "warning");
                            }
                            await deleteDoc(prRef);
                            showToast("Payment request deleted.", "success");
                            loadPaymentRequests();
                        } catch (error) {
                            console.error("Error deleting payment request:", error);
                            showToast(`Error deleting: ${error.message}`, "error");
                        }
                    }
                }]
            );
        };

        // --- MONTH CLOSURE FUNCTIONS ---
        const clearMonthClosureReport = () => {
            if(mcReportDiv) mcReportDiv.innerHTML = '<p class="text-gray-500">Select month to generate summary.</p>';
        };
        
        const handleCloseMonth = async () => {
            if(!mcMonthInput) return;
            const monthYearToClose = mcMonthInput.value; 
            if (!monthYearToClose) {
                showToast("Please select a month to close.", "warning");
                return;
            }
            if (!userId || !db) return;

            showModal(
                'Confirm Month Closure',
                `Are you sure you want to close month ${monthYearToClose}? This will generate a summary. This action doesn't prevent further entries for this month but marks a point-in-time summary.`,
                [{
                    label: 'Close Month',
                    className: 'px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700',
                    callback: async () => {
                        if(!mcReportDiv) return;
                        mcReportDiv.innerHTML = `<p class="text-gray-500">Generating summary for ${monthYearToClose}...</p>`;
                        try {
                            const dailyQuery = query(collection(db, getDailySummariesCollectionPath()), where("monthYear", "==", monthYearToClose));
                            const dailySnapshots = await getDocs(dailyQuery);

                            if (dailySnapshots.empty) {
                                mcReportDiv.innerHTML = `<p class="text-red-500">No daily data found for ${monthYearToClose} to generate a summary.</p>`;
                                showToast(`No data for ${monthYearToClose}.`, "warning");
                                return;
                            }

                            let monthlySummaryData = {
                                monthYear: monthYearToClose,
                                totalGrossCommission: 0,
                                totalHeadOfficeDeduction: 0,
                                totalTaxableAmount: 0,
                                totalTaxDeduction: 0,
                                totalNetCommission: 0,
                                totalPaymentsMade: 0, 
                                dailySummaryCount: dailySnapshots.size,
                                closedAt: Timestamp.now(),
                                openingBalanceForMonth: 0, // Will be calculated
                                closingBalanceForMonth: 0 // Will be calculated
                            };

                            dailySnapshots.forEach(docSnap => {
                                const dailyData = docSnap.data();
                                monthlySummaryData.totalGrossCommission += dailyData.totalGrossCommission || 0;
                                monthlySummaryData.totalHeadOfficeDeduction += dailyData.headOfficeDeduction || 0;
                                monthlySummaryData.totalTaxableAmount += dailyData.taxableAmount || 0;
                                monthlySummaryData.totalTaxDeduction += dailyData.taxDeduction || 0;
                                monthlySummaryData.totalNetCommission += dailyData.netCommission || 0;
                            });

                            const paymentsQuery = query(collection(db, getPaymentRequestsCollectionPath()), 
                                where("status", "in", ["Approved", "Paid"])
                            );
                            const paymentSnapshots = await getDocs(paymentsQuery);
                            paymentSnapshots.forEach(docSnap => {
                                const prData = docSnap.data();
                                const prApprovalMonthYear = prData.approvalDate ? getMonthYear(prData.approvalDate) : null;
                                if (prApprovalMonthYear === monthYearToClose && (prData.approvedAmount || 0) > 0) {
                                    monthlySummaryData.totalPaymentsMade += prData.approvedAmount;
                                }
                            });
                            
                            const prevMonth = getPreviousMonthYear(monthYearToClose);
                            let calculatedOpeningBalance = 0;
                            if (prevMonth) {
                                const prevMonthSummarySnap = await getDoc(doc(db, getMonthlySummariesCollectionPath(), prevMonth));
                                if (prevMonthSummarySnap.exists()) {
                                    calculatedOpeningBalance = prevMonthSummarySnap.data().closingBalanceForMonth || 0;
                                }
                            } else {
                                // For the very first month, try to derive from appState if it was the absolute beginning
                                // This is an approximation. A more robust system might require explicit opening balance entry for the first month.
                                const appStateSnap = await getDoc(doc(db, getAppStateDocPath()));
                                if (appStateSnap.exists() && !appStateSnap.data().lastMonthClosed) { // if no month ever closed
                                     // Opening balance for the very first month is current balance minus this month's earnings plus this month's payments
                                     calculatedOpeningBalance = currentBalance - monthlySummaryData.totalNetCommission + monthlySummaryData.totalPaymentsMade;
                                }
                            }
                            monthlySummaryData.openingBalanceForMonth = calculatedOpeningBalance;
                            monthlySummaryData.closingBalanceForMonth = calculatedOpeningBalance + monthlySummaryData.totalNetCommission - monthlySummaryData.totalPaymentsMade;

                            await setDoc(doc(db, getMonthlySummariesCollectionPath(), monthYearToClose), monthlySummaryData);
                            await updateAppState({ lastMonthClosed: monthYearToClose });

                            mcReportDiv.innerHTML = `
                                <h4 class="text-lg font-semibold">Month Closure Summary for ${monthYearToClose}</h4>
                                <p>Total Daily Records Processed: ${monthlySummaryData.dailySummaryCount}</p>
                                <p>Total Gross Commission: ${formatCurrency(monthlySummaryData.totalGrossCommission)}</p>
                                <p>Total Net Commission: ${formatCurrency(monthlySummaryData.totalNetCommission)}</p>
                                <p>Total Payments (Approved this month): ${formatCurrency(monthlySummaryData.totalPaymentsMade)}</p>
                                <p>Calculated Opening Balance for Month: ${formatCurrency(monthlySummaryData.openingBalanceForMonth)}</p>
                                <p>Calculated Closing Balance for Month: ${formatCurrency(monthlySummaryData.closingBalanceForMonth)}</p>
                                <p class="mt-2 text-green-600">Month ${monthYearToClose} summary generated and saved.</p>
                            `;
                            showToast(`Month ${monthYearToClose} closed successfully.`, "success");

                        } catch (error) {
                            console.error("Error during month closure:", error);
                            mcReportDiv.innerHTML = `<p class="text-red-500">Error closing month: ${error.message}</p>`;
                            showToast(`Error closing month: ${error.message}`, "error");
                        }
                    }
                }]
            );
        };
        
        const getPreviousMonthYear = (monthYear) => { 
            const [year, month] = monthYear.split('-').map(Number);
            let prevYear = year;
            let prevMonth = month - 1;
            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear--;
            }
            if (prevYear < 1900) return null; 
            return `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
        };

        // --- LOGIN & LOGOUT ---
        const handleLogin = async (event) => {
            event.preventDefault();
            if(!usernameInput || !passwordInput) return;

            const username = usernameInput.value;
            const pass = passwordInput.value;

            if (username === LOGIN_USERNAME && pass === LOGIN_PASSWORD) {
                if(loginError) loginError.classList.add('hidden');
                
                const firebaseReady = await initializeFirebase();
                if (firebaseReady && userId) { 
                    if(loginSection) loginSection.classList.add('hidden');
                    if(appSection) appSection.classList.remove('hidden');
                    
                    switchView('dashboard'); 

                    if(mainHeaderTitleEl) mainHeaderTitleEl.textContent = APP_NAME;
                    // The problematic line for 'mainHeaderSubtitle' is removed.
                    // switchView handles setting the subtitle on currentViewTitle.
                    if(footerDevInfoP) footerDevInfoP.textContent = DEVELOPER_INFO;

                } else {
                    if (loginError) { 
                        if (!loginError.textContent || loginError.textContent.trim() === "") { // Check if already has a message from firebase init
                            loginError.textContent = "Authentication with services failed. Please check your connection or configuration.";
                        }
                        loginError.classList.remove('hidden');
                    } else {
                        console.error("loginError element not found, but an auth error occurred.");
                    }
                }
            } else {
                if (loginError) { 
                    loginError.textContent = "Invalid username or password.";
                    loginError.classList.remove('hidden');
                } else {
                    console.error("loginError element not found, but an invalid login attempt occurred.");
                }
            }
        };

        const handleLogout = () => {
            showModal(
                'Confirm Logout',
                'Are you sure you want to logout? Any unsaved data on the current screen might be lost.',
                [{
                    label: 'Logout',
                    className: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700',
                    callback: () => {
                        if(appSection) appSection.classList.add('hidden');
                        if(loginSection) loginSection.classList.remove('hidden');
                        currentView = 'login';
                        if(usernameInput) usernameInput.value = '';
                        if(passwordInput) passwordInput.value = '';
                        if(loginError) loginError.classList.add('hidden');
                    }
                }]
            );
        };
        
        // --- SVG ICONS ---
        const eyeIconSVG = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
        const eyeSlashIconSVG = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>`;


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements
            loginSection = document.getElementById('loginSection');
            appSection = document.getElementById('appSection');
            mainContent = document.getElementById('mainContent');
            sidebar = document.getElementById('sidebar');
            usernameInput = document.getElementById('username');
            passwordInput = document.getElementById('password');
            loginError = document.getElementById('loginError');
            
            currentViewTitle = document.getElementById('currentViewTitle');
            currentDateDisplay = document.getElementById('currentDateDisplay');
            mainHeaderTitleEl = document.getElementById('mainHeaderTitle');
            footerDevInfoP = document.getElementById('footerDevInfo');  
            loginDevInfoP = document.getElementById('loginDevInfo');    

            if(loginDevInfoP) loginDevInfoP.textContent = DEVELOPER_INFO;


            // Dashboard elements
            stockNameInput = document.getElementById('stockName');
            quantityInput = document.getElementById('quantity');
            rateInput = document.getElementById('rate');
            addEntryButton = document.getElementById('addEntryButton');
            entriesTableBody = document.getElementById('entriesTableBody');
            dailySummaryDiv = document.getElementById('dailySummaryDiv');
            dashboardDateInput = document.getElementById('dashboardDateInput');
            totalGrossCommissionEl = document.getElementById('totalGrossCommission');
            headOfficeDeductionEl = document.getElementById('headOfficeDeduction');
            taxableAmountEl = document.getElementById('taxableAmount');
            taxDeductionEl = document.getElementById('taxDeduction');
            netCommissionEl = document.getElementById('netCommission');
            previousBalanceEl = document.getElementById('previousBalance');
            currentDayNetCommissionEl = document.getElementById('currentDayNetCommission');
            newBalanceEl = document.getElementById('newBalance');
            saveDayButton = document.getElementById('saveDayButton');
            printDayButton = document.getElementById('printDayButton'); 
            balanceDisplayEl = document.getElementById('balanceDisplay');
            toggleBalanceButton = document.getElementById('toggleBalanceButton');
            
            // Report elements
            reportDateInput = document.getElementById('reportDateInput');
            reportMonthInput = document.getElementById('reportMonthInput');
            viewDateReportButton = document.getElementById('viewDateReportButton');
            viewMonthReportButton = document.getElementById('viewMonthReportButton');
            reportContentDiv = document.getElementById('reportContentDiv');
            deleteReportButton = document.getElementById('deleteReportButton');

            // Payment elements
            prDateInput = document.getElementById('prDateInput');
            prAmountInput = document.getElementById('prAmountInput');
            prAddButton = document.getElementById('prAddButton');
            prListDiv = document.getElementById('prListDiv');
            
            // Month Closure elements
            mcMonthInput = document.getElementById('mcMonthInput');
            mcCloseMonthButton = document.getElementById('mcCloseMonthButton');
            mcReportDiv = document.getElementById('mcReportDiv');

            // Modal elements
            modal = document.getElementById('appModal');
            modalCloseButton = document.getElementById('modalCloseButton');
            modalTitle = document.getElementById('modalTitle');
            modalBody = document.getElementById('modalBody');
            modalActions = document.getElementById('modalActions');


            // Event Listeners
            const loginForm = document.getElementById('loginForm');
            if(loginForm) loginForm.addEventListener('submit', handleLogin);
            
            const logoutBtn = document.getElementById('logoutButton');
            if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            if(sidebar) {
                sidebar.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const viewName = link.getAttribute('data-view');
                        if (viewName) switchView(viewName);
                    });
                });
            }

            if (addEntryButton) addEntryButton.addEventListener('click', handleAddEntry);
            if (saveDayButton) saveDayButton.addEventListener('click', handleSaveDay);
            
            const reportPrintButton = document.getElementById('reportPrintButton');
            if (reportPrintButton) reportPrintButton.addEventListener('click', handlePrintDay); 
            if (printDayButton) printDayButton.addEventListener('click', handlePrintDay); 

            if (dashboardDateInput) {
                dashboardDateInput.value = selectedDate; 
                dashboardDateInput.addEventListener('change', (e) => {
                    selectedDate = e.target.value;
                    loadDashboardData(); 
                });
            }
            if (toggleBalanceButton) {
                toggleBalanceButton.innerHTML = balanceVisible ? eyeIconSVG() : eyeSlashIconSVG();
                toggleBalanceButton.addEventListener('click', toggleBalanceVisibility);
            }
            
            if (viewDateReportButton) viewDateReportButton.addEventListener('click', viewDailyReport);
            if (viewMonthReportButton) viewMonthReportButton.addEventListener('click', viewMonthlyReport);
            if (deleteReportButton) deleteReportButton.addEventListener('click', handleDeleteReport);

            if (prAddButton) prAddButton.addEventListener('click', handleAddPaymentRequest);
            if (prDateInput) prDateInput.value = formatDate(new Date()); 

            if (mcCloseMonthButton) mcCloseMonthButton.addEventListener('click', handleCloseMonth);
            if (mcMonthInput) mcMonthInput.value = getMonthYear(new Date()); 

            if(modalCloseButton) modalCloseButton.addEventListener('click', hideModal);
            
            // Set initial UI state
            if(loginSection) loginSection.classList.remove('hidden');
            if(appSection) appSection.classList.add('hidden');
            if(modal) modal.classList.add('hidden'); 
            const toastNotification = document.getElementById('toastNotification');
            if(toastNotification) toastNotification.classList.add('hidden','opacity-0');
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link { @apply block py-2.5 px-4 rounded transition duration-200; }
        .sidebar-link:hover { @apply bg-gray-700 text-white; }
        .sidebar-link.active { @apply bg-gray-900 text-white; } /* Note: Tailwind might prefer bg-gray-700 for active if sidebar is bg-gray-800 */
        
        /* Print specific styles */
        @media print {
            body {
                font-size: 10pt;
                margin: 0;
                padding: 0;
                background-color: white !important; /* Ensure white background for printing */
                -webkit-print-color-adjust: exact; /* Chrome, Safari */
                print-color-adjust: exact; /* Firefox, Edge */
            }
            #loginSection, #sidebar, #appHeader, .print-hidden, #toastNotification, #appModal {
                display: none !important;
            }
            #appSection, #mainContent, #mainContent > div[data-view] {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                background-color: white !important;
            }
            .printable-area, .print-this-section { 
                display: block !important;
                width: 100% !important;
                margin: 0 auto;
                padding: 5mm 10mm; /* Reduced padding for print */
                border: none !important;
                box-shadow: none !important;
                page-break-inside: avoid;
                background-color: white !important;
            }
             #view-dashboard.print-this-section { /* Specific for dashboard */
                padding: 5mm; /* Minimal padding for dashboard print */
            }
            .print-header, .print-footer {
                display: block !important; 
            }
            .report-table-container {
                max-height: none !important; /* Allow table to expand */
                overflow: visible !important;
            }
            .report-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt; /* Slightly smaller font for tables in print */
            }
            .report-table th, .report-table td {
                border: 1px solid #ccc !important;
                padding: 3px;
                text-align: left;
            }
            .report-table th { 
                background-color: #f0f0f0 !important; 
                -webkit-print-color-adjust: exact; print-color-adjust: exact; 
            }
            .report-summary { 
                background-color: #f9f9f9 !important; 
                -webkit-print-color-adjust: exact; print-color-adjust: exact; 
                margin-top: 10px; /* Add some space before summary */
                padding: 10px;
            }
            .report-summary .grid {
                font-size: 9pt;
            }


            @page {
                size: A4; 
                margin: 10mm; 
            }
            
            #view-dashboard .lg\:col-span-1, #view-dashboard .lg\:col-span-2 { /* Reset columns for print */
                grid-column: span 3 / span 3 !important; 
            }
            #view-dashboard .lg\:grid-cols-3 {
                 display: block !important; /* Stack elements for print */
            }
            #view-dashboard .bg-white.p-6.rounded-lg.shadow { /* Entry form and entries list container */
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                margin-bottom: 10px; /* Space between stacked sections */
            }
             #view-dashboard h3 { /* Reduce heading sizes for print */
                font-size: 14pt;
                margin-bottom: 5px;
            }
            #dailySummaryDiv h4 {
                font-size: 12pt;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <section id="loginSection" class="min-h-screen flex items-center justify-center bg-gray-200">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Darson Securities Limited</h1>
                <p class="text-gray-600">Brokerage Commission Software</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" value="DARSON" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" value="AFRASIAB" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-150">Login</button>
            </form>
            <p class="text-center text-xs text-gray-500 mt-8" id="loginDevInfo"></p>
        </div>
    </section>

    <section id="appSection" class="hidden h-screen flex">
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 space-y-2 print-hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center">DSL</h2>
            <nav>
                <a href="#" data-view="dashboard" class="sidebar-link active">Dashboard</a>
                <a href="#" data-view="dailyReports" class="sidebar-link">Daily Reports</a>
                <a href="#" data-view="monthlyReports" class="sidebar-link">Monthly Reports</a>
                <a href="#" data-view="paymentRequests" class="sidebar-link">Payment Requests</a>
                <a href="#" data-view="monthClosure" class="sidebar-link">Month Closure</a>
            </nav>
            <div class="absolute bottom-4 left-4 right-4">
                <button id="logoutButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Logout</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header id="appHeader" class="bg-white shadow-md p-4 print-hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 id="mainHeaderTitle" class="text-2xl font-bold text-gray-800"></h1>
                        <p id="currentViewTitle" class="text-gray-600"></p>
                    </div>
                    <div class="text-right">
                        <p id="currentDateDisplay" class="text-lg text-gray-700"></p>
                        <div class="flex items-center justify-end mt-1">
                            <span id="balanceDisplay" class="text-indigo-600 font-semibold mr-2">PKR ******</span>
                            <button id="toggleBalanceButton" class="text-gray-500 hover:text-gray-700"></button>
                        </div>
                    </div>
                </div>
            </header>

            <div id="mainContent" class="flex-1 p-6 overflow-y-auto bg-gray-50">
                <div id="view-dashboard" data-view="dashboard" class="print-this-section">
                     <div class="print-header text-center mb-4 hidden"> <h2 class="text-2xl font-bold">${APP_NAME}</h2>
                        <p class="text-lg">${APP_SUBTITLE}</p>
                        <p class="text-md dashboard-print-date">Date: </p> </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow print-hidden"> <h3 class="text-xl font-semibold mb-4">Add Stock Entry</h3>
                            <div class="mb-4">
                                <label for="dashboardDateInput" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="dashboardDateInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="mb-3">
                                <label for="stockName" class="block text-sm font-medium text-gray-700">Stock Name</label>
                                <input type="text" id="stockName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="number" id="quantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="mb-4">
                                <label for="rate" class="block text-sm font-medium text-gray-700">Rate (PKR)</label>
                                <input type="number" step="0.01" id="rate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <button id="addEntryButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">Add Entry</button>
                        </div>

                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Today's Entries</h3>
                            <div class="overflow-x-auto mb-4 max-h-96 report-table-container">
                                <table class="w-full text-sm text-left text-gray-500 border-collapse border border-gray-300 report-table">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                        <tr>
                                            <th scope="col" class="px-4 py-2 border">#</th>
                                            <th scope="col" class="px-4 py-2 border">Stock</th>
                                            <th scope="col" class="px-4 py-2 border text-right">Qty</th>
                                            <th scope="col" class="px-4 py-2 border text-right">Rate</th>
                                            <th scope="col" class="px-4 py-2 border text-right">Comm/Share</th>
                                            <th scope="col" class="px-4 py-2 border text-right">Total Comm.</th>
                                            <th scope="col" class="px-4 py-2 border print-hidden">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entriesTableBody">
                                        <tr><td colspan="7" class="text-center py-4">No entries added yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="dailySummaryDiv" class="mt-6 p-4 border border-gray-200 rounded-md bg-gray-50 report-summary">
                                <h4 class="font-semibold text-lg mb-3">Daily Commission Summary</h4>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span class="text-gray-600">Total Gross Commission:</span> <span id="totalGrossCommission" class="font-medium">PKR 0.00</span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">Head Office (40%):</span> <span id="headOfficeDeduction" class="font-medium text-red-500">PKR 0.00</span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">Amount Before Tax:</span> <span id="taxableAmount" class="font-medium">PKR 0.00</span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">Tax (12% on Rem.):</span> <span id="taxDeduction" class="font-medium text-red-500">PKR 0.00</span></div>
                                    <hr class="my-2">
                                    <div class="flex justify-between text-base"><span class="font-semibold">Net Commission for Day:</span> <span id="netCommission" class="font-bold text-green-600">PKR 0.00</span></div>
                                    <hr class="my-2">
                                    <div class="flex justify-between print-hidden"><span class="text-gray-600">Previous Balance:</span> <span id="previousBalance" class="font-medium">PKR 0.00</span></div>
                                    <div class="flex justify-between print-hidden"><span class="text-gray-600">Today's Net Commission:</span> <span id="currentDayNetCommission" class="font-medium text-green-500">PKR 0.00</span></div>
                                    <div class="flex justify-between text-lg print-hidden"><span class="font-semibold text-blue-600">New Estimated Balance:</span> <span id="newBalance" class="font-bold text-blue-700">PKR 0.00</span></div>
                                </div>
                            </div>
                            <div class="mt-6 flex space-x-3 print-hidden">
                                <button id="saveDayButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">Save Day</button>
                                <button id="printDayButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">Print View</button>
                            </div>
                        </div>
                    </div>
                     <div class="mt-8 text-xs text-gray-500 print-footer hidden">${DEVELOPER_INFO}</div> </div>

                <div id="view-dailyReports" data-view="dailyReports" class="hidden">
                    <h3 class="text-xl font-semibold mb-4">Daily Reports</h3>
                    <div class="bg-white p-6 rounded-lg shadow mb-6 print-hidden">
                        <div class="flex flex-wrap items-end gap-4">
                            <div>
                                <label for="reportDateInput" class="block text-sm font-medium text-gray-700">Select Date</label>
                                <input type="date" id="reportDateInput" class="mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <button id="viewDateReportButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md">View Daily Report</button>
                        </div>
                    </div>
                    <div id="reportActionsTop" class="my-4 flex justify-end space-x-2 print-hidden">
                         <button id="reportPrintButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">Print Report</button>
                         <button id="deleteReportButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md hidden">Delete Report</button>
                    </div>
                    <div id="reportContentDiv" class="bg-white p-2 md:p-6 rounded-lg shadow"> <p class="text-gray-500">Select date to view report.</p>
                    </div>
                </div>
                <div id="view-monthlyReports" data-view="monthlyReports" class="hidden">
                     <h3 class="text-xl font-semibold mb-4">Monthly Reports</h3>
                     <div class="bg-white p-6 rounded-lg shadow mb-6 print-hidden">
                        <div class="flex flex-wrap items-end gap-4">
                            <div>
                                <label for="reportMonthInput" class="block text-sm font-medium text-gray-700">Select Month</label>
                                <input type="month" id="reportMonthInput" class="mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <button id="viewMonthReportButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">View Monthly Report</button>
                        </div>
                    </div>
                    </div>


                <div id="view-paymentRequests" data-view="paymentRequests" class="hidden">
                    <h3 class="text-xl font-semibold mb-4">Payment Requests</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white p-6 rounded-lg shadow">
                            <h4 class="text-lg font-medium mb-3">New Payment Request</h4>
                            <div class="mb-3">
                                <label for="prDateInput" class="block text-sm font-medium text-gray-700">Request Date</label>
                                <input type="date" id="prDateInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="mb-4">
                                <label for="prAmountInput" class="block text-sm font-medium text-gray-700">Requested Amount (PKR)</label>
                                <input type="number" step="0.01" id="prAmountInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <button id="prAddButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">Add Request</button>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow">
                            <h4 class="text-lg font-medium mb-3">Existing Requests</h4>
                            <div id="prListDiv" class="max-h-[60vh] overflow-y-auto">
                                <p class="text-gray-500">Loading payment requests...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-monthClosure" data-view="monthClosure" class="hidden">
                    <h3 class="text-xl font-semibold mb-4">Month Closure</h3>
                     <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="flex flex-wrap items-end gap-4">
                            <div>
                                <label for="mcMonthInput" class="block text-sm font-medium text-gray-700">Select Month to Close</label>
                                <input type="month" id="mcMonthInput" class="mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button id="mcCloseMonthButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">Generate & Close Month Summary</button>
                        </div>
                    </div>
                    <div id="mcReportDiv" class="bg-white p-6 rounded-lg shadow"> <p class="text-gray-500">Select month to generate summary.</p>
                    </div>
                </div>
            </div>
            
            <footer class="bg-white border-t p-4 text-center text-sm text-gray-600 print-hidden">
                <p id="footerDevInfo"></p>
            </footer>
        </main>
    </section>

    <div id="appModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center print-hidden hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900">Modal Title</h3>
                <div id="modalBody" class="mt-2 px-7 py-3 text-sm text-gray-500">
                    </div>
                <div id="modalActions" class="items-center px-4 py-3 space-x-2">
                    </div>
                 <button id="modalCloseButton" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="fixed bottom-5 right-5 px-4 py-3 rounded-md text-white shadow-lg transition-opacity duration-300 ease-in-out hidden z-50 print-hidden">
        <p id="toastMessage">Toast message!</p>
    </div>

</body>
</html>
