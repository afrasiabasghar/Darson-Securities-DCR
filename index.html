<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darson Securities Limited - Commission Software</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Mode Defaults */
            --bg-color: #f4f4f4;
            --sidebar-bg: #2c3e50;
            --sidebar-text: white;
            --sidebar-hover-bg: #34495e;
            --main-content-bg: #fff;
            --header-text: #2c3e50;
            --subheader-text: #7f8c8d;
            --date-text: #555;
            --border-color: #eee;
            --table-header-bg: #f2f2f2;
            --table-header-text: #333;
            --table-border: #ddd;
            --summary-bg: #f9f9f9;
            --summary-border: #e0e0e0;
            --summary-strong-text: #333;
            --summary-span-text: #007bff;
            --balance-text: #e67e22;
            --input-border: #ccc;
            --button-primary-bg: #007bff;
            --button-primary-hover-bg: #0056b3;
            --button-danger-bg: #dc3545;
            --button-danger-hover-bg: #c82333;
            --button-info-bg: #17a2b8;
            --button-info-hover-bg: #138496;
            --button-secondary-bg: #6c757d;
            --button-secondary-hover-bg: #5a6268;
            --developer-info-text: #bdc3c7;
            --developer-info-link: #ecf0f1;
            --section-header-text: #333;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-color: #1a1a2e;
            --sidebar-bg: #16213e;
            --sidebar-text: #e0e0e0;
            --sidebar-hover-bg: #0f3460;
            --main-content-bg: #0f3460;
            --header-text: #e94560;
            --subheader-text: #c0c0c0;
            --date-text: #a0a0a0;
            --border-color: #2e2e4a;
            --table-header-bg: #22223b;
            --table-header-text: #e0e0e0;
            --table-border: #3b3b5c;
            --summary-bg: #22223b;
            --summary-border: #3b3b5c;
            --summary-strong-text: #e0e0e0;
            --summary-span-text: #53a9ff;
            --balance-text: #ffc107;
            --input-border: #5c5c7c;
            --button-primary-bg: #53a9ff;
            --button-primary-hover-bg: #3a8ee0;
            --button-danger-bg: #e94560;
            --button-danger-hover-bg: #d43a50;
            --button-info-bg: #6c757d; /* Keep some neutral for info */
            --button-info-hover-bg: #5a6268;
            --button-secondary-bg: #3b3b5c;
            --button-secondary-hover-bg: #2e2e4a;
            --developer-info-text: #8888aa;
            --developer-info-link: #a0a0a0;
            --section-header-text: #e0e0e0;
        }

        /* General Styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }
        #sidebar {
            width: 220px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--sidebar-text);
        }
        #sidebar ul {
            list-style: none;
            padding: 0;
        }
        #sidebar ul li {
            margin-bottom: 10px;
        }
        #sidebar ul li a {
            display: block;
            padding: 12px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #sidebar ul li a:hover, #sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
        }
        #main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--main-content-bg);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 20px;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        header h1 {
            color: var(--header-text);
            margin: 0;
            font-size: 2em;
        }
        header h2 {
            color: var(--subheader-text);
            margin-top: 5px;
            font-size: 1.2em;
        }
        .date-display {
            text-align: right;
            font-weight: bold;
            color: var(--date-text);
            margin-bottom: 20px;
        }

        /* Dashboard Specific Styling */
        #dashboard-section {
            display: block; /* Default view */
        }
        .dashboard-date-selection {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .dashboard-date-selection label {
            font-weight: bold;
            color: var(--section-header-text);
        }
        .dashboard-date-selection input[type="date"] {
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--main-content-bg);
            color: var(--section-header-text);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        .form-row input[type="text"],
        .form-row input[type="number"] {
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            flex: 1;
            min-width: 0; /* Allow shrinking */
            background-color: var(--main-content-bg);
            color: var(--section-header-text);
        }
        .form-row button {
            padding: 10px 20px;
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .form-row button:hover {
            background-color: var(--button-primary-hover-bg);
        }
        #transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: var(--section-header-text);
        }
        #transactions-table th,
        #transactions-table td {
            border: 1px solid var(--table-border);
            padding: 8px;
            text-align: left;
        }
        #transactions-table th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
        }
        .summary-section {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid var(--summary-border);
            border-radius: 5px;
            background-color: var(--summary-bg);
            color: var(--section-header-text);
        }
        .summary-section div {
            margin-bottom: 8px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
        }
        .summary-section div strong {
            color: var(--summary-strong-text);
        }
        .summary-section div span {
            color: var(--summary-span-text);
            font-weight: bold;
        }
        .balance-info {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--balance-text);
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* To push toggle to the right */
        }
        .balance-amount {
            display: inline-block; /* For hiding/showing */
        }
        .balance-toggle-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--balance-text);
            margin-left: 10px;
        }
        .balance-toggle-btn:hover {
            color: var(--balance-text); /* Keep same color on hover for toggle */
        }

        .dashboard-buttons {
            margin-top: 20px;
            text-align: center;
            display: flex; /* Use flex for button alignment */
            justify-content: center; /* Center buttons horizontally */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            gap: 10px; /* Space between buttons */
        }
        .dashboard-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #saveDayBtn {
            background-color: var(--button-primary-bg);
            color: white;
        }
        #saveDayBtn:hover {
            background-color: var(--button-primary-hover-bg);
        }
        #clearEntriesBtn {
            background-color: var(--button-danger-bg);
            color: white;
        }
        #clearEntriesBtn:hover {
            background-color: var(--button-danger-hover-bg);
        }
        #requestPaymentBtn {
            background-color: var(--button-secondary-bg);
            color: white;
        }
        #requestPaymentBtn:hover {
            background-color: var(--button-secondary-hover-bg);
        }
        #printDailyBtn { /* New button style */
            background-color: var(--button-info-bg);
            color: white;
        }
        #printDailyBtn:hover {
            background-color: var(--button-info-hover-bg);
        }

        /* Reports Section Styling */
        #reports-section, #payment-history-section, #month-closure-section, #settings-section {
            display: none; /* Hidden by default */
            padding: 20px;
            color: var(--section-header-text);
        }
        .report-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .report-controls input[type="date"],
        .report-controls select,
        .report-controls input[type="number"] { /* Added number input for year */
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            flex: 1;
            min-width: 0;
            background-color: var(--main-content-bg);
            color: var(--section-header-text);
        }
        .report-controls button {
            padding: 10px 20px;
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .report-controls button:hover {
            background-color: var(--button-primary-hover-bg);
        }
        #report-display {
            border: 1px solid var(--table-border);
            padding: 15px;
            margin-top: 20px;
            background-color: var(--main-content-bg);
            max-height: 600px;
            overflow-y: auto;
        }
        #report-display h3 {
            text-align: center;
            color: var(--section-header-text);
            margin-bottom: 15px;
        }
        #report-display table {
            width: 100%;
            border-collapse: collapse;
            color: var(--section-header-text);
        }
        #report-display th, #report-display td {
            border: 1px solid var(--table-border);
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        #report-display th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
        }
        .report-summary {
            margin-top: 20px;
            font-weight: bold;
            text-align: right;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }
        .report-summary span {
            color: var(--summary-span-text);
        }
        .delete-report-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .delete-report-section input[type="password"] {
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            margin-right: 10px;
            width: 200px;
            background-color: var(--main-content-bg);
            color: var(--section-header-text);
        }
        .delete-report-section button {
            background-color: var(--button-danger-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .delete-report-section button:hover {
            background-color: var(--button-danger-hover-bg);
        }

        /* Payment History Styling */
        #payment-history-section h3 {
            margin-bottom: 20px;
        }
        #payment-history-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #payment-history-form input[type="date"],
        #payment-history-form input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            min-width: 120px; /* Ensure inputs don't get too small */
            background-color: var(--main-content-bg);
            color: var(--section-header-text);
        }
        #payment-history-form button {
            padding: 10px 20px;
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #payment-history-form button:hover {
            background-color: var(--button-primary-hover-bg);
        }

        #payment-history-display {
            border: 1px solid var(--table-border);
            padding: 15px;
            margin-top: 20px;
            background-color: var(--main-content-bg);
            max-height: 500px;
            overflow-y: auto;
        }
        #payment-history-display table {
            width: 100%;
            border-collapse: collapse;
            color: var(--section-header-text);
        }
        #payment-history-display th, #payment-history-display td {
            border: 1px solid var(--table-border);
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        #payment-history-display th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
        }

        /* Month Closure Styling */
        #month-closure-section {
            text-align: center;
        }
        #month-closure-section h3 {
            color: var(--section-header-text);
            margin-bottom: 20px;
        }
        #month-closure-section button {
            padding: 15px 30px;
            background-color: #ffc107; /* Specific color for this button */
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }
        #month-closure-section button:hover {
            background-color: #e0a800;
        }
        #monthly-summary-display {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--summary-border);
            background-color: var(--summary-bg);
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            color: var(--section-header-text);
        }
        #monthly-summary-display h4 {
            text-align: center;
            color: var(--section-header-text);
            margin-bottom: 15px;
        }
        #monthly-summary-display p {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        #monthly-summary-display strong {
            color: var(--summary-span-text);
        }

        /* Settings Section Styling */
        #settings-section {
            padding: 20px;
            color: var(--section-header-text);
        }
        #settings-section h3 {
            color: var(--header-text);
            margin-bottom: 20px;
        }
        .settings-group {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid var(--summary-border);
            border-radius: 5px;
            background-color: var(--summary-bg);
        }
        .settings-group h4 {
            margin-top: 0;
            color: var(--section-header-text);
        }
        .settings-group input[type="number"],
        .settings-group input[type="password"] {
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            width: 200px;
            margin-right: 10px;
            margin-bottom: 10px;
            background-color: var(--main-content-bg);
            color: var(--section-header-text);
        }
        .settings-group button {
            padding: 10px 20px;
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .settings-group button:hover {
            background-color: var(--button-primary-hover-bg);
        }
        #reset-password-group h4 {
            color: var(--button-danger-bg);
        }
        #reset-password-group button {
            background-color: var(--button-danger-bg);
        }
        #reset-password-group button:hover {
            background-color: var(--button-danger-hover-bg);
        }


        /* Developer Info */
        .developer-info {
            text-align: center;
            margin-top: auto; /* Pushes it to the bottom of the sidebar */
            padding-top: 20px;
            border-top: 1px solid var(--sidebar-hover-bg);
            font-size: 0.8em;
            color: var(--developer-info-text);
        }
        .developer-info a {
            color: var(--developer-info-link);
            text-decoration: none;
        }
        .developer-info a:hover {
            text-decoration: underline;
        }

        /* Theme Toggle in Sidebar */
        .theme-toggle-container {
            margin-top: 20px;
            padding: 10px 20px;
            text-align: center;
            border-top: 1px solid var(--sidebar-hover-bg);
            padding-top: 20px;
        }

        .theme-toggle-container button {
            background-color: #607d8b; /* A neutral grey for the toggle */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin: 0 auto;
            transition: background-color 0.3s ease;
        }

        .theme-toggle-container button:hover {
            background-color: #546e7a;
        }

        /* Logout Button in Sidebar */
        #logout-button {
            background-color: #f44336; /* Red for logout */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            width: calc(100% - 40px); /* Adjust for padding */
            margin-left: 20px;
            margin-right: 20px;
            transition: background-color 0.3s ease;
        }
        #logout-button:hover {
            background-color: #d32f2f;
        }

        /* Login Page Styling */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 1000;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        .login-container {
            background-color: var(--main-content-bg);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            width: 300px;
            transition: background-color 0.3s ease;
        }

        .login-container h2 {
            color: var(--header-text);
            margin-bottom: 25px;
        }

        .login-container input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--section-header-text);
        }

        .login-container button {
            width: 100%;
            padding: 10px;
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }

        .login-container button:hover {
            background-color: var(--button-primary-hover-bg);
        }

        #login-error {
            color: var(--button-danger-bg);
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Hide app content when login page is active */
        #app-container {
            display: flex; /* Keep flex for sidebar/main-content layout */
            width: 100%;
            height: 100%;
        }
        body.logged-out #app-container {
            display: none;
        }
        body.logged-in #login-page {
            display: none;
        }


        /* Print Specific Styling */
        @media print {
            body {
                display: block;
                margin: 0;
                padding: 0;
                background-color: white;
            }
            #sidebar, .form-row, .dashboard-buttons, .report-controls,
            .delete-report-section, #requestPaymentBtn, #printDailyBtn, /* Hide print button itself */
            #month-closure-section button, #payment-history-section h2, #payment-history-display button,
            #payment-history-form, #settings-section, .dashboard-date-selection, /* Hide settings, payment form, dashboard date selector */
            #login-page, #logout-button, .theme-toggle-container /* Hide login page, logout, theme toggle */
            {
                display: none !important;
            }
            #main-content {
                box-shadow: none;
                margin: 0;
                padding: 0;
                border-radius: 0;
                width: 100%;
            }
            header {
                text-align: center;
                margin-bottom: 15px;
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
            }
            header h1 {
                font-size: 1.8em;
            }
            header h2 {
                font-size: 1em;
            }
            .date-display {
                text-align: right;
                margin-bottom: 15px;
            }
            .summary-section, .balance-info, .report-summary {
                border: none;
                background-color: transparent;
                padding: 0;
                margin-top: 15px;
                font-size: 0.9em; /* Smaller font for print */
            }
            .summary-section div {
                margin-bottom: 4px; /* Less space between summary lines */
            }
            .balance-info {
                display: block; /* Remove flex for print */
                text-align: right;
            }
            .balance-info .balance-toggle-btn {
                display: none !important; /* Hide toggle button in print */
            }
            #transactions-table, #report-display table, #payment-history-display table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: avoid;
            }
            #transactions-table th, #transactions-table td,
            #report-display th, #report-display td,
            #payment-history-display th, #payment-history-display td {
                border: 1px solid #ddd;
                padding: 5px;
                font-size: 0.8em;
            }
            /* Adjust table for daily print to remove action column */
            #transactions-table th:last-child,
            #transactions-table td:last-child {
                display: none;
            }

            #report-display, #payment-history-display, #monthly-summary-display {
                border: none;
                padding: 0;
                margin-top: 10px;
                max-height: none;
                overflow: visible;
            }
            .print-footer {
                display: block;
                text-align: center;
                margin-top: 30px;
                font-size: 0.9em;
                color: #555;
            }
            .print-footer a {
                color: #555;
                text-decoration: none;
            }
        }
    </style>
</head>
<body>
    <div id="login-page">
        <div class="login-container">
            <h2>Darson Securities Login</h2>
            <input type="text" id="username-input" placeholder="Username">
            <input type="password" id="password-input" placeholder="Password">
            <button id="login-btn">Login</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app-container">
        <div id="sidebar">
            <h2>Darson Securities</h2>
            <ul>
                <li><a href="#" id="nav-dashboard" class="active">Dashboard</a></li>
                <li><a href="#" id="nav-reports">Reports</a></li>
                <li><a href="#" id="nav-payment-history">Payment History</a></li>
                <li><a href="#" id="nav-month-closure">Month Closure</a></li>
                <li><a href="#" id="nav-settings">Settings</a></li>
            </ul>
            <div class="theme-toggle-container">
                <button id="theme-toggle-btn">Toggle Theme</button>
            </div>
            <button id="logout-button">Logout</button>
            <div class="developer-info print-footer">
                Developed by Afrasiab Asghar<br>
                Visit <a href="http://www.Nextgensites.org" target="_blank">www.Nextgensites.org</a><br>
                Contact +923060406003
            </div>
        </div>

        <div id="main-content">
            <header>
                <h1>Darson Securities Limited</h1>
                <h2>Commission Report</h2>
                <div class="date-display">Date: <span id="current-date"></span></div>
            </header>

            <section id="dashboard-section">
                <h3>Daily Commission Entry</h3>
                <div class="dashboard-date-selection">
                    <label for="dashboard-date-selector">Select Date:</label>
                    <input type="date" id="dashboard-date-selector">
                </div>
                <div class="form-row">
                    <input type="text" id="stock-name" placeholder="Stock Name">
                    <input type="number" id="stock-quantity" placeholder="Quantity" min="1">
                    <input type="number" id="stock-rate" placeholder="Rate (PKR)" step="0.01" min="0.01">
                    <input type="number" id="commission-per-stock" placeholder="Comm. per Stock (PKR)" step="0.01" readonly>
                    <input type="number" id="total-commission-per-stock" placeholder="Total Comm. (PKR)" step="0.01" readonly>
                    <button id="add-entry-btn">Add Entry</button>
                </div>

                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Stock Name</th>
                            <th>Quantity</th>
                            <th>Rate (PKR)</th>
                            <th>Comm. per Stock (PKR)</th>
                            <th>Total Comm. (PKR)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        </tbody>
                </table>

                <div class="summary-section">
                    <div><strong>Gross Commission:</strong> <span id="gross-commission-display">0.00 PKR</span></div>
                    <div><strong>Head Office Deduction (40%):</strong> <span id="ho-deduction-display">0.00 PKR</span></div>
                    <div><strong>Remaining Commission:</strong> <span id="remaining-commission-display">0.00 PKR</span></div>
                    <div><strong>Tax Deduction (12%):</strong> <span id="tax-deduction-display">0.00 PKR</span></div>
                    <div><strong>Net Commission:</strong> <span id="net-commission-display">0.00 PKR</span></div>
                </div>

                <div class="balance-info">
                    <div>
                        Previous Balance: <span class="balance-amount" id="previous-balance-display">0.00 PKR</span><br>
                        Current Balance: <span class="balance-amount" id="current-balance-display">0.00 PKR</span>
                    </div>
                    <button class="balance-toggle-btn" id="toggle-balance-btn">üëÅÔ∏è</button>
                </div>

                <div class="dashboard-buttons">
                    <button id="saveDayBtn">Save Day Data</button>
                    <button id="clearEntriesBtn">Clear Current Entries</button>
                    <button id="requestPaymentBtn">Request Payment</button>
                    <button id="printDailyBtn">Print Daily Transactions</button>
                </div>
            </section>

            <section id="reports-section">
                <h3>View Reports</h3>
                <div class="report-controls">
                    <label for="report-start-date">Start Date:</label>
                    <input type="date" id="report-start-date">
                    <label for="report-end-date">End Date:</label>
                    <input type="date" id="report-end-date">
                    <button id="view-date-range-report-btn">View Date Range Report</button>
                </div>
                <div class="report-controls">
                    <input type="date" id="report-date-selector">
                    <select id="report-month-selector">
                        <option value="">Select Month</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <input type="number" id="report-year-selector" placeholder="Year (e.g., 2023)" min="2000" max="2100">
                    <button id="view-single-report-btn">View Daily/Monthly Report</button>
                    <button id="print-report-btn">Print Report</button>
                </div>
                <div id="report-display">
                    </div>

                <div class="delete-report-section">
                    <h4>Delete Report (Password Protected)</h4>
                    <input type="password" id="delete-password" placeholder="Enter Password">
                    <button id="delete-report-btn">Delete Selected Report</button>
                </div>
            </section>

            <section id="payment-history-section">
                <h3>Payment History</h3>
                <div id="payment-history-form">
                    <h4>Add/Update Payment Record</h4>
                    <input type="date" id="payment-date-input" required>
                    <input type="number" id="payment-requested-input" placeholder="Requested Amount (PKR)" step="0.01" min="0">
                    <input type="number" id="payment-approved-input" placeholder="Approved Amount (PKR)" step="0.01" min="0">
                    <input type="number" id="payment-paid-input" placeholder="Paid Amount (PKR)" step="0.01" min="0">
                    <button id="add-payment-record-btn">Add/Update Payment</button>
                </div>
                <div id="payment-history-display">
                    <table id="payment-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Requested (PKR)</th>
                                <th>Approved (PKR)</th>
                                <th>Paid (PKR)</th>
                                <th>Balance Before (PKR)</th>
                                <th>Balance After (PKR)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="month-closure-section">
                <h3>Month Closure</h3>
                <p>Generate a summary for the selected month.</p>
                <div class="report-controls">
                    <select id="close-month-selector">
                        <option value="">Select Month</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <input type="number" id="close-year-selector" placeholder="Year (e.g., 2023)" min="2000" max="2100">
                    <button id="generate-monthly-summary-btn">Generate Monthly Summary</button>
                </div>
                <div id="monthly-summary-display">
                    </div>
            </section>

            <section id="settings-section">
                <h3>Settings</h3>
                <div class="settings-group">
                    <h4>Set Overall Previous Balance Manually (Password Protected)</h4>
                    <p>This will set the global accumulated balance to the value you enter. Use with caution.</p>
                    <input type="number" id="manual-previous-balance" placeholder="Enter new balance (PKR)" step="0.01">
                    <input type="password" id="settings-password" placeholder="Enter Password">
                    <button id="save-manual-balance-btn">Save Manual Balance</button>
                </div>
                <div class="settings-group" id="reset-password-group">
                    <h4>Reset All Software Data (Password Protected)</h4>
                    <p>This action will permanently delete ALL stored commission data, payment history, and balances. This cannot be undone.</p>
                    <input type="password" id="reset-password" placeholder="Enter Password to Reset">
                    <button id="confirm-reset-btn">Confirm Reset</button>
                </div>
            </section>

            <div class="print-footer" style="display: none;">
                Developed by Afrasiab Asghar | www.Nextgensites.org | Contact +923060406003
            </div>
        </div>
    </div>

    <script>
        const AUTH_USERNAME = "DARSON";
        const AUTH_PASSWORD = "AFRASIAB";

        // Local Storage Keys
        const LOCAL_STORAGE_PREFIX = "darson_securities_";
        const DAILY_COMMISSION_KEY_PREFIX = LOCAL_STORAGE_PREFIX + "daily_commissions_";
        const PAYMENT_HISTORY_KEY = LOCAL_STORAGE_PREFIX + "payment_history";
        const CURRENT_BALANCE_KEY = LOCAL_STORAGE_PREFIX + "current_balance";
        const MONTHLY_SUMMARY_KEY_PREFIX = LOCAL_STORAGE_PREFIX + "monthly_summary_";
        const THEME_PREFERENCE_KEY = LOCAL_STORAGE_PREFIX + "theme_preference";

        let currentTransactions = [];
        let previousBalance = 0;
        let currentBalance = 0;
        let balanceHidden = false;

        // DOM Elements - Login Page
        const loginPage = document.getElementById('login-page');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const appContainer = document.getElementById('app-container');

        // DOM Elements - Sidebar & Theme
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const logoutButton = document.getElementById('logout-button');

        // DOM Elements - Main Content (existing)
        const currentDateSpan = document.getElementById('current-date');
        const dashboardDateSelector = document.getElementById('dashboard-date-selector');
        const stockNameInput = document.getElementById('stock-name');
        const stockQuantityInput = document.getElementById('stock-quantity');
        const stockRateInput = document.getElementById('stock-rate');
        const commissionPerStockInput = document.getElementById('commission-per-stock');
        const totalCommissionPerStockInput = document.getElementById('total-commission-per-stock');
        const addEntryBtn = document.getElementById('add-entry-btn');
        const transactionsBody = document.getElementById('transactions-body');
        const grossCommissionDisplay = document.getElementById('gross-commission-display');
        const hoDeductionDisplay = document.getElementById('ho-deduction-display');
        const remainingCommissionDisplay = document.getElementById('remaining-commission-display');
        const taxDeductionDisplay = document.getElementById('tax-deduction-display');
        const netCommissionDisplay = document.getElementById('net-commission-display');
        const previousBalanceDisplay = document.getElementById('previous-balance-display');
        const currentBalanceDisplay = document.getElementById('current-balance-display');
        const saveDayBtn = document.getElementById('saveDayBtn');
        const clearEntriesBtn = document.getElementById('clearEntriesBtn');
        const requestPaymentBtn = document.getElementById('requestPaymentBtn');
        const printDailyBtn = document.getElementById('printDailyBtn');
        const toggleBalanceBtn = document.getElementById('toggle-balance-btn');

        const navDashboard = document.getElementById('nav-dashboard');
        const navReports = document.getElementById('nav-reports');
        const navPaymentHistory = document.getElementById('nav-payment-history');
        const navMonthClosure = document.getElementById('nav-month-closure');
        const navSettings = document.getElementById('nav-settings');

        const dashboardSection = document.getElementById('dashboard-section');
        const reportsSection = document.getElementById('reports-section');
        const paymentHistorySection = document.getElementById('payment-history-section');
        const monthClosureSection = document.getElementById('month-closure-section');
        const settingsSection = document.getElementById('settings-section');

        const reportStartDateSelector = document.getElementById('report-start-date');
        const reportEndDateSelector = document.getElementById('report-end-date');
        const viewDateRangeReportBtn = document.getElementById('view-date-range-report-btn');

        const reportDateSelector = document.getElementById('report-date-selector');
        const reportMonthSelector = document.getElementById('report-month-selector');
        const reportYearSelector = document.getElementById('report-year-selector');
        const viewSingleReportBtn = document.getElementById('view-single-report-btn');
        const printReportBtn = document.getElementById('print-report-btn');
        const reportDisplay = document.getElementById('report-display');
        const deletePasswordInput = document.getElementById('delete-password');
        const deleteReportBtn = document.getElementById('delete-report-btn');

        const paymentDateInput = document.getElementById('payment-date-input');
        const paymentRequestedInput = document.getElementById('payment-requested-input');
        const paymentApprovedInput = document.getElementById('payment-approved-input');
        const paymentPaidInput = document.getElementById('payment-paid-input');
        const addPaymentRecordBtn = document.getElementById('add-payment-record-btn');
        const paymentHistoryBody = document.getElementById('payment-history-body');

        const closeMonthSelector = document.getElementById('close-month-selector');
        const closeYearSelector = document.getElementById('close-year-selector');
        const generateMonthlySummaryBtn = document.getElementById('generate-monthly-summary-btn');
        const monthlySummaryDisplay = document.getElementById('monthly-summary-display');

        const manualPreviousBalanceInput = document.getElementById('manual-previous-balance');
        const settingsPasswordInput = document.getElementById('settings-password');
        const saveManualBalanceBtn = document.getElementById('save-manual-balance-btn');

        const resetPasswordInput = document.getElementById('reset-password');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');


        // Helper Functions
        /**
         * Formats a Date object into a YYYY-MM-DD string.
         * @param {Date} date - The date object to format.
         * @returns {string} The formatted date string.
         */
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Formats a number as currency in PKR.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(amount) {
            if (balanceHidden) {
                return '****** PKR'; // Return masked value if hidden
            }
            return `${amount.toFixed(2)} PKR`;
        }

        /**
         * Determines the commission rate based on the stock rate.
         * @param {number} rate - The stock rate.
         * @returns {number} The commission rate (fixed amount or percentage as decimal).
         */
        function getCommissionRate(rate) {
            if (rate >= 0.01 && rate <= 3.00) return 0.03;
            if (rate >= 3.01 && rate <= 20.00) return 0.07;
            if (rate >= 20.01 && rate <= 40.00) return 0.09;
            if (rate >= 40.01 && rate <= 50.00) return 0.12;
            if (rate >= 50.01 && rate <= 90.00) return 0.14;
            if (rate >= 90.01 && rate <= 100.00) return 0.17;
            if (rate > 100.00) return 0.0017; // 0.17% as a decimal
            return 0;
        }

        /**
         * Calculates commission per stock and total commission for a given quantity and rate.
         * @param {number} quantity - The quantity of stocks.
         * @param {number} rate - The rate per stock.
         * @returns {{commissionPerStock: number, totalCommission: number}} An object containing calculated commissions.
         */
        function calculateCommission(quantity, rate) {
            const commissionRate = getCommissionRate(rate);
            let commissionPerStock;

            if (rate > 100.00) {
                // For rates above 100, commission is 0.17% of transaction value per stock
                commissionPerStock = (rate * commissionRate);
            } else {
                // For rates up to 100, commission is a fixed amount per stock
                commissionPerStock = commissionRate;
            }

            const totalCommission = commissionPerStock * quantity;
            return {
                commissionPerStock: commissionPerStock,
                totalCommission: totalCommission
            };
        }

        /**
         * Calculates deductions (Head Office and Tax) from the gross commission.
         * @param {number} grossCommission - The total gross commission.
         * @returns {{hoDeduction: number, remainingCommission: number, taxDeduction: number, netCommission: number}} An object containing calculated deductions and net commission.
         */
        function calculateDeductions(grossCommission) {
            const hoDeduction = grossCommission * 0.40; // 40% for head office
            const remainingCommission = grossCommission - hoDeduction;
            const taxDeduction = remainingCommission * 0.12; // 12% tax on remaining 60%
            const netCommission = remainingCommission - taxDeduction;
            return { hoDeduction, remainingCommission, taxDeduction, netCommission };
        }

        /**
         * Updates the summary display on the dashboard based on current transactions.
         * Also updates the current balance.
         */
        function updateSummary() {
            let totalGrossCommission = currentTransactions.reduce((sum, t) => sum + t.totalCommission, 0);
            const { hoDeduction, remainingCommission, taxDeduction, netCommission } = calculateDeductions(totalGrossCommission);

            grossCommissionDisplay.textContent = formatCurrency(totalGrossCommission);
            hoDeductionDisplay.textContent = formatCurrency(hoDeduction);
            remainingCommissionDisplay.textContent = formatCurrency(remainingCommission);
            taxDeductionDisplay.textContent = formatCurrency(taxDeduction);
            netCommissionDisplay.textContent = formatCurrency(netCommission);

            updateDashboardBalances(); // Update dashboard previous/current balance display
        }

        /**
         * Renders the current transactions in the dashboard table.
         */
        function renderTransactions() {
            transactionsBody.innerHTML = '';
            if (currentTransactions.length === 0) {
                transactionsBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No entries for today.</td></tr>';
            }
            currentTransactions.forEach((transaction, index) => {
                const row = transactionsBody.insertRow();
                row.innerHTML = `
                    <td>${transaction.stockName}</td>
                    <td>${transaction.quantity}</td>
                    <td>${formatCurrency(transaction.rate)}</td>
                    <td>${formatCurrency(transaction.commissionPerStock)}</td>
                    <td>${formatCurrency(transaction.totalCommission)}</td>
                    <td><button data-index="${index}" class="delete-transaction-btn">Delete</button></td>
                `;
            });
            document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = deleteTransaction;
            });
            updateSummary(); // Call updateSummary to refresh balances after rendering
        }

        /**
         * Loads daily transactions for a specific date from local storage.
         * @param {string} date - The date in YYYY-MM-DD format.
         */
        function loadDailyTransactions(date) {
            const data = localStorage.getItem(DAILY_COMMISSION_KEY_PREFIX + date);
            if (data) {
                currentTransactions = JSON.parse(data);
            } else {
                currentTransactions = [];
            }
            renderTransactions();
        }

        /**
         * Saves the current day's transactions and updates the global running balance in local storage.
         * @param {string} date - The current date in YYYY-MM-DD format.
         */
        function saveDailyTransactions(date) {
            const oldDailyData = localStorage.getItem(DAILY_COMMISSION_KEY_PREFIX + date);
            const oldTransactionsForDay = oldDailyData ? JSON.parse(oldDailyData) : [];
            const oldNetCommissionForDay = calculateDeductions(oldTransactionsForDay.reduce((sum, t) => sum + t.totalCommission, 0)).netCommission;

            const newNetCommissionForDay = calculateDeductions(currentTransactions.reduce((sum, t) => sum + t.totalCommission, 0)).netCommission;

            const netChangeInCommission = newNetCommissionForDay - oldNetCommissionForDay;

            // Update the global accumulated balance in localStorage
            let globalAccumulatedBalance = parseFloat(localStorage.getItem(CURRENT_BALANCE_KEY) || 0);
            globalAccumulatedBalance += netChangeInCommission;
            localStorage.setItem(CURRENT_BALANCE_KEY, globalAccumulatedBalance.toFixed(2));

            // Save the current day's transactions
            localStorage.setItem(DAILY_COMMISSION_KEY_PREFIX + date, JSON.stringify(currentTransactions));

            // Re-calculate and update dashboard balances for the current view
            updateDashboardBalances();
        }

        /**
         * Ensures the CURRENT_BALANCE_KEY exists in localStorage, initializing if not.
         * This function does NOT update the dashboard display variables (previousBalance, currentBalance).
         */
        function ensureGlobalBalanceExists() {
            if (localStorage.getItem(CURRENT_BALANCE_KEY) === null) {
                localStorage.setItem(CURRENT_BALANCE_KEY, '0.00');
            }
        }

        /**
         * Adds a payment record to the payment history in local storage.
         * This function now handles requested, approved, and paid amounts.
         * @param {object} payment - The payment object.
         * @param {string} payment.date - Date of the payment.
         * @param {number} payment.requested - Requested amount.
         * @param {number} payment.approved - Approved amount.
         * @param {number} payment.paid - Paid amount.
         * @param {number} payment.balanceBefore - Balance before this payment was applied.
         * @param {number} payment.balanceAfter - Balance after this payment was applied.
         */
        function addPaymentRecord(payment) {
            const payments = JSON.parse(localStorage.getItem(PAYMENT_HISTORY_KEY) || '[]');
            // Check if an entry for the same date exists and update it, otherwise add new
            const existingIndex = payments.findIndex(p => p.date === payment.date);
            if (existingIndex > -1) {
                payments[existingIndex] = payment;
            } else {
                payments.push(payment);
            }
            localStorage.setItem(PAYMENT_HISTORY_KEY, JSON.stringify(payments));
            renderPaymentHistory();
        }

        /**
         * Renders the payment history table.
         */
        function renderPaymentHistory() {
            const payments = JSON.parse(localStorage.getItem(PAYMENT_HISTORY_KEY) || '[]');
            paymentHistoryBody.innerHTML = '';
            if (payments.length === 0) {
                paymentHistoryBody.innerHTML = '<tr><td colspan="7">No payment history found.</td></tr>';
                return;
            }
            payments.forEach((payment, index) => {
                const row = paymentHistoryBody.insertRow();
                row.innerHTML = `
                    <td>${payment.date}</td>
                    <td>${formatCurrency(payment.requested)}</td>
                    <td>${formatCurrency(payment.approved)}</td>
                    <td>${formatCurrency(payment.paid)}</td>
                    <td>${formatCurrency(payment.balanceBefore)}</td>
                    <td>${formatCurrency(payment.balanceAfter)}</td>
                    <td><button data-index="${index}" class="delete-payment-btn">Delete</button></td>
                `;
            });
            document.querySelectorAll('.delete-payment-btn').forEach(button => {
                button.onclick = deletePaymentRecord;
            });
        }

        /**
         * Deletes a payment record from history.
         * @param {Event} event - The click event.
         */
        function deletePaymentRecord(event) {
            const index = event.target.dataset.index;
            const payments = JSON.parse(localStorage.getItem(PAYMENT_HISTORY_KEY) || '[]');
            
            const deletedPayment = payments[index];
            if (deletedPayment && deletedPayment.paid > 0) {
                // Add the paid amount back to the global accumulated balance
                let globalAccumulatedBalance = parseFloat(localStorage.getItem(CURRENT_BALANCE_KEY) || 0);
                globalAccumulatedBalance += deletedPayment.paid;
                localStorage.setItem(CURRENT_BALANCE_KEY, globalAccumulatedBalance.toFixed(2));
            }

            payments.splice(index, 1);
            localStorage.setItem(PAYMENT_HISTORY_KEY, JSON.stringify(payments));
            renderPaymentHistory(); // Re-render payment history table

            updateDashboardBalances(); // Update balances after deletion
            alert('Payment record deleted and global balance adjusted!');
        }


        /**
         * Toggles the visibility of balance amounts.
         */
        function toggleBalanceVisibility() {
            balanceHidden = !balanceHidden;
            updateBalanceDisplay(); // Re-render display based on new visibility state
            toggleBalanceBtn.textContent = balanceHidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è'; // Change icon
        }

        /**
         * Updates the balance display elements on the dashboard.
         * This function uses the global `previousBalance` and `currentBalance` variables.
         */
        function updateBalanceDisplay() {
            previousBalanceDisplay.textContent = formatCurrency(previousBalance);
            currentBalanceDisplay.textContent = formatCurrency(currentBalance);
        }

        /**
         * Updates the dashboard's "Previous Balance" and "Current Balance" displays
         * based on the currently selected date in the dashboard date selector and the global accumulated balance.
         * 'previousBalance' will show the global balance *before* the selected day's saved transactions.
         * 'currentBalance' will show the 'previousBalance' plus the net commission of the selected day's current entries.
         */
        function updateDashboardBalances() {
            const selectedDate = dashboardDateSelector.value;
            
            // 1. Get the net commission of the *saved* transactions for the selected date.
            // This represents what was *already accounted for* in the global balance for this day.
            const savedDailyData = localStorage.getItem(DAILY_COMMISSION_KEY_PREFIX + selectedDate);
            const savedTransactionsForDay = savedDailyData ? JSON.parse(savedDailyData) : [];
            const savedNetCommissionForDay = calculateDeductions(savedTransactionsForDay.reduce((sum, t) => sum + t.totalCommission, 0)).netCommission;

            // 2. Get the current global accumulated balance from localStorage.
            let globalAccumulatedBalance = parseFloat(localStorage.getItem(CURRENT_BALANCE_KEY) || 0);

            // 3. Calculate the 'previousBalance' for the dashboard display:
            // This is the global balance *before* the saved net commission of the selected day.
            // If the selected day has no saved data, this effectively is the global balance.
            previousBalance = globalAccumulatedBalance - savedNetCommissionForDay;
            previousBalanceDisplay.textContent = formatCurrency(previousBalance);

            // 4. Calculate the 'currentBalance' for the dashboard display:
            // This is the 'previousBalance' (from step 3) plus the net commission of the *currently loaded/edited* transactions for the selected day.
            const currentNetCommissionForDay = calculateDeductions(currentTransactions.reduce((sum, t) => sum + t.totalCommission, 0)).netCommission;
            currentBalance = previousBalance + currentNetCommissionForDay;
            currentBalanceDisplay.textContent = formatCurrency(currentBalance);
        }


        // Event Listeners

        // Dashboard date selector change
        dashboardDateSelector.addEventListener('change', () => {
            const selectedDate = dashboardDateSelector.value;
            currentDateSpan.textContent = selectedDate; // Update header date
            loadDailyTransactions(selectedDate); // Load transactions for the selected date
            // updateDashboardBalances() is called by loadDailyTransactions -> renderTransactions -> updateSummary
        });

        // Update commission fields when quantity or rate changes
        stockRateInput.addEventListener('input', () => {
            const quantity = parseFloat(stockQuantityInput.value);
            const rate = parseFloat(stockRateInput.value);
            if (quantity > 0 && rate > 0) {
                const { commissionPerStock, totalCommission } = calculateCommission(quantity, rate);
                commissionPerStockInput.value = commissionPerStock.toFixed(2);
                totalCommissionPerStockInput.value = totalCommission.toFixed(2);
            } else {
                commissionPerStockInput.value = '0.00';
                totalCommissionPerStockInput.value = '0.00';
            }
        });

        stockQuantityInput.addEventListener('input', () => {
            const quantity = parseFloat(stockQuantityInput.value);
            const rate = parseFloat(stockRateInput.value);
            if (quantity > 0 && rate > 0) {
                const { commissionPerStock, totalCommission } = calculateCommission(quantity, rate);
                commissionPerStockInput.value = commissionPerStock.toFixed(2);
                totalCommissionPerStockInput.value = totalCommission.toFixed(2);
            } else {
                commissionPerStockInput.value = '0.00';
                totalCommissionPerStockInput.value = '0.00';
            }
        });

        // Add new transaction entry
        addEntryBtn.addEventListener('click', () => {
            const stockName = stockNameInput.value.trim();
            const quantity = parseInt(stockQuantityInput.value);
            const rate = parseFloat(stockRateInput.value);
            const commissionPerStock = parseFloat(commissionPerStockInput.value);
            const totalCommission = parseFloat(totalCommissionPerStockInput.value);

            if (stockName && quantity > 0 && rate > 0 && !isNaN(commissionPerStock) && !isNaN(totalCommission)) {
                currentTransactions.push({ stockName, quantity, rate, commissionPerStock, totalCommission });
                renderTransactions();
                // Clear input fields after adding
                stockNameInput.value = '';
                stockQuantityInput.value = '';
                stockRateInput.value = '';
                commissionPerStockInput.value = '0.00';
                totalCommissionPerStockInput.value = '0.00';
            } else {
                alert('Please fill in all stock details correctly (Stock Name, Quantity > 0, Rate > 0).');
            }
        });

        // Delete a specific transaction row
        function deleteTransaction(event) {
            const index = event.target.dataset.index;
            currentTransactions.splice(index, 1);
            renderTransactions();
        }

        // Save current day's transactions and update global balance
        saveDayBtn.addEventListener('click', () => {
            const selectedDate = dashboardDateSelector.value;
            saveDailyTransactions(selectedDate);
            alert('Daily commission data saved and global balance updated!');
        });

        // Clear only the current day's entries from the dashboard (does not affect saved data)
        clearEntriesBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all current entries from the dashboard? This will not affect saved data for today or previous days.')) {
                currentTransactions = [];
                renderTransactions();
                // updateDashboardBalances() is called by renderTransactions -> updateSummary
            }
        });

        // "Request Payment" button on Dashboard - now just adds a record
        requestPaymentBtn.addEventListener('click', () => {
            const today = formatDate(new Date());
            const requestedAmount = parseFloat(prompt(`Enter amount to request (Current Balance: ${formatCurrency(currentBalance)}):`));

            if (isNaN(requestedAmount) || requestedAmount <= 0) {
                alert("Please enter a valid positive amount for the request.");
                return;
            }

            // This button now only adds a *pending* request to the history
            // The actual deduction happens when a 'Paid' amount is entered in Payment History
            const newPayment = {
                date: today,
                requested: requestedAmount,
                approved: 0, // Initially 0
                paid: 0,     // Initially 0
                balanceBefore: parseFloat(localStorage.getItem(CURRENT_BALANCE_KEY) || 0), // Snapshot of global balance before this request
                balanceAfter: parseFloat(localStorage.getItem(CURRENT_BALANCE_KEY) || 0)   // Balance doesn't change until paid
            };
            addPaymentRecord(newPayment);
            alert(`Payment request of ${formatCurrency(requestedAmount)} added. Please go to 'Payment History' to update its status.`);
        });

        // New print button for daily transactions
        printDailyBtn.addEventListener('click', () => {
            // Temporarily hide the action column for printing
            const actionColumnHeader = document.querySelector('#transactions-table th:last-child');
            const actionColumnCells = document.querySelectorAll('#transactions-table td:last-child');

            if (actionColumnHeader) actionColumnHeader.style.display = 'none';
            actionColumnCells.forEach(cell => cell.style.display = 'none');

            window.print();

            // Restore the action column after printing
            if (actionColumnHeader) actionColumnHeader.style.display = '';
            actionColumnCells.forEach(cell => cell.style.display = '');
        });

        // Toggle balance visibility
        toggleBalanceBtn.addEventListener('click', toggleBalanceVisibility);


        // Navigation Functionality
        /**
         * Shows a specific section of the application and updates active navigation link.
         * @param {string} sectionId - The ID of the section to show (e.g., 'dashboard-section').
         */
        function showSection(sectionId) {
            dashboardSection.style.display = 'none';
            reportsSection.style.display = 'none';
            paymentHistorySection.style.display = 'none';
            monthClosureSection.style.display = 'none';
            settingsSection.style.display = 'none';

            document.getElementById(sectionId).style.display = 'block';

            document.querySelectorAll('#sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(`nav-${sectionId.replace('-section', '')}`).classList.add('active');

            if (sectionId === 'payment-history-section') {
                renderPaymentHistory();
                // Set default date for payment form
                paymentDateInput.value = formatDate(new Date());
            }
        }

        navDashboard.addEventListener('click', (e) => { e.preventDefault(); showSection('dashboard-section'); });
        navReports.addEventListener('click', (e) => { e.preventDefault(); showSection('reports-section'); });
        navPaymentHistory.addEventListener('click', (e) => { e.preventDefault(); showSection('payment-history-section'); });
        navMonthClosure.addEventListener('click', (e) => { e.preventDefault(); showSection('month-closure-section'); });
        navSettings.addEventListener('click', (e) => { e.preventDefault(); showSection('settings-section'); });

        // Reports Functionality
        // View single day/month report
        viewSingleReportBtn.addEventListener('click', () => {
            const selectedDate = reportDateSelector.value;
            const selectedMonth = reportMonthSelector.value;
            const selectedYear = reportYearSelector.value;
            reportDisplay.innerHTML = ''; // Clear previous report

            if (selectedDate) {
                // View daily report
                const data = localStorage.getItem(DAILY_COMMISSION_KEY_PREFIX + selectedDate);
                if (data) {
                    const transactions = JSON.parse(data);
                    let totalGrossCommission = transactions.reduce((sum, t) => sum + t.totalCommission, 0);
                    const { hoDeduction, remainingCommission, taxDeduction, netCommission } = calculateDeductions(totalGrossCommission);

                    let reportHtml = `<h3>Daily Commission Report for ${selectedDate}</h3>`;
                    reportHtml += `<table border="1">
                        <thead>
                            <tr>
                                <th>Stock Name</th>
                                <th>Quantity</th>
                                <th>Rate (PKR)</th>
                                <th>Comm. per Stock (PKR)</th>
                                <th>Total Comm. (PKR)</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    if (transactions.length === 0) {
                        reportHtml += `<tr><td colspan="5" style="text-align: center;">No transactions recorded for this day.</td></tr>`;
                    } else {
                        transactions.forEach(t => {
                            reportHtml += `<tr>
                                <td>${t.stockName}</td>
                                <td>${t.quantity}</td>
                                <td>${t.rate.toFixed(2)}</td>
                                <td>${t.commissionPerStock.toFixed(2)}</td>
                                <td>${t.totalCommission.toFixed(2)}</td>
                            </tr>`;
                        });
                    }
                    reportHtml += `</tbody></table>`;
                    reportHtml += `<div class="report-summary">
                        <p><strong>Gross Commission:</strong> <span>${totalGrossCommission.toFixed(2)} PKR</span></p>
                        <p><strong>Head Office Deduction (40%):</strong> <span>${hoDeduction.toFixed(2)} PKR</span></p>
                        <p><strong>Remaining Commission:</strong> <span>${remainingCommission.toFixed(2)} PKR</span></p>
                        <p><strong>Tax Deduction (12%):</strong> <span>${taxDeduction.toFixed(2)} PKR</span></p>
                        <p><strong>Net Commission:</strong> <span>${netCommission.toFixed(2)} PKR</span></p>
                    </div>`;
                    reportDisplay.innerHTML = reportHtml;
                } else {
                    reportDisplay.innerHTML = `<p>No daily commission data found for ${selectedDate}.</p>`;
                }
            } else if (selectedMonth && selectedYear) {
                // View monthly summary
                const monthKey = `${selectedYear}-${selectedMonth}`;
                const monthlySummary = localStorage.getItem(MONTHLY_SUMMARY_KEY_PREFIX + monthKey);
                if (monthlySummary) {
                    reportDisplay.innerHTML = `<h3>Monthly Summary for ${new Date(selectedYear, parseInt(selectedMonth) - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}</h3>` + monthlySummary;
                } else {
                    reportDisplay.innerHTML = `<p>No monthly summary found for ${new Date(selectedYear, parseInt(selectedMonth) - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}. Please generate it first from the "Month Closure" section.</p>`;
                }
            } else {
                reportDisplay.innerHTML = '<p>Please select a specific date or a month and year to view a report.</p>';
            }
        });

        // View Date Range Report
        viewDateRangeReportBtn.addEventListener('click', () => {
            const startDateStr = reportStartDateSelector.value;
            const endDateStr = reportEndDateSelector.value;

            if (!startDateStr || !endDateStr) {
                alert('Please select both start and end dates for the date range report.');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            if (startDate > endDate) {
                alert('Start date cannot be after end date.');
                return;
            }

            let allTransactionsInDateRange = [];
            let totalGrossCommissionRange = 0;

            // Iterate through dates from start to end, inclusive
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = formatDate(d);
                const dailyData = localStorage.getItem(DAILY_COMMISSION_KEY_PREFIX + dateKey);
                if (dailyData) {
                    const transactions = JSON.parse(dailyData);
                    transactions.forEach(t => {
                        allTransactionsInDateRange.push({ date: dateKey, ...t });
                        totalGrossCommissionRange += t.totalCommission;
                    });
                }
            }

            const { hoDeduction, remainingCommission, taxDeduction, netCommission } = calculateDeductions(totalGrossCommissionRange);

            let reportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Commission Report (${startDateStr} to ${endDateStr})</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1, h2, h3 { text-align: center; color: #2c3e50; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; }
                        th { background-color: #f2f2f2; color: #333; }
                        .report-summary { margin-top: 30px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #f9f9f9; }
                        .report-summary div { margin-bottom: 8px; font-size: 1.1em; display: flex; justify-content: space-between; }
                        .report-summary div strong { color: #333; }
                        .report-summary div span { color: #007bff; font-weight: bold; }
                        .developer-info { text-align: center; margin-top: 50px; font-size: 0.8em; color: #555; border-top: 1px solid #eee; padding-top: 10px;}
                        .developer-info a { color: #555; text-decoration: none; }
                        @media print {
                            body { margin: 0; padding: 0; }
                            .report-summary { border: none; background-color: transparent; padding: 0; margin-top: 15px; font-size: 0.9em; }
                            .report-summary div { margin-bottom: 4px; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            thead { display: table-header-group; }
                            tfoot { display: table-footer-group; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Darson Securities Limited</h1>
                    <h2>Commission Report</h2>
                    <h3>Report for Date Range: ${startDateStr} to ${endDateStr}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Stock Name</th>
                                <th>Quantity</th>
                                <th>Rate (PKR)</th>
                                <th>Comm. per Stock (PKR)</th>
                                <th>Total Comm. (PKR)</th>
                            </tr>
                        </thead>
                        <tbody>`;

            if (allTransactionsInDateRange.length === 0) {
                reportContent += `<tr><td colspan="6" style="text-align: center;">No transactions found for this date range.</td></tr>`;
            } else {
                allTransactionsInDateRange.forEach(t => {
                    reportContent += `
                        <tr>
                            <td>${t.date}</td>
                            <td>${t.stockName}</td>
                            <td>${t.quantity}</td>
                            <td>${t.rate.toFixed(2)}</td>
                            <td>${t.commissionPerStock.toFixed(2)}</td>
                            <td>${t.totalCommission.toFixed(2)}</td>
                        </tr>`;
                });
            }

            reportContent += `
                        </tbody>
                    </table>
                    <div class="report-summary">
                        <div><strong>Gross Commission:</strong> <span>${totalGrossCommissionRange.toFixed(2)} PKR</span></div>
                        <div><strong>Head Office Deduction (40%):</strong> <span>${hoDeduction.toFixed(2)} PKR</span></div>
                        <div><strong>Remaining Commission:</strong> <span>${remainingCommission.toFixed(2)} PKR</span></div>
                        <div><strong>Tax Deduction (12%):</strong> <span>${taxDeduction.toFixed(2)} PKR</span></div>
                        <div><strong>Net Commission:</strong> <span>${netCommission.toFixed(2)} PKR</span></div>
                    </div>
                    <div class="developer-info">
                        Developed by Afrasiab Asghar | <a href="http://www.Nextgensites.org" target="_blank">www.Nextgensites.org</a> | Contact +923060406003
                    </div>
                </body>
                </html>
            `;

            const newWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
            newWindow.document.write(reportContent);
            newWindow.document.close();
            newWindow.focus(); // Bring the new window to front
        });


        // Print the currently displayed report
        printReportBtn.addEventListener('click', () => {
            window.print();
        });

        // Securely delete reports
        deleteReportBtn.addEventListener('click', () => {
            const password = deletePasswordInput.value;
            if (password !== AUTH_PASSWORD) {
                alert('Incorrect password. Report deletion failed.');
                return;
            }

            const selectedDate = reportDateSelector.value;
            const selectedMonth = reportMonthSelector.value;
            const selectedYear = reportYearSelector.value;

            if (selectedDate) {
                if (confirm(`Are you sure you want to delete the daily report for ${selectedDate}? This action cannot be undone.`)) {
                    localStorage.removeItem(DAILY_COMMISSION_KEY_PREFIX + selectedDate);
                    reportDisplay.innerHTML = `<p>Report for ${selectedDate} has been deleted.</p>`;
                    alert('Daily report deleted successfully!');
                    updateDashboardBalances(); // Update balances after deletion
                }
            } else if (selectedMonth && selectedYear) {
                if (confirm(`Are you sure you want to delete the monthly summary for ${selectedMonth}/${selectedYear}? This action cannot be undone.`)) {
                    const monthKey = `${selectedYear}-${selectedMonth}`;
                    localStorage.removeItem(MONTHLY_SUMMARY_KEY_PREFIX + monthKey);
                    reportDisplay.innerHTML = `<p>Monthly summary for ${selectedMonth}/${selectedYear} has been deleted.</p>`;
                    alert('Monthly summary deleted successfully!');
                }
            } else {
                alert('Please select a specific date or a month and year to delete a report.');
            }
            deletePasswordInput.value = ''; // Clear password field
        });

        // Payment History Form Submission
        addPaymentRecordBtn.addEventListener('click', () => {
            const date = paymentDateInput.value;
            const requested = parseFloat(paymentRequestedInput.value || 0);
            const approved = parseFloat(paymentApprovedInput.value || 0);
            const paid = parseFloat(paymentPaidInput.value || 0);

            if (!date) {
                alert('Please enter a date for the payment record.');
                return;
            }

            const payments = JSON.parse(localStorage.getItem(PAYMENT_HISTORY_KEY) || '[]');
            const existingPaymentIndex = payments.findIndex(p => p.date === date);

            let oldPaidAmountForThisDate = 0;
            if (existingPaymentIndex > -1) {
                oldPaidAmountForThisDate = payments[existingIndex].paid || 0;
            }

            let globalAccumulatedBalance = parseFloat(localStorage.getItem(CURRENT_BALANCE_KEY) || 0);

            // Calculate balanceBefore and balanceAfter for the payment record itself
            // balanceBefore should be the global balance *before* this specific payment's 'paid' amount is applied.
            // So, we temporarily add back the old paid amount (if updating) to get the true balance before this transaction.
            const balanceBeforePayment = globalAccumulatedBalance + oldPaidAmountForThisDate;

            // Now, deduct the new paid amount from the global balance
            globalAccumulatedBalance = balanceBeforePayment - paid;
            localStorage.setItem(CURRENT_BALANCE_KEY, globalAccumulatedBalance.toFixed(2));

            const newPayment = {
                date: date,
                requested: requested,
                approved: approved,
                paid: paid,
                balanceBefore: balanceBeforePayment,
                balanceAfter: globalAccumulatedBalance // This is the new global balance after this payment
            };

            addPaymentRecord(newPayment); // This function handles adding or updating the record in payment history

            updateDashboardBalances(); // This will refresh the dashboard's previous/current balance
            alert('Payment record added/updated successfully and global balance adjusted!');

            // Clear form fields
            paymentRequestedInput.value = '';
            paymentApprovedInput.value = '';
            paymentPaidInput.value = '';
            paymentDateInput.value = formatDate(new Date()); // Reset to today's date
        });


        // Month Closure Functionality
        generateMonthlySummaryBtn.addEventListener('click', () => {
            const month = closeMonthSelector.value;
            const year = closeYearSelector.value;

            if (!month || !year) {
                alert('Please select a month and year for month closure.');
                return;
            }

            const monthKey = `${year}-${month}`;
            let totalMonthNetCommission = 0;
            let transactionDaysCount = 0;
            let firstDayOfMonth = new Date(year, parseInt(month) - 1, 1);
            let lastDayOfMonth = new Date(year, parseInt(month), 0);

            let monthlySummaryHtml = `<h4>Detailed Monthly Summary for ${new Date(year, parseInt(month) - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}</h4>`;
            monthlySummaryHtml += `<table><thead><tr><th>Date</th><th>Gross Comm.</th><th>HO Deduction</th><th>Tax</th><th>Net Comm.</th></tr></thead><tbody>`;

            let hasTransactionsInMonth = false;

            for (let d = new Date(firstDayOfMonth); d <= lastDayOfMonth; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dailyData = localStorage.getItem(DAILY_COMMISSION_KEY_PREFIX + dateStr);
                if (dailyData) {
                    const transactions = JSON.parse(dailyData);
                    if (transactions.length > 0) {
                        hasTransactionsInMonth = true;
                        transactionDaysCount++;
                        let dailyGrossCommission = transactions.reduce((sum, t) => sum + t.totalCommission, 0);
                        const { hoDeduction, remainingCommission, taxDeduction, netCommission } = calculateDeductions(dailyGrossCommission);
                        totalMonthNetCommission += netCommission;

                        monthlySummaryHtml += `<tr>
                            <td>${dateStr}</td>
                            <td>${dailyGrossCommission.toFixed(2)}</td>
                            <td>${hoDeduction.toFixed(2)}</td>
                            <td>${taxDeduction.toFixed(2)}</td>
                            <td>${netCommission.toFixed(2)}</td>
                        </tr>`;
                    }
                }
            }
            monthlySummaryHtml += `</tbody></table>`;

            if (!hasTransactionsInMonth) {
                monthlySummaryHtml = `<p>No daily commission data found for ${new Date(year, parseInt(month) - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}.</p>`;
            } else {
                // Overall summary for the month
                monthlySummaryHtml += `<div class="report-summary">
                    <p><strong>Total Days with Transactions:</strong> <span>${transactionDaysCount}</span></p>
                    <p><strong>Total Net Commission for the Month:</strong> <span>${totalMonthNetCommission.toFixed(2)} PKR</span></p>
                </div>`;
            }


            monthlySummaryDisplay.innerHTML = monthlySummaryHtml;
            // Save the generated monthly summary HTML for later viewing in reports
            localStorage.setItem(MONTHLY_SUMMARY_KEY_PREFIX + monthKey, monthlySummaryHtml);

            if (hasTransactionsInMonth) {
                alert('Monthly summary generated and saved!');
            }
        });

        // Settings: Save Manual Previous Balance
        saveManualBalanceBtn.addEventListener('click', () => {
            const password = settingsPasswordInput.value;
            if (password !== AUTH_PASSWORD) {
                alert('Incorrect password. Manual balance update failed.');
                return;
            }

            const newBalance = parseFloat(manualPreviousBalanceInput.value);
            if (isNaN(newBalance)) {
                alert('Please enter a valid number for the new balance.');
                return;
            }

            if (confirm(`Are you sure you want to set the global accumulated balance to ${formatCurrency(newBalance)}? This will override previous calculations.`)) {
                localStorage.setItem(CURRENT_BALANCE_KEY, newBalance.toFixed(2));
                alert('Global accumulated balance updated successfully!');
                settingsPasswordInput.value = ''; // Clear password
                manualPreviousBalanceInput.value = ''; // Clear input
                updateDashboardBalances(); // Refresh dashboard display based on new global balance
            }
        });

        // Reset Software Functionality (moved to settings section)
        confirmResetBtn.addEventListener('click', () => {
            const password = resetPasswordInput.value;
            if (password !== AUTH_PASSWORD) {
                alert('Incorrect password. Software reset aborted.');
                return;
            }

            if (confirm('Are you absolutely sure you want to reset ALL software data? This action is irreversible and will delete all commissions, payments, and balances.')) {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(LOCAL_STORAGE_PREFIX)) {
                        localStorage.removeItem(key);
                        i--; // Adjust index as item is removed
                    }
                }
                alert('All software data has been reset successfully!');
                window.location.reload(); // Reload the page to reflect the reset state
            }
            resetPasswordInput.value = ''; // Clear password field
        });

        // Login Logic
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (username === AUTH_USERNAME && password === AUTH_PASSWORD) {
                localStorage.setItem('loggedIn', 'true');
                loginError.textContent = '';
                document.body.classList.remove('logged-out');
                document.body.classList.add('logged-in');
                initializeUI(); // Initialize the main application UI
            } else {
                loginError.textContent = 'Invalid username or password.';
            }
        });

        // Logout Logic
        logoutButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('loggedIn');
                document.body.classList.remove('logged-in');
                document.body.classList.add('logged-out');
                usernameInput.value = '';
                passwordInput.value = '';
                loginError.textContent = '';
                showSection('dashboard-section'); // Reset to dashboard view on logout
            }
        });

        // Theme Toggle Logic
        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem(THEME_PREFERENCE_KEY, isDarkMode ? 'dark' : 'light');
            themeToggleBtn.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
        });

        /**
         * Initializes the main application UI components and data.
         * This function is called after successful login or on page load if already logged in.
         */
        function initializeUI() {
            const today = new Date();
            const todayFormatted = formatDate(today);
            currentDateSpan.textContent = todayFormatted;
            dashboardDateSelector.value = todayFormatted;

            reportDateSelector.value = todayFormatted;
            reportStartDateSelector.value = todayFormatted;
            reportEndDateSelector.value = todayFormatted;

            ensureGlobalBalanceExists();
            loadDailyTransactions(todayFormatted);

            const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
            const currentYear = today.getFullYear();
            reportMonthSelector.value = currentMonth;
            reportYearSelector.value = currentYear;
            closeMonthSelector.value = currentMonth;
            closeYearSelector.value = currentYear;

            paymentDateInput.value = todayFormatted;

            // Apply saved theme preference
            const savedTheme = localStorage.getItem(THEME_PREFERENCE_KEY);
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleBtn.textContent = 'Dark Mode';
            }

            showSection('dashboard-section'); // Show dashboard by default after login
        }

        // Initial check on window load
        window.onload = () => {
            if (localStorage.getItem('loggedIn') === 'true') {
                document.body.classList.add('logged-in');
                initializeUI();
            } else {
                document.body.classList.add('logged-out');
                loginPage.style.display = 'flex'; // Ensure login page is visible
                appContainer.style.display = 'none'; // Ensure app is hidden
            }
        };

    </script>
</body>
</html>