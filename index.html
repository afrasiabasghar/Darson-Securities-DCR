<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darson Securities Commission Software</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* General body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            color: #333; /* Dark gray text */
        }

        /* Navigation styling */
        nav {
            background-color: #1a3b5d; /* Darson blue */
            color: white;
        }
        nav a, nav button {
            transition: background-color 0.3s ease, color 0.3s ease;
            border-radius: 0.375rem; /* md */
        }
        nav a:hover, nav button:hover, nav a.active, nav button.active {
            background-color: #2a5282; /* Slightly lighter blue */
            color: #e0f2fe; /* Light cyan */
        }
        .nav-icon {
            margin-right: 0.5rem; /* space between icon and text */
        }

        /* Page container styling */
        .page-container {
            background-color: white;
            border-radius: 0.75rem; /* lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Tailwind shadow-lg */
            padding: 1.5rem; /* p-6 */
            margin-top: 1.5rem; /* mt-6 */
        }
        .page-title {
            color: #1a3b5d; /* Darson blue */
            border-bottom: 2px solid #2a5282;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* Form elements styling */
        input[type="text"], input[type="number"], input[type="date"], input[type="password"], input[type="email"], input[type="month"], select, textarea {
            border: 1px solid #cbd5e1; /* cool-gray-300 */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* md */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="month"]:focus, select:focus, textarea:focus {
            border-color: #2a5282; /* Darson blue */
            box-shadow: 0 0 0 3px rgba(42, 82, 130, 0.2); /* Darson blue focus ring */
            outline: none;
        }
        label {
            font-weight: 500; /* medium */
            color: #4a5568; /* cool-gray-700 */
        }

        /* Button styling */
        .btn {
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.375rem; /* md */
            font-weight: 500; /* medium */
            transition: background-color 0.3s ease, transform 0.1s ease;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background-color: #1a3b5d; /* Darson blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2a5282; /* Lighter Darson blue */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* cool-gray-200 */
            color: #1a3b5d; /* Darson blue */
            border: 1px solid #cbd5e1; /* cool-gray-300 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* cool-gray-300 */
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #e53e3e; /* red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #c53030; /* red-700 */
            transform: translateY(-1px);
        }
        .btn-icon {
            padding: 0.5rem;
        }
        .bill-preview-img.selected {
            border: 3px solid #2a5282; /* Darson Blue */
            box-shadow: 0 0 10px rgba(42, 82, 130, 0.5);
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem; /* py-3 px-4 */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* cool-gray-200 */
        }
        th {
            background-color: #f8fafc; /* cool-gray-50 */
            font-weight: 600; /* semibold */
            color: #374151; /* cool-gray-700 */
        }
        tbody tr:hover {
            background-color: #f9fafb; /* cool-gray-50 slightly different for hover */
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto; /* For long modals */
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem; /* lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            width: 90%;
            max-width: 500px; /* Default max-width */
        }
        .modal-content.modal-lg {
            max-width: 800px;
        }
        .modal-title {
            font-size: 1.25rem; /* xl */
            font-weight: 600; /* semibold */
            margin-bottom: 1rem;
            color: #1a3b5d;
        }

        /* Print-specific styles */
        .print-only { display: none; }
        @media print {
            body {
                background-color: white;
                color: black;
                font-size: 10pt; /* Smaller font for print */
                margin: 0;
                padding: 0;
                padding-bottom: 50px; /* Space for the fixed footer */
            }
            nav, .no-print, #sidebar, .modal {
                display: none !important;
            }
            .page-container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                width: 100% !important;
                max-width: 100% !important;
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
            }
            .print-header h1 { font-size: 18pt; font-weight: bold; margin: 0; color: black !important; }
            .print-header h2 { font-size: 14pt; margin: 0; color: black !important; }
            .print-header p { font-size: 10pt; margin: 5px 0; color: black !important; }
            .print-footer {
                display: block !important;
                text-align: center;
                font-size: 8pt;
                position: fixed;
                bottom: 10px;
                left: 0;
                right: 0;
                width: 100%;
                color: black !important;
            }
            table {
                font-size: 9pt;
                border: 1px solid #ccc !important; /* Add borders for tables in print */
            }
            th, td { 
                border: 1px solid #ccc !important; 
                padding: 2px 4px; /* Reduced padding for smaller boxes */
            }
            th { background-color: #eee !important; color: black !important; }
            a { text-decoration: none; color: black; }
            img { max-width: 100% !important; page-break-inside: avoid; }
            .page-break-before { page-break-before: always; }
            .page-break-after { page-break-after: always; }
            @page { size: A4; margin: 0.75in; }
            
            .print-only { display: block; } /* Show print-only content */
            .printable-view {
                 margin: 0;
                 padding: 1in;
            }
        }
        .print-header, .print-footer {
            display: none; /* Hidden by default, shown by print styles */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="authPage" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-gray-900">Darson Securities</h2>
                <p class="mt-2 text-center text-sm text-gray-600">Sign in to your account</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="rounded-t-md" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="rounded-b-md" placeholder="Password">
                    </div>
                </div>
                 <p id="authError" class="text-red-500 text-sm mt-2 hidden"></p>
                <div>
                    <button type="submit" id="signInBtn" class="btn btn-primary w-full">Sign In</button>
                </div>
            </form>
            <div class="text-center">
                <p class="text-sm">
                    Don't have an account?
                    <a href="#" id="showSignUp" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</a>
                </p>
            </div>

             <form id="signUpForm" class="mt-8 space-y-6 hidden">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="signUpEmail" class="sr-only">Email address</label>
                        <input id="signUpEmail" type="email" required class="rounded-t-md" placeholder="Email address">
                    </div>
                    <div>
                        <label for="signUpPassword" class="sr-only">Password</label>
                        <input id="signUpPassword" type="password" required class="border-t-0 rounded-b-md" placeholder="Password (min. 6 characters)">
                    </div>
                </div>
                <p id="signUpError" class="text-red-500 text-sm mt-2 hidden"></p>
                <div>
                     <button type="submit" id="signUpBtn" class="btn btn-primary w-full">Sign Up</button>
                </div>
            </form>
            <div id="backToLoginDiv" class="text-center hidden">
                 <p class="text-sm">
                    Already have an account?
                    <a href="#" id="showLogin" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                </p>
            </div>

        </div>
    </div>


    <div id="app" class="hidden flex-col min-h-screen">
        <nav id="sidebar" class="p-4 shadow-md">
            <div class="container mx-auto flex flex-wrap items-center justify-between">
                <div class="text-2xl font-bold">Darson Securities</div>
                <button id="mobileMenuButton" class="md:hidden p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                    <i class="fas fa-bars"></i>
                </button>
                <div id="navLinks" class="hidden md:flex md:items-center md:space-x-3 w-full md:w-auto mt-4 md:mt-0">
                    <a href="#" class="block md:inline-block px-3 py-2 active" data-page="dashboard"><i class="fas fa-tachometer-alt nav-icon"></i>Dashboard</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="employees"><i class="fas fa-users nav-icon"></i>Employees</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="reports"><i class="fas fa-chart-line nav-icon"></i>Reports</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="balanceTracking"><i class="fas fa-balance-scale nav-icon"></i>Balance Tracking</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="paymentRequests"><i class="fas fa-file-invoice-dollar nav-icon"></i>Payment Requests</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="courierTracking"><i class="fas fa-truck nav-icon"></i>Courier Tracking</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="branchBudget"><i class="fas fa-landmark nav-icon"></i>Branch Budget</a>
                    <button id="logoutBtn" class="block md:inline-block px-3 py-2 text-left w-full md:w-auto"><i class="fas fa-sign-out-alt nav-icon"></i>Logout</button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-4 flex-grow">
            <div class="print-header">
                <h1>Darson Securities Limited</h1>
                <h2 id="printReportTitle">Commission Report</h2>
                <p>Date: <span id="printReportDate"></span></p>
            </div>

            <div id="dashboardPage" class="page-container">
                <h2 class="text-2xl font-semibold mb-6 page-title">Commission Calculator</h2>
                <div class="mb-6 p-4 border rounded-lg bg-indigo-50">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-700">Select Date for Transactions</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="dashboardDateInput" class="block text-sm font-medium text-gray-700">Transaction Date:</label>
                            <input type="date" id="dashboardDateInput" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="loadDashboardDateBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-calendar-day mr-2"></i>Load/Refresh</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="stockName" class="block text-sm font-medium text-gray-700">Stock Name</label>
                        <input type="text" id="stockName" class="mt-1 p-2 border rounded-md w-full">
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="quantity" class="mt-1 p-2 border rounded-md w-full" min="0">
                    </div>
                    <div>
                        <label for="rate" class="block text-sm font-medium text-gray-700">Rate (PKR)</label>
                        <input type="number" id="rate" step="0.01" class="mt-1 p-2 border rounded-md w-full" min="0">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Commission per Stock</label>
                        <p id="commissionPerStock" class="mt-1 p-2 bg-gray-100 rounded-md">PKR 0.00</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Total Stock Commission</label>
                        <p id="totalStockCommission" class="mt-1 p-2 bg-gray-100 rounded-md">PKR 0.00</p>
                    </div>
                    <div class="flex items-end">
                        <button id="addTransactionBtn" class="btn btn-primary w-full"><i class="fas fa-plus-circle mr-2"></i>Add Transaction</button>
                    </div>
                </div>
                <h3 class="text-xl font-semibold mb-4 mt-8">Transactions for <span id="currentDateDisplay"></span></h3>
                <div class="overflow-x-auto mb-6">
                    <table id="dailyTransactionsTable" class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">Stock Name</th>
                                <th class="py-2 px-4 border-b">Quantity</th>
                                <th class="py-2 px-4 border-b">Rate</th>
                                <th class="py-2 px-4 border-b">Comm. per Stock</th>
                                <th class="py-2 px-4 border-b">Total Comm.</th>
                                <th class="py-2 px-4 border-b no-print">Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="dailySummary" class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="text-lg font-semibold mb-2">Summary for <span id="summaryDateDisplay"></span></h4>
                    <p>Gross Commission: <span id="dailyGrossCommission" class="font-bold">PKR 0.00</span></p>
                    <p>Head Office Deduction (40%): <span id="dailyHODeduction" class="font-bold">PKR 0.00</span></p>
                    <p>Tax Deduction (12% of remaining): <span id="dailyTaxDeduction" class="font-bold">PKR 0.00</span></p>
                    <p class="text-blue-600">Final House Commission: <span id="dailyFinalHouseCommission" class="font-bold text-xl">PKR 0.00</span></p>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="saveDayTransactionsBtn" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save Transactions</button>
                    <button id="printDayTransactionsBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Report</button>
                </div>
            </div>

            <div id="employeesPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Employee Management</h2>
                <form id="employeeForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Add New Employee</h3>
                    <input type="hidden" id="employeeId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="employeeName" class="block text-sm font-medium">Full Name</label>
                            <input type="text" id="employeeName" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="employeeDesignation" class="block text-sm font-medium">Designation</label>
                            <input type="text" id="employeeDesignation" class="mt-1 w-full" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="employeeAddress" class="block text-sm font-medium">Address</label>
                            <input type="text" id="employeeAddress" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="employeeCnic" class="block text-sm font-medium">CNIC</label>
                            <input type="text" id="employeeCnic" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="employeeJoiningDate" class="block text-sm font-medium">Joining Date</label>
                            <input type="date" id="employeeJoiningDate" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="employeePicture" class="block text-sm font-medium">Employee Picture</label>
                            <input type="file" id="employeePicture" accept="image/*" class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div>
                           <img id="employeePicturePreview" src="https://placehold.co/100x100/e2e8f0/e2e8f0?text=." alt="Picture Preview" class="mt-2 h-24 w-24 rounded-full object-cover border-2 border-gray-300">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-save mr-2"></i>Save Employee</button>
                    <button type="button" id="clearEmployeeFormBtn" class="btn btn-secondary mt-4 ml-2">Clear Form</button>
                </form>

                <h3 class="text-xl font-semibold mb-4">Saved Employees</h3>
                <div id="employeeList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="reportsPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Reports</h2>
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3">View Daily Report</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="reportDate" class="block text-sm font-medium text-gray-700">Select Date:</label>
                            <input type="date" id="reportDate" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="viewDailyReportBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-eye mr-2"></i>View Report</button>
                        <button id="printDailyReportBtn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-print mr-2"></i>Print Report</button>
                        <button id="deleteDailyReportBtn" class="btn btn-danger w-full sm:w-auto"><i class="fas fa-trash-alt mr-2"></i>Delete Report</button>
                    </div>
                </div>
                <div id="dailyReportDisplay" class="mt-6 hidden"></div>
                <div class="my-8 border-t pt-8"></div>
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3">View Monthly Report</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                         <div class="flex-grow">
                            <label for="reportMonth" class="block text-sm font-medium text-gray-700">Select Month:</label>
                            <input type="month" id="reportMonth" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="viewMonthlyReportBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-calendar-alt mr-2"></i>View Report</button>
                        <button id="printMonthlyReportBtn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-print mr-2"></i>Print Report</button>
                         <button id="deleteMonthlyReportBtn" class="btn btn-danger w-full sm:w-auto"><i class="fas fa-trash-alt mr-2"></i>Delete Report</button>
                    </div>
                </div>
                <div id="monthlyReportDisplay" class="mt-6 hidden"></div>
            </div>

            <div id="balanceTrackingPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Balance Tracking & Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="p-6 bg-blue-50 rounded-lg shadow">
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">Overall Balance</h3>
                            <p id="currentOverallBalance" class="text-3xl font-bold text-blue-800">PKR 0.00</p>
                        </div>
                        <div class="p-6 bg-green-50 rounded-lg shadow">
                            <h3 class="text-xl font-semibold text-green-700 mb-2">Manual Balance Adjustment</h3>
                             <label for="manualCommissionAmount" class="block text-sm font-medium text-gray-700">Add/Subtract Amount:</label>
                            <input type="number" id="manualCommissionAmount" step="0.01" class="mt-1 mb-2 p-2 border rounded-md w-full" placeholder="Enter amount (e.g., 1000 or -500)">
                            <label for="manualCommissionReason" class="block text-sm font-medium text-gray-700">Reason:</label>
                            <input type="text" id="manualCommissionReason" class="mt-1 mb-3 p-2 border rounded-md w-full" placeholder="e.g., Previous month's balance">
                            <button id="addManualCommissionBtn" class="btn btn-primary w-full"><i class="fas fa-plus-circle mr-2"></i>Adjust Balance</button>
                        </div>
                        <div class="p-6 bg-yellow-50 rounded-lg shadow">
                            <h3 class="text-xl font-semibold text-yellow-800 mb-3">End of Month Operations</h3>
                            <p class="text-sm text-gray-600 mb-3">Finalize the earnings for the current month.</p>
                            <button id="newMonthBtn" class="btn btn-primary"><i class="fas fa-calendar-check mr-2"></i>Finalize Current Month</button>
                            <p id="newMonthStatus" class="mt-2 text-sm text-gray-700"></p>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="p-6 bg-purple-50 rounded-lg shadow">
                            <h3 class="text-xl font-semibold text-purple-700 mb-3"><i class="fas fa-database mr-2"></i>Data Backup & Restore</h3>
                            <p class="text-sm text-gray-600 mb-4">Download all your application data into a file for backup.</p>
                            <button id="downloadDataBtn" class="btn btn-primary w-full mb-4"><i class="fas fa-download mr-2"></i>Download Data</button>
                            <p class="text-sm text-gray-600 mb-2">Restore data from a previously downloaded backup file. This will overwrite all current data.</p>
                            <input type="file" id="restoreDataInput" accept=".json" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-100 file:text-purple-700 hover:file:bg-purple-200">
                             <button id="restoreDataBtn" class="btn btn-secondary w-full mt-2"><i class="fas fa-upload mr-2"></i>Upload & Restore Data</button>
                        </div>
                         <div class="p-6 bg-red-50 border border-red-300 rounded-lg shadow">
                            <h3 class="text-xl font-semibold text-red-700 mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Danger Zone</h3>
                            <p class="text-sm text-gray-700 mb-4">Permanently delete all application data for your account. This action cannot be undone.</p>
                            <button id="resetApplicationDataBtn" class="btn btn-danger"><i class="fas fa-bomb mr-2"></i>Reset All My Data</button>
                        </div>
                    </div>
                </div>
                 <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">Balance Adjustment History</h3>
                    <div class="overflow-x-auto max-h-80">
                        <table id="balanceAdjustmentHistoryTable" class="min-w-full bg-white">
                            <thead><tr><th>Date</th><th>Reason</th><th>Amount</th><th>Type</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="paymentRequestsPage" class="page-container hidden">
                 <h2 class="text-2xl font-semibold mb-6 page-title">Payment Requests</h2>
                <form id="paymentRequestForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Create New Payment Request</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="paymentRequestDate" class="block text-sm font-medium">Request Date</label>
                            <input type="date" id="paymentRequestDate" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="paymentRequestAmount" class="block text-sm font-medium">Amount (PKR)</label>
                            <input type="number" id="paymentRequestAmount" class="mt-1 w-full" min="0.01" step="0.01" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="paymentRequestDescription" class="block text-sm font-medium">Description</label>
                            <textarea id="paymentRequestDescription" rows="3" class="mt-1 w-full" required></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-paper-plane mr-2"></i>Submit Request</button>
                </form>
                <div id="paymentRequestsSummary" class="mb-6 p-4 bg-indigo-50 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-3">Current Month Summary (<span id="paymentSummaryMonth"></span>)</h3>
                    <p>Total Requested: <span id="totalRequestedAmount" class="font-bold">PKR 0.00</span></p>
                    <p>Total Approved: <span id="totalApprovedAmount" class="font-bold">PKR 0.00</span></p>
                    <p>Total Paid: <span id="totalPaidAmount" class="font-bold">PKR 0.00</span></p>
                    <p>Unpaid Approved Amount: <span id="totalUnpaidApprovedAmount" class="font-bold">PKR 0.00</span></p>
                    <button id="carryOverPaymentBtn" class="btn btn-secondary mt-3 text-sm"><i class="fas fa-random mr-2"></i>Carry Over Unpaid Approved to Next Month Balance</button>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Payment Request History</h3>
                    <button id="printPaymentRequestsBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Requests</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="paymentRequestsTable" class="min-w-full bg-white">
                        <thead><tr><th>ID</th><th>Request Date</th><th>Amount</th><th>Description</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="courierTrackingPage" class="page-container hidden">
                 <h2 class="text-2xl font-semibold mb-6 page-title">Courier Tracking</h2>
                <form id="courierTrackingForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Add New Courier Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="courierType" class="block text-sm font-medium">Type</label>
                            <select id="courierType" class="mt-1 w-full"><option value="outgoing">Outgoing</option><option value="incoming">Incoming</option></select>
                        </div>
                        <div>
                            <label for="courierDateSent" class="block text-sm font-medium">Date Sent/Received</label>
                            <input type="date" id="courierDateSent" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="courierTrackingId" class="block text-sm font-medium">Tracking ID</label>
                            <input type="text" id="courierTrackingId" class="mt-1 w-full">
                        </div>
                         <div>
                            <label for="courierSenderName" class="block text-sm font-medium">Sender Name</label>
                            <input type="text" id="courierSenderName" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="courierReceiverName" class="block text-sm font-medium">Receiver Name</label>
                            <input type="text" id="courierReceiverName" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="courierDestination" class="block text-sm font-medium">Destination/Origin</label>
                            <input type="text" id="courierDestination" class="mt-1 w-full" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="courierStatus" class="block text-sm font-medium">Status</label>
                            <input type="text" id="courierStatus" class="mt-1 w-full" placeholder="e.g., Sent, In Transit, Delivered, Received" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="courierDescription" class="block text-sm font-medium">Description/Contents</label>
                            <textarea id="courierDescription" rows="2" class="mt-1 w-full"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-plus-circle mr-2"></i>Add Courier Entry</button>
                </form>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Courier Records</h3>
                    <button id="printCourierReportBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Courier Report</button>
                </div>
                 <div class="overflow-x-auto">
                    <table id="courierTrackingTable" class="min-w-full bg-white">
                        <thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Track ID</th><th>Sender</th><th>Receiver</th><th>Dest./Origin</th><th>Description</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="branchBudgetPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Branch Budget Management</h2>
                 <form id="branchBudgetForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Add New Budget Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="budgetEntryDate" class="block text-sm font-medium">Date</label>
                            <input type="date" id="budgetEntryDate" class="mt-1 w-full" required>
                        </div>
                        <div>
                             <label for="budgetEntryType" class="block text-sm font-medium">Type</label>
                            <select id="budgetEntryType" class="mt-1 w-full">
                                <option value="cash-out">Cash Out (Expense)</option>
                                <option value="cash-in">Cash In (Income)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="budgetItem" class="block text-sm font-medium">Item/Details</label>
                            <input type="text" id="budgetItem" class="mt-1 w-full" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="budgetAmount" class="block text-sm font-medium">Amount (PKR)</label>
                            <input type="number" id="budgetAmount" class="mt-1 w-full" min="0.01" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-save mr-2"></i>Save Entry</button>
                </form>

                <div class="my-8 border-t pt-8"></div>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3">View Monthly Budget Report</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                         <div class="flex-grow">
                            <label for="budgetReportMonth" class="block text-sm font-medium text-gray-700">Select Month:</label>
                            <input type="month" id="budgetReportMonth" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="viewMonthlyBudgetBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-calendar-alt mr-2"></i>View Report</button>
                    </div>
                </div>

                <div id="monthlyBudgetReportDisplay" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Budget Entries</h3>
                        <button id="printBudgetReportBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Report</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="branchBudgetTable" class="min-w-full bg-white">
                            <thead><tr><th>ID</th><th>Date</th><th>Type</th><th>Details</th><th>Amount</th><th class="action-column">Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="budgetSummary" class="mt-6 p-6 bg-gray-100 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-500">Total Cash In</p>
                                <p id="totalCashIn" class="text-2xl font-bold text-green-600">PKR 0.00</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Total Cash Out</p>
                                <p id="totalCashOut" class="text-2xl font-bold text-red-600">PKR 0.00</p>
                            </div>
                             <div>
                                <p class="text-sm text-gray-500">Remaining Balance</p>
                                <p id="remainingBudgetBalance" class="text-2xl font-bold text-blue-700">PKR 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="messageModal" class="modal hidden">
                <div class="modal-content">
                    <h3 id="messageModalTitle" class="modal-title">Notification</h3>
                    <p id="messageModalText" class="text-sm text-gray-700 my-4"></p>
                    <div id="messageModalButtons" class="mt-6 flex justify-end space-x-3">
                        <button id="messageModalOkBtn" class="btn btn-primary">OK</button>
                        <button id="messageModalCancelBtn" class="btn btn-secondary hidden">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="billPreviewModal" class="modal hidden">
                <div class="modal-content modal-lg"> 
                    <h3 id="billPreviewModalTitle" class="modal-title">Bill Preview</h3>
                     <p class="text-sm text-gray-500 mb-4">Click on a bill to select it for printing.</p>
                    <div id="billPreviewImagesContainer" class="my-4 flex flex-wrap justify-center gap-4 max-h-[60vh] overflow-y-auto bg-gray-100 p-2 rounded"></div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="printBillFromModalBtn" class="btn btn-secondary" disabled><i class="fas fa-print mr-2"></i>Print Selected Bill</button>
                        <button id="closeBillPreviewModalBtn" class="btn btn-primary">Close</button>
                    </div>
                </div>
            </div>
            
            <div id="employeeDetailModal" class="modal hidden">
                <div class="modal-content modal-lg">
                    <div class="flex justify-between items-start">
                        <h3 id="employeeDetailModalTitle" class="modal-title">Employee Profile</h3>
                        <div class="flex space-x-2 no-print">
                           <button id="printProfileFromModalBtn" class="btn btn-secondary btn-sm"><i class="fas fa-print mr-1"></i> Print Profile</button>
                           <button id="editEmployeeFromModalBtn" class="btn btn-secondary btn-sm"><i class="fas fa-edit mr-1"></i> Edit</button>
                           <button id="deleteEmployeeFromModalBtn" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt mr-1"></i> Delete</button>
                        </div>
                    </div>
                    
                    <div id="employeeProfileContent">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-4 border rounded-lg">
                            <div class="flex flex-col items-center md:col-span-1">
                                <img id="modalEmployeePicture" src="https://placehold.co/150x150/e2e8f0/e2e8f0?text=." alt="Employee Picture" class="w-32 h-32 rounded-full object-cover mb-4 border-4 border-gray-200">
                            </div>
                            <div class="md:col-span-2 space-y-2 text-sm">
                                <h4 id="modalEmployeeName" class="text-xl font-bold text-gray-800"></h4>
                                <p class="text-gray-600"><i class="fas fa-briefcase w-5 mr-2 text-gray-400"></i><span id="modalEmployeeDesignation"></span></p>
                                <p class="text-gray-600"><i class="fas fa-map-marker-alt w-5 mr-2 text-gray-400"></i><span id="modalEmployeeAddress"></span></p>
                                <p class="text-gray-600"><i class="fas fa-id-card w-5 mr-2 text-gray-400"></i><span id="modalEmployeeCnic"></span></p>
                                <p class="text-gray-600"><i class="fas fa-calendar-alt w-5 mr-2 text-gray-400"></i>Joined on <span id="modalEmployeeJoiningDate"></span></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                 <h4 class="text-md font-semibold mb-2 pt-2">Leave Management</h4>
                                 <form id="leaveForm" class="mb-4 p-3 border rounded-lg bg-gray-50 no-print">
                                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                         <div>
                                             <label for="leaveMonth" class="text-xs">Month</label>
                                             <input type="month" id="leaveMonth" class="mt-1 w-full text-sm p-1" required>
                                         </div>
                                         <div>
                                             <label for="leaveCount" class="text-xs">Leaves</label>
                                             <input type="number" id="leaveCount" min="0" class="mt-1 w-full text-sm p-1" required>
                                         </div>
                                         <div class="flex items-end">
                                             <button type="submit" class="btn btn-primary w-full text-xs py-1.5"><i class="fas fa-plus mr-1"></i>Add</button>
                                         </div>
                                     </div>
                                      <input type="hidden" id="leaveEmployeeId">
                                 </form>
                                 <div class="overflow-y-auto max-h-32">
                                     <table id="leaveHistoryTable" class="min-w-full bg-white text-xs">
                                         <thead><tr><th>Month</th><th>Leaves</th></tr></thead>
                                         <tbody></tbody>
                                     </table>
                                 </div>
                            </div>

                            <div>
                                <h4 class="text-md font-semibold mb-2 pt-2">Salary Management</h4>
                                <form id="salaryForm" class="mb-4 p-3 border rounded-lg bg-gray-50 no-print">
                                    <input type="hidden" id="salaryEmployeeId">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div class="sm:col-span-2">
                                            <label for="salaryMonth" class="text-xs">Month</label>
                                            <input type="month" id="salaryMonth" class="mt-1 w-full text-sm p-1" required>
                                        </div>
                                        <div>
                                            <label for="salaryAmount" class="text-xs">Basic Salary</label>
                                            <input type="number" id="salaryAmount" class="mt-1 w-full text-sm p-1" required min="0">
                                        </div>
                                         <div>
                                            <label for="salaryAllowances" class="text-xs">Allowances</label>
                                            <input type="number" id="salaryAllowances" class="mt-1 w-full text-sm p-1" value="0" min="0">
                                        </div>
                                         <div>
                                            <label for="salaryIncentives" class="text-xs">Incentives</label>
                                            <input type="number" id="salaryIncentives" class="mt-1 w-full text-sm p-1" value="0" min="0">
                                        </div>
                                        <div class="flex items-end">
                                            <button type="submit" class="btn btn-primary w-full text-xs py-1.5"><i class="fas fa-plus mr-1"></i>Add Salary</button>
                                        </div>
                                    </div>
                                </form>
                                <div class="overflow-y-auto max-h-32">
                                    <table id="salaryHistoryTable" class="min-w-full bg-white text-xs">
                                        <thead><tr><th>Month</th><th>Total</th><th>Status</th><th class="no-print">Actions</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3 no-print">
                        <button id="closeEmployeeDetailModalBtn" class="btn btn-primary">Close</button>
                    </div>
                </div>
            </div>


            <div class="print-footer">
                <p>Developed by Afrasiab Asghar. Visit www.nextgensites.org or Contact +923060406003</p>
            </div>
        </main>
        
        <div>
            <div id="salarySlipPrintView" class="print-only printable-view">
                 <div class="p-8 border-2 border-black" style="font-family: Arial, sans-serif; ">
                    <header class="text-center mb-8 pb-4 border-b-2 border-black">
                        <h1 class="text-3xl font-bold text-black">Darson Securities Limited</h1>
                        <p class="text-lg text-black">Sargodha Branch</p>
                        <h2 class="text-2xl font-semibold mt-4 text-black">Salary Slip</h2>
                    </header>
                    <section class="mb-6 text-sm">
                        <div class="grid grid-cols-2 gap-x-8">
                            <div>
                                <p><strong>Employee Name:</strong> <span id="slipEmployeeName"></span></p>
                                <p><strong>Designation:</strong> <span id="slipEmployeeDesignation"></span></p>
                                 <p><strong>Address:</strong> <span id="slipEmployeeAddress"></span></p>
                            </div>
                            <div>
                                <p><strong>Salary Month:</strong> <span id="slipSalaryMonth"></span></p>
                                <p><strong>Print Date:</strong> <span id="slipPrintDate"></span></p>
                                 <p><strong>CNIC:</strong> <span id="slipEmployeeCnic"></span></p>
                            </div>
                        </div>
                    </section>
                    <table class="w-full border-collapse border border-black text-black">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border border-black p-2 text-left">Earnings</th>
                                <th class="border border-black p-2 text-right">Amount (PKR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-black p-2">Basic Salary</td>
                                <td class="border border-black p-2 text-right" id="slipBasicSalary"></td>
                            </tr>
                            <tr>
                                <td class="border border-black p-2">Allowances</td>
                                <td class="border border-black p-2 text-right" id="slipAllowances"></td>
                            </tr>
                             <tr>
                                <td class="border border-black p-2">Incentives</td>
                                <td class="border border-black p-2 text-right" id="slipIncentives"></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-bold bg-gray-100">
                                <td class="border border-black p-2 text-left">Net Salary Payable</td>
                                <td class="border border-black p-2 text-right" id="slipNetSalary"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="mt-16 flex justify-between items-end">
                        <div class="text-center">
                            <p class="border-t border-black pt-1 mt-8 w-48">Employee Signature</p>
                        </div>
                        <div class="text-center">
                            <p class="border-t border-black pt-1 mt-8 w-48">Accounts Department</p>
                        </div>
                    </div>
                     <footer class="text-center text-xs text-gray-600 mt-12">
                         This is a computer-generated slip and does not require a signature.
                     </footer>
                </div>
            </div>
            
            <div id="employeeProfilePrintView" class="print-only printable-view">
                 </div>
        </div>


        <footer class="bg-gray-800 text-white text-center p-4 no-print">
            <p>&copy; <span id="currentYear"></span> Darson Securities Limited. All rights reserved.</p>
            <p class="text-sm text-gray-400">Developed by Afrasiab Asghar. Visit <a href="http://www.nextgensites.org" target="_blank" class="underline hover:text-gray-200">www.nextgensites.org</a> or Contact +923060406003</p>
        </footer>
    </div>

    <script>
        // --- FIREBASE INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDldg1U88lHyTj0OM9bOimIpJIM_l34hjM",
            authDomain: "darsoncommision.firebaseapp.com",
            databaseURL: "https://darsoncommision-default-rtdb.firebaseio.com",
            projectId: "darsoncommision",
            storageBucket: "darsoncommision.appspot.com", // Corrected storage bucket URL
            messagingSenderId: "689239446260",
            appId: "1:689239446260:web:c0922d9971e5d9457e44a1"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();


        // --- UTILITY FUNCTIONS ---
        const Utils = {
            formatDateForStorage: (date) => {
                if (!date) return '';
                const d = new Date(date);
                const year = d.getFullYear();
                const month = ('0' + (d.getMonth() + 1)).slice(-2);
                const day = ('0' + d.getDate()).slice(-2);
                return `${year}-${month}-${day}`;
            },
            formatDateForDisplay: (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = ('0' + date.getUTCDate()).slice(-2);
                const month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
                const year = date.getUTCFullYear();
                return `${day}-${month}-${year}`;
            },
            formatMonthForDisplay: (monthString) => {
                if (!monthString) return '';
                const [year, month] = monthString.split('-');
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            },
            formatCurrency: (amount) => `PKR ${parseFloat(amount).toFixed(2)}`,
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9),
            showMessage: (title, message) => {
                document.getElementById('messageModalTitle').textContent = title;
                document.getElementById('messageModalText').textContent = message;
                document.getElementById('messageModalOkBtn').onclick = () => Utils.hideMessageModal();
                document.getElementById('messageModalCancelBtn').classList.add('hidden');
                document.getElementById('messageModal').classList.remove('hidden');
            },
            showConfirmationModal: (title, message, onOkCallback, onCancelCallback) => {
                document.getElementById('messageModalTitle').textContent = title;
                document.getElementById('messageModalText').textContent = message;
                const okBtn = document.getElementById('messageModalOkBtn');
                const cancelBtn = document.getElementById('messageModalCancelBtn');
                okBtn.onclick = () => { Utils.hideMessageModal(); if (onOkCallback) onOkCallback(); };
                cancelBtn.onclick = () => { Utils.hideMessageModal(); if (onCancelCallback) onCancelCallback(); };
                cancelBtn.classList.remove('hidden');
                document.getElementById('messageModal').classList.remove('hidden');
            },
            hideMessageModal: () => document.getElementById('messageModal').classList.add('hidden'),
            getTodayDateString: () => Utils.formatDateForStorage(new Date()),
            getCurrentMonthYearString: () => {
                const now = new Date();
                return `${now.getFullYear()}-${('0' + (now.getMonth() + 1)).slice(-2)}`;
            },
            compressImage: async (file) => {
                const options = {
                    maxSizeMB: 0.5, // Max file size 0.5MB
                    maxWidthOrHeight: 800, // Resize to 800px on the longest side
                    useWebWorker: true,
                };
                try {
                    console.log(`Original file size ${file.size / 1024 / 1024} MB`);
                    const compressedFile = await imageCompression(file, options);
                    console.log(`Compressed file size ${compressedFile.size / 1024 / 1024} MB`);
                    return compressedFile;
                } catch (error) {
                    console.error("Image compression error:", error);
                    // If compression fails, return the original file
                    return file;
                }
            },
        };
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- APPLICATION STATE AND DATA MANAGEMENT ---
        const AppState = {
            currentPage: 'dashboard',
            currentTransactions: [], 
            targetDateForDashboard: Utils.getTodayDateString(), 
            dailyDataCache: {}, 
            monthlyDataCache: {}, 
        };

        const FirebaseStorageService = {
            _getRef: (key) => {
                const user = auth.currentUser;
                if (!user) throw new Error("User not authenticated for DB operation.");
                return db.ref(`users/${user.uid}/${key}`);
            },
            getItem: async (key) => {
                try {
                    const snapshot = await FirebaseStorageService._getRef(key).once('value');
                    return snapshot.val(); // Returns the data or null if not found
                } catch (error) {
                    console.error("Firebase getItem Error:", error);
                    return null;
                }
            },
            setItem: (key, value) => {
                return FirebaseStorageService._getRef(key).set(value);
            },
            removeItem: (key) => {
                return FirebaseStorageService._getRef(key).remove();
            },
            getAllData: async () => {
                 const user = auth.currentUser;
                if (!user) return null;
                const snapshot = await db.ref(`users/${user.uid}`).once('value');
                return snapshot.val();
            },
            clearAllAppData: () => {
                const user = auth.currentUser;
                if (!user) return Promise.reject("No user logged in to clear data.");
                return db.ref(`users/${user.uid}`).remove();
            },
             restoreAllData: (data) => {
                const user = auth.currentUser;
                if (!user) return Promise.reject("No user logged in to restore data.");
                // The data from file has `users/UID/data` structure. We just need the `data` part.
                const userKey = `users/${user.uid}`;
                if (data[userKey]) {
                    return db.ref(userKey).set(data[userKey]);
                } else {
                     // Fallback for older backup format or differently structured JSON
                    return db.ref(`users/${user.uid}`).set(data);
                }
            }
        };
        
        // --- COMMISSION CALCULATION LOGIC ---
        const CommissionService = {
            calculateCommission: (rate, quantity) => {
                let commissionPerStockValue;
                rate = parseFloat(rate); quantity = parseInt(quantity);
                if (isNaN(rate) || isNaN(quantity) || rate <= 0 || quantity <= 0) return { commissionPerStock: 0, totalStockCommission: 0 };
                if (rate >= 0.01 && rate <= 3.00) commissionPerStockValue = 0.03;
                else if (rate >= 3.01 && rate <= 20.00) commissionPerStockValue = 0.07;
                else if (rate >= 20.01 && rate <= 40.00) commissionPerStockValue = 0.09;
                else if (rate >= 40.01 && rate <= 50.00) commissionPerStockValue = 0.12;
                else if (rate >= 50.01 && rate <= 90.00) commissionPerStockValue = 0.14;
                else if (rate >= 90.01 && rate <= 100.00) commissionPerStockValue = 0.17;
                else if (rate > 100.00) commissionPerStockValue = rate * 0.0017;
                else commissionPerStockValue = 0;
                return { commissionPerStock: commissionPerStockValue, totalStockCommission: commissionPerStockValue * quantity };
            },
            calculateDeductions: (grossCommission) => {
                const hoDeduction = grossCommission * 0.40;
                const remainingAfterHO = grossCommission - hoDeduction;
                const taxDeduction = remainingAfterHO * 0.12;
                const finalHouseCommission = remainingAfterHO - taxDeduction;
                return { grossCommission, hoDeduction, taxDeduction, finalHouseCommission };
            }
        };

        // --- UI RENDERING AND EVENT HANDLERS ---
        const UIController = {
            init: () => {
                // Navigation
                document.querySelectorAll('nav a[data-page]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault(); UIController.navigateTo(link.dataset.page);
                        document.querySelectorAll('nav a[data-page], nav button').forEach(l => l.classList.remove('active'));
                        link.classList.add('active'); 
                        const navLinks = document.getElementById('navLinks');
                        if (!navLinks.classList.contains('hidden')) {
                           navLinks.classList.add('hidden');
                        }
                    });
                });
                document.getElementById('mobileMenuButton').addEventListener('click', () => document.getElementById('navLinks').classList.toggle('hidden'));
                document.getElementById('logoutBtn').addEventListener('click', AuthController.signOut);

                // Set dates
                document.getElementById('dashboardDateInput').value = AppState.targetDateForDashboard; 
                document.getElementById('reportDate').value = Utils.getTodayDateString();
                document.getElementById('reportMonth').value = Utils.getCurrentMonthYearString();
                document.getElementById('budgetReportMonth').value = Utils.getCurrentMonthYearString();

                // Dashboard Listeners
                document.getElementById('dashboardDateInput').addEventListener('change', () => {
                    AppState.targetDateForDashboard = document.getElementById('dashboardDateInput').value || Utils.getTodayDateString();
                    UIController.loadTransactionsForDashboard(AppState.targetDateForDashboard);
                });
                document.getElementById('loadDashboardDateBtn').addEventListener('click', async () => {
                    const selectedDate = document.getElementById('dashboardDateInput').value || Utils.getTodayDateString();
                    await UIController.loadTransactionsForDashboard(selectedDate);
                });
                ['quantity', 'rate'].forEach(id => document.getElementById(id).addEventListener('input', UIController.updateDashboardCommissionDisplay));
                document.getElementById('addTransactionBtn').addEventListener('click', UIController.addTransactionToCurrentList);
                document.getElementById('saveDayTransactionsBtn').addEventListener('click', UIController.saveCurrentDayTransactions);
                document.getElementById('printDayTransactionsBtn').addEventListener('click', () => UIController.printReport('daily_current'));

                // Employees Page Listeners
                document.getElementById('employeeForm').addEventListener('submit', EmployeeController.handleAddOrUpdateEmployee);
                document.getElementById('employeePicture').addEventListener('change', EmployeeController.previewEmployeePicture);
                document.getElementById('clearEmployeeFormBtn').addEventListener('click', EmployeeController.clearForm);

                // Reports Page Listeners
                document.getElementById('viewDailyReportBtn').addEventListener('click', UIController.displayDailyReport);
                document.getElementById('printDailyReportBtn').addEventListener('click', () => UIController.printReport('daily_historical'));
                document.getElementById('deleteDailyReportBtn').addEventListener('click', async () => {
                     const d = document.getElementById('reportDate').value; if (!d) { Utils.showMessage('Input Required', 'Select date to delete.'); return; }
                     Utils.showConfirmationModal("Delete Report?", `Are you sure you want to delete the report for ${d}?`, async () => {
                        await FirebaseStorageService.removeItem(`transactions/${d}`);
                        delete AppState.dailyDataCache[d];
                        document.getElementById('dailyReportDisplay').innerHTML = `<p class="text-green-500">Report for ${Utils.formatDateForDisplay(d)} has been deleted.</p>`;
                        await BalanceTrackingController.updateOverallBalanceDisplay();
                        Utils.showMessage('Success', 'The report has been deleted.');
                     });
                });
                document.getElementById('viewMonthlyReportBtn').addEventListener('click', UIController.displayMonthlyReport);
                document.getElementById('printMonthlyReportBtn').addEventListener('click', () => UIController.printReport('monthly'));
                document.getElementById('deleteMonthlyReportBtn').addEventListener('click', async () => {
                    const m = document.getElementById('reportMonth').value; if (!m) { Utils.showMessage('Input Required', 'Select month to delete.'); return; }
                    Utils.showConfirmationModal("Delete Monthly Reports?", `All daily reports for ${Utils.formatMonthForDisplay(m)} will be deleted. This action cannot be undone.`, async () => {
                        const allTransactions = await FirebaseStorageService.getItem('transactions') || {};
                        let c = 0;
                        const updates = {};
                        Object.keys(allTransactions).forEach(dateKey => {
                            if (dateKey.startsWith(m)) {
                                updates[`transactions/${dateKey}`] = null; // Mark for deletion
                                c++;
                            }
                        });
                        await db.ref(`users/${auth.currentUser.uid}`).update(updates); // Perform multi-path delete
                        delete AppState.monthlyDataCache[m];
                        document.getElementById('monthlyReportDisplay').innerHTML = `<p class="text-green-500">Data for ${Utils.formatMonthForDisplay(m)} (${c} days) has been deleted.</p>`;
                        await BalanceTrackingController.updateOverallBalanceDisplay();
                        Utils.showMessage('Success', `${c} daily reports have been deleted.`);
                    });
                });

                // Balance Tracking & Settings Listeners
                document.getElementById('addManualCommissionBtn').addEventListener('click', BalanceTrackingController.addManualBalanceAdjustment);
                document.getElementById('newMonthBtn').addEventListener('click', BalanceTrackingController.finalizeCurrentMonth);
                document.getElementById('resetApplicationDataBtn').addEventListener('click', DataResetService.initiateFullResetProcess);
                document.getElementById('downloadDataBtn').addEventListener('click', DataResetService.downloadData);
                document.getElementById('restoreDataBtn').addEventListener('click', DataResetService.handleRestoreData);


                // Payment Requests Listeners
                document.getElementById('paymentRequestForm').addEventListener('submit', PaymentRequestController.handleAddRequest);
                document.getElementById('printPaymentRequestsBtn').addEventListener('click', () => UIController.printReport('paymentRequests'));
                document.getElementById('carryOverPaymentBtn').addEventListener('click', PaymentRequestController.carryOverUnpaidApproved);
                
                // Courier Tracking Listeners
                document.getElementById('courierTrackingForm').addEventListener('submit', CourierTrackingController.handleAddEntry);
                document.getElementById('printCourierReportBtn').addEventListener('click', () => UIController.printReport('courierTracking'));

                // Branch Budget Listeners
                document.getElementById('branchBudgetForm').addEventListener('submit', BranchBudgetController.handleAddEntry);
                document.getElementById('viewMonthlyBudgetBtn').addEventListener('click', BranchBudgetController.loadEntries);
                document.getElementById('printBudgetReportBtn').addEventListener('click', () => UIController.printReport('branchBudget'));


                // Employee Detail Modal Listeners
                document.getElementById('closeEmployeeDetailModalBtn').addEventListener('click', EmployeeController.hideEmployeeDetailModal);
                document.getElementById('salaryForm').addEventListener('submit', EmployeeController.handleAddSalaryRecord);
                document.getElementById('leaveForm').addEventListener('submit', EmployeeController.handleAddLeaveRecord);
                document.getElementById('editEmployeeFromModalBtn').addEventListener('click', EmployeeController.handleEditEmployeeFromModal);
                document.getElementById('deleteEmployeeFromModalBtn').addEventListener('click', EmployeeController.handleDeleteEmployeeFromModal);
                document.getElementById('printProfileFromModalBtn').addEventListener('click', EmployeeController.handlePrintProfileFromModal);
                
                UIController.navigateTo('dashboard'); 
            },

            navigateTo: async (pageId) => {
                document.querySelectorAll('.page-container').forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden'); AppState.currentPage = pageId;
                    if (pageId === 'dashboard') await UIController.loadTransactionsForDashboard(AppState.targetDateForDashboard); 
                    if (pageId === 'employees') await EmployeeController.loadEmployees();
                    if (pageId === 'balanceTracking') { await BalanceTrackingController.updateOverallBalanceDisplay(); await BalanceTrackingController.loadAdjustmentHistory(); }
                    if (pageId === 'paymentRequests') await PaymentRequestController.loadRequests();
                    if (pageId === 'courierTracking') await CourierTrackingController.loadEntries();
                    if (pageId === 'branchBudget') await BranchBudgetController.loadEntries(true); // Pass flag to prevent showing monthly report on initial load
                    if (pageId === 'reports') { document.getElementById('dailyReportDisplay').classList.add('hidden').innerHTML = ''; document.getElementById('monthlyReportDisplay').classList.add('hidden').innerHTML = ''; }
                } else console.error(`Page ${pageId}Page not found.`);
            },

            loadTransactionsForDashboard: async (dateString) => {
                AppState.targetDateForDashboard = dateString; 
                document.getElementById('dashboardDateInput').value = dateString; 
                const displayDate = Utils.formatDateForDisplay(dateString);
                const isToday = dateString === Utils.getTodayDateString();
                const dateLabel = `${displayDate} ${isToday ? '(Today)' : '(Selected Date)'}`;
                document.getElementById('currentDateDisplay').textContent = dateLabel;
                document.getElementById('summaryDateDisplay').textContent = displayDate;
                const data = await FirebaseStorageService.getItem(`transactions/${dateString}`);
                if (data && data.transactions) {
                    AppState.currentTransactions = data.transactions.map(tx => ({...tx, tempId: tx.tempId || Utils.generateId()}));
                } else {
                    AppState.currentTransactions = []; 
                }
                UIController.renderCurrentTransactionsTable(); 
                UIController.updateDailySummaryDisplay();    
                UIController.resetDashboardCalculatorFields(); 
            },

            updateDashboardCommissionDisplay: () => {
                const q = parseFloat(document.getElementById('quantity').value) || 0, r = parseFloat(document.getElementById('rate').value) || 0;
                const { commissionPerStock, totalStockCommission } = CommissionService.calculateCommission(r, q);
                document.getElementById('commissionPerStock').textContent = Utils.formatCurrency(commissionPerStock);
                document.getElementById('totalStockCommission').textContent = Utils.formatCurrency(totalStockCommission);
            },

            addTransactionToCurrentList: () => {
                const sn = document.getElementById('stockName').value.trim(), q = parseInt(document.getElementById('quantity').value), r = parseFloat(document.getElementById('rate').value);
                if (!sn || isNaN(q) || q <= 0 || isNaN(r) || r <= 0) { Utils.showMessage('Validation Error', 'Please enter a valid Stock Name, Quantity, and Rate.'); return; }
                const { commissionPerStock, totalStockCommission } = CommissionService.calculateCommission(r, q);
                AppState.currentTransactions.push({ 
                    tempId: Utils.generateId(), stockName: sn, quantity: q, rate: r, 
                    commissionPerStock, totalStockCommission, 
                    transactionTime: new Date().toLocaleTimeString() 
                });
                UIController.renderCurrentTransactionsTable(); 
                UIController.updateDailySummaryDisplay(); 
                UIController.resetDashboardCalculatorFields();
            },

            resetDashboardCalculatorFields: () => {
                document.getElementById('stockName').value = ''; document.getElementById('quantity').value = ''; document.getElementById('rate').value = '';
                document.getElementById('stockName').focus(); UIController.updateDashboardCommissionDisplay();
            },
            
            renderCurrentTransactionsTable: () => {
                const tbody = document.getElementById('dailyTransactionsTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
                if (AppState.currentTransactions.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No transactions for this date.</td></tr>'; return; }
                AppState.currentTransactions.forEach(tx => {
                    const row = tbody.insertRow(); 
                    row.insertCell().textContent = tx.stockName; row.insertCell().textContent = tx.quantity; 
                    row.insertCell().textContent = Utils.formatCurrency(tx.rate); row.insertCell().textContent = Utils.formatCurrency(tx.commissionPerStock); 
                    row.insertCell().textContent = Utils.formatCurrency(tx.totalStockCommission);
                    const ac = row.insertCell(); 
                    ac.classList.add('no-print');
                    const rmBtn = document.createElement('button'); 
                    rmBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; rmBtn.classList.add('btn', 'btn-danger', 'btn-icon', 'text-xs');
                    rmBtn.onclick = () => UIController.removeTransactionFromCurrentList(tx.tempId); 
                    ac.appendChild(rmBtn);
                });
            },

            removeTransactionFromCurrentList: (tempId) => { 
                AppState.currentTransactions = AppState.currentTransactions.filter(tx => tx.tempId !== tempId);
                UIController.renderCurrentTransactionsTable(); UIController.updateDailySummaryDisplay();
            },

            updateDailySummaryDisplay: () => { 
                const gc = AppState.currentTransactions.reduce((s, tx) => s + tx.totalStockCommission, 0);
                const d = CommissionService.calculateDeductions(gc);
                document.getElementById('dailyGrossCommission').textContent = Utils.formatCurrency(d.grossCommission);
                document.getElementById('dailyHODeduction').textContent = Utils.formatCurrency(d.hoDeduction);
                document.getElementById('dailyTaxDeduction').textContent = Utils.formatCurrency(d.taxDeduction);
                document.getElementById('dailyFinalHouseCommission').textContent = Utils.formatCurrency(d.finalHouseCommission);
            },

            saveCurrentDayTransactions: async () => {
                const targetDate = AppState.targetDateForDashboard;
                if (AppState.currentTransactions.length === 0) {
                     await FirebaseStorageService.removeItem(`transactions/${targetDate}`);
                     Utils.showMessage('Data Cleared', `All transactions for ${Utils.formatDateForDisplay(targetDate)} have been cleared.`);
                     await BalanceTrackingController.updateOverallBalanceDisplay();
                     return;
                }
                const grossCommission = AppState.currentTransactions.reduce((sum, tx) => sum + tx.totalStockCommission, 0);
                const deductions = CommissionService.calculateDeductions(grossCommission);
                const transactionsToSave = AppState.currentTransactions.map(tx => { const { tempId, ...rest } = tx; return { ...rest, transactionTime: tx.transactionTime || new Date().toLocaleTimeString() }; });
                const dailyReportDataToSave = { date: targetDate, transactions: transactionsToSave, ...deductions };
                await FirebaseStorageService.setItem(`transactions/${targetDate}`, dailyReportDataToSave);
                await BalanceTrackingController.updateOverallBalanceDisplay(); 
                Utils.showMessage('Success', `Transactions for ${Utils.formatDateForDisplay(targetDate)} have been saved.`);
            },

            displayDailyReport: async () => {
                const rd = document.getElementById('reportDate').value; if (!rd) { Utils.showMessage('Input Required', 'Please select a date.'); return; }
                const data = await FirebaseStorageService.getItem(`transactions/${rd}`), displayDiv = document.getElementById('dailyReportDisplay');
                if (!data) { displayDiv.innerHTML = `<p class="text-red-500">No data found for ${Utils.formatDateForDisplay(rd)}.</p>`; displayDiv.classList.remove('hidden'); return; }
                AppState.dailyDataCache[rd] = data;
                let html = `<h3 class="text-xl font-semibold mb-2">Daily Report for ${Utils.formatDateForDisplay(rd)}</h3><div class="overflow-x-auto"><table class="min-w-full bg-white mb-4"><thead><tr><th>Stock</th><th>Qty</th><th>Rate</th><th>Comm/S</th><th>Total Comm.</th><th>Time</th></tr></thead><tbody>`;
                (data.transactions || []).forEach(tx => { html += `<tr><td>${tx.stockName}</td><td>${tx.quantity}</td><td>${Utils.formatCurrency(tx.rate)}</td><td>${Utils.formatCurrency(tx.commissionPerStock)}</td><td>${Utils.formatCurrency(tx.totalStockCommission)}</td><td>${tx.transactionTime||'N/A'}</td></tr>`; });
                html += `</tbody></table></div><div class="p-4 bg-gray-100 rounded"><p>Gross: <span class="font-bold">${Utils.formatCurrency(data.grossCommission)}</span></p><p>HO Deduct: <span class="font-bold">${Utils.formatCurrency(data.hoDeduction)}</span></p><p>Tax: <span class="font-bold">${Utils.formatCurrency(data.taxDeduction)}</span></p><p class="text-blue-600">Final: <span class="font-bold text-xl">${Utils.formatCurrency(data.finalHouseCommission)}</span></p></div>`;
                displayDiv.innerHTML = html; displayDiv.classList.remove('hidden');
            },

            displayMonthlyReport: async () => {
                const rmy = document.getElementById('reportMonth').value; if (!rmy) { Utils.showMessage('Input Required', 'Please select a month.'); return; }
                const allTransactions = await FirebaseStorageService.getItem('transactions') || {};
                const reports = Object.values(allTransactions).filter(d => d && d.date && d.date.startsWith(rmy)).sort((a,b) => new Date(a.date) - new Date(b.date));
                const displayDiv = document.getElementById('monthlyReportDisplay');
                if (reports.length === 0) { displayDiv.innerHTML = `<p class="text-red-500">No data found for ${Utils.formatMonthForDisplay(rmy)}.</p>`; displayDiv.classList.remove('hidden'); return; }
                let tg=0, th=0, tt=0, tf=0; reports.forEach(d => { tg+=d.grossCommission||0; th+=d.hoDeduction||0; tt+=d.taxDeduction||0; tf+=d.finalHouseCommission||0; });
                AppState.monthlyDataCache[rmy] = { month: rmy, dailySummaries: reports, totalGross:tg, totalHO:th, totalTax:tt, totalFinal:tf };
                let html = `<h3 class="text-xl font-semibold mb-2">Monthly Report for ${Utils.formatMonthForDisplay(rmy)}</h3><div class="overflow-x-auto"><table class="min-w-full bg-white mb-4"><thead><tr><th>Date</th><th>Gross</th><th>HO</th><th>Tax</th><th>Final</th></tr></thead><tbody>`;
                reports.forEach(d => { html += `<tr><td>${Utils.formatDateForDisplay(d.date)}</td><td>${Utils.formatCurrency(d.grossCommission)}</td><td>${Utils.formatCurrency(d.hoDeduction)}</td><td>${Utils.formatCurrency(d.taxDeduction)}</td><td>${Utils.formatCurrency(d.finalHouseCommission)}</td></tr>`; });
                html += `</tbody></table></div><div class="p-4 bg-gray-100 rounded mt-4"><h4 class="text-lg font-semibold mb-2">Totals:</h4><p>Gross: <span class="font-bold">${Utils.formatCurrency(tg)}</span></p><p>HO: <span class="font-bold">${Utils.formatCurrency(th)}</span></p><p>Tax: <span class="font-bold">${Utils.formatCurrency(tt)}</span></p><p class="text-blue-600">Final: <span class="font-bold text-xl">${Utils.formatCurrency(tf)}</span></p></div>`;
                displayDiv.innerHTML = html; displayDiv.classList.remove('hidden');
            },
            
            printReport: async (type, dataContext = null) => {
                const titleEl = document.getElementById('printReportTitle'), dateEl = document.getElementById('printReportDate');
                let content = '', rTitle = 'Report', rDateStr = Utils.formatDateForDisplay(Utils.getTodayDateString());
                let printSpecificElementId = null;

                if (type === 'salarySlip') {
                    printSpecificElementId = 'salarySlipPrintView';
                    rTitle = `Salary Slip for ${Utils.formatMonthForDisplay(dataContext.salary.month)}`;
                } else if (type === 'employeeProfile') {
                    printSpecificElementId = 'employeeProfilePrintView';
                    rTitle = `Employee Profile: ${dataContext.employee.name}`;
                    EmployeeController.populateProfilePrintView(dataContext.employee);
                }
                else if (type === 'daily_current') {
                    if (AppState.currentTransactions.length === 0) { Utils.showMessage('Error', 'There are no transactions on the dashboard to print.'); return; }
                    rTitle = `Daily Commission Report`; rDateStr = Utils.formatDateForDisplay(AppState.targetDateForDashboard); 
                    content = `<div class="page-container">${document.getElementById('dailyTransactionsTable').outerHTML}${document.getElementById('dailySummary').outerHTML}</div>`;
                }
                else if (type === 'daily_historical') { const d = document.getElementById('reportDate').value, data = AppState.dailyDataCache[d]; if (!data) { Utils.showMessage('Error', 'Please view the daily report first.'); return; } rTitle = 'Daily Commission Report'; rDateStr = Utils.formatDateForDisplay(data.date); content = `<div class="page-container">${document.getElementById('dailyReportDisplay').innerHTML}</div>`; }
                else if (type === 'monthly') { const m = document.getElementById('reportMonth').value, data = AppState.monthlyDataCache[m]; if (!data) { Utils.showMessage('Error', 'Please view the monthly report first.'); return; } rTitle = 'Monthly Commission Report'; rDateStr = Utils.formatMonthForDisplay(data.month); content = `<div class="page-container">${document.getElementById('monthlyReportDisplay').innerHTML}</div>`; }
                else if (type === 'paymentRequests') {
                    rTitle = 'Payment Requests Report';
                    const tableClone = document.getElementById('paymentRequestsTable').cloneNode(true);
                    tableClone.querySelectorAll('tbody tr').forEach(row => {
                        const statusCell = row.cells[4];
                        const select = statusCell.querySelector('select');
                        if (select) statusCell.textContent = select.value;
                    });
                    content = `<div class="page-container"><h3>${document.getElementById('paymentRequestsSummary').innerHTML.replace(/<button.*?<\/button>/gi, '')}</h3>${tableClone.outerHTML}</div>`;
                }
                else if (type === 'courierTracking') {
                    rTitle = 'Courier Tracking Report';
                    const tableClone = document.getElementById('courierTrackingTable').cloneNode(true);
                    tableClone.querySelectorAll('tbody tr').forEach(row => {
                        const statusCell = row.cells[8];
                        const input = statusCell.querySelector('input');
                        if (input) statusCell.textContent = input.value;
                    });
                    content = `<div class="page-container">${tableClone.outerHTML}</div>`;
                }
                 else if (type === 'branchBudget') {
                    const month = document.getElementById('budgetReportMonth').value;
                    if (!document.getElementById('monthlyBudgetReportDisplay').classList.contains('hidden')) {
                        rTitle = `Branch Budget Report for ${Utils.formatMonthForDisplay(month)}`;
                        const reportContent = document.getElementById('monthlyBudgetReportDisplay').cloneNode(true);
                        reportContent.querySelector('#printBudgetReportBtn').remove(); // Remove button from print
                        content = `<div class="page-container">${reportContent.innerHTML}</div>`;
                    } else {
                         Utils.showMessage('Error', 'Please view a monthly budget report first to print.'); return;
                    }
                }
                else { Utils.showMessage('Error', 'Invalid report type.'); return; }
                
                titleEl.textContent = rTitle; dateEl.textContent = rDateStr; 
                const origBody = document.body.innerHTML;
                
                let printContentHtml = '';
                if (printSpecificElementId) {
                    printContentHtml = document.getElementById(printSpecificElementId).innerHTML;
                } else {
                    printContentHtml = document.querySelector('.print-header').outerHTML + content + document.querySelector('.print-footer').outerHTML;
                }

                document.body.innerHTML = printContentHtml;
                window.print(); document.body.innerHTML = origBody; 
                
                // Re-initialize event listeners on the restored body
                AuthController.addAuthEventListeners();
                UIController.init(); 

                document.querySelectorAll('nav a[data-page]').forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`nav a[data-page="${AppState.currentPage}"]`);
                if(activeLink) activeLink.classList.add('active');
                
                await UIController.navigateTo(AppState.currentPage);

                if(type === 'salarySlip' || type === 'employeeProfile'){
                    await EmployeeController.showEmployeeDetailModal(dataContext.employee.id);
                }
            },
        };

        const AuthController = {
            handleAuthStateChange: (user) => {
                const authPage = document.getElementById('authPage');
                const app = document.getElementById('app');
                if (user) {
                    // User is signed in.
                    authPage.classList.add('hidden');
                    app.classList.remove('hidden');
                    app.classList.add('flex');
                    UIController.init(); // Initialize the main app UI and logic
                } else {
                    // User is signed out.
                    authPage.classList.remove('hidden');
                    app.classList.add('hidden');
                    app.classList.remove('flex');
                }
            },
            signIn: (e) => {
                e.preventDefault();
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                const errorEl = document.getElementById('authError');
                errorEl.classList.add('hidden');

                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        errorEl.textContent = error.message;
                        errorEl.classList.remove('hidden');
                    });
            },
            signUp: (e) => {
                e.preventDefault();
                const email = document.getElementById('signUpEmail').value;
                const password = document.getElementById('signUpPassword').value;
                const errorEl = document.getElementById('signUpError');
                 errorEl.classList.add('hidden');

                auth.createUserWithEmailAndPassword(email, password)
                    .catch((error) => {
                        errorEl.textContent = error.message;
                        errorEl.classList.remove('hidden');
                    });
            },
            signOut: () => {
                auth.signOut();
            },
             toggleAuthForms: () => {
                document.getElementById('loginForm').classList.toggle('hidden');
                document.getElementById('signUpForm').classList.toggle('hidden');
                document.getElementById('backToLoginDiv').classList.toggle('hidden');
                 document.querySelector('.text-center p').classList.toggle('hidden');
            },
            addAuthEventListeners: () => {
                document.getElementById('loginForm').addEventListener('submit', AuthController.signIn);
                document.getElementById('signUpForm').addEventListener('submit', AuthController.signUp);
                document.getElementById('showSignUp').addEventListener('click', (e) => { e.preventDefault(); AuthController.toggleAuthForms(); });
                document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); AuthController.toggleAuthForms(); });
            }
        };
        
        const DataResetService = {
            initiateFullResetProcess: () => {
                Utils.showConfirmationModal( "Confirm Data Reset", "Are you sure you want to delete all your data? This action cannot be undone.",
                    () => {
                        DataResetService.performFullReset();
                    },
                    () => { Utils.showMessage('Cancelled', 'The data reset process has been cancelled.'); } 
                );
            },
            performFullReset: async () => {
                try {
                    await FirebaseStorageService.clearAllAppData();
                    Utils.showMessage('Success', 'All your application data has been reset successfully.');
                    // Refresh current page to reflect changes
                    await UIController.navigateTo(AppState.currentPage);
                } catch(error){
                     Utils.showMessage('Error', 'Could not reset data. ' + error.message);
                }
            },
            downloadData: async () => {
                const allData = await FirebaseStorageService.getAllData();
                if (!allData || Object.keys(allData).length === 0) {
                    Utils.showMessage('No Data', 'There is no data to download.');
                    return;
                }
                
                const user = auth.currentUser;
                const dataToSave = { [`users/${user.uid}`]: allData };

                const jsonString = JSON.stringify(dataToSave, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `darson_securities_backup_${Utils.getTodayDateString()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                Utils.showMessage('Success', 'Your data has been downloaded successfully.');
            },
            handleRestoreData: () => {
                const fileInput = document.getElementById('restoreDataInput');
                if (fileInput.files.length === 0) {
                    Utils.showMessage('No File Selected', 'Please select a backup file to restore.');
                    return;
                }
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        Utils.showConfirmationModal('Confirm Restore', 'Are you sure you want to restore data from this file? All your current data will be overwritten.',
                            async () => {
                                try {
                                    await FirebaseStorageService.restoreAllData(data);
                                    Utils.showMessage('Success', 'Data has been restored successfully. The application will now reload.');
                                    setTimeout(() => location.reload(), 1500);
                                } catch (error) {
                                     Utils.showMessage('Error', 'Restore failed. ' + error.message);
                                }
                            },
                            () => {
                                fileInput.value = ''; // Reset file input
                            }
                        );
                    } catch (error) {
                        Utils.showMessage('Error', 'The selected file is not a valid backup file. Please try again.');
                        fileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }
        };

        const BalanceTrackingController = {
            SETTINGS_KEY: 'appSettings', ADJUSTMENT_HISTORY_KEY: 'balanceAdjustments',
            getSettings: async () => await FirebaseStorageService.getItem(BalanceTrackingController.SETTINGS_KEY) || { overallBalance: 0, lastFinalizedMonth: null },
            saveSettings: (s) => FirebaseStorageService.setItem(BalanceTrackingController.SETTINGS_KEY, s),
            getAdjustmentHistory: async () => await FirebaseStorageService.getItem(BalanceTrackingController.ADJUSTMENT_HISTORY_KEY) || [],
            saveAdjustmentHistory: (h) => FirebaseStorageService.setItem(BalanceTrackingController.ADJUSTMENT_HISTORY_KEY, h),

            updateOverallBalanceDisplay: async () => {
                let bal = 0; 
                const allTransactions = await FirebaseStorageService.getItem('transactions') || {};
                Object.values(allTransactions).forEach(d => { if (d && d.finalHouseCommission) bal += parseFloat(d.finalHouseCommission); });
                
                const adjHistory = await BalanceTrackingController.getAdjustmentHistory();
                const adj = Object.values(adjHistory); // Convert object to array
                adj.forEach(a => bal += parseFloat(a.amount));
                
                const s = await BalanceTrackingController.getSettings(); 
                s.overallBalance = bal; 
                await BalanceTrackingController.saveSettings(s);
                document.getElementById('currentOverallBalance').textContent = Utils.formatCurrency(s.overallBalance);
            },
            addManualBalanceAdjustment: async () => {
                const amtIn = document.getElementById('manualCommissionAmount'), rsnIn = document.getElementById('manualCommissionReason');
                const amt = parseFloat(amtIn.value), rsn = rsnIn.value.trim();
                if (isNaN(amt) || amt === 0) { Utils.showMessage('Validation Error', 'Please enter a valid, non-zero amount.'); return; }
                if (!rsn) { Utils.showMessage('Validation Error', 'Please enter a reason.'); return; }
                const id = Utils.generateId();
                const adj = { id: id, date: Utils.getTodayDateString(), amount: amt, reason: rsn, type: amt > 0 ? 'Credit' : 'Debit (Manual)' };
                await db.ref(`users/${auth.currentUser.uid}/balanceAdjustments/${id}`).set(adj);
                
                await BalanceTrackingController.updateOverallBalanceDisplay(); 
                await BalanceTrackingController.loadAdjustmentHistory();
                amtIn.value = ''; rsnIn.value = ''; Utils.showMessage('Success', 'Balance has been adjusted.');
            },
            loadAdjustmentHistory: async () => {
                const histObj = await FirebaseStorageService.getItem('balanceAdjustments') || {};
                const hist = Object.values(histObj).sort((a,b) => new Date(b.date) - new Date(a.date));
                const tbody = document.getElementById('balanceAdjustmentHistoryTable').getElementsByTagName('tbody')[0]; 
                tbody.innerHTML = '';
                if (hist.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3">No adjustments found.</td></tr>'; return; }
                hist.forEach(adj => {
                    const r = tbody.insertRow(); r.insertCell().textContent = Utils.formatDateForDisplay(adj.date); r.insertCell().textContent = adj.reason;
                    r.insertCell().textContent = Utils.formatCurrency(adj.amount); r.insertCell().textContent = adj.type;
                    r.cells[2].classList.toggle('text-green-600', parseFloat(adj.amount) > 0); r.cells[2].classList.toggle('text-red-600', parseFloat(adj.amount) < 0);
                });
            },
            finalizeCurrentMonth: async () => {
                const cmy = Utils.getCurrentMonthYearString();
                const s = await BalanceTrackingController.getSettings();
                if (s.lastFinalizedMonth === cmy) { Utils.showMessage('Info', `The month of ${Utils.formatMonthForDisplay(cmy)} has already been finalized.`); return; }
                
                const allTransactions = await FirebaseStorageService.getItem('transactions') || {};
                let me = 0;
                Object.values(allTransactions).forEach(d => { if (d && d.date && d.date.startsWith(cmy) && d.finalHouseCommission) me += parseFloat(d.finalHouseCommission); });
                
                s.lastFinalizedMonth = cmy; 
                await BalanceTrackingController.saveSettings(s);
                const stEl = document.getElementById('newMonthStatus');
                stEl.textContent = `The month of ${Utils.formatMonthForDisplay(cmy)} has been finalized (Earnings: ${Utils.formatCurrency(me)}). Ready for the new month.`;
                stEl.classList.add('text-green-600'); 
                Utils.showMessage('Month Finalized', `Earnings for ${Utils.formatMonthForDisplay(cmy)}: ${Utils.formatCurrency(me)}.`);
            }
        };

        const PaymentRequestController = {
            STORAGE_KEY: 'paymentRequests',
            getRequests: async () => await FirebaseStorageService.getItem(PaymentRequestController.STORAGE_KEY) || {},
            saveRequests: (r) => FirebaseStorageService.setItem(PaymentRequestController.STORAGE_KEY, r),

            handleAddRequest: async (e) => {
                e.preventDefault(); const d = document.getElementById('paymentRequestDate').value, a = parseFloat(document.getElementById('paymentRequestAmount').value), desc = document.getElementById('paymentRequestDescription').value.trim();
                if (!d || isNaN(a) || a <= 0 || !desc) { Utils.showMessage('Validation Error', 'Please fill in all fields.'); return; }
                const id = Utils.generateId();
                const nr = { id: id, requestDate: d, amount: a, description: desc, status: 'Pending', entryDate: Utils.getTodayDateString() };
                await db.ref(`users/${auth.currentUser.uid}/${PaymentRequestController.STORAGE_KEY}/${id}`).set(nr);
                await PaymentRequestController.loadRequests(); 
                document.getElementById('paymentRequestForm').reset(); 
                Utils.showMessage('Success', 'Request submitted successfully.');
            },
            loadRequests: async () => {
                const rsObj = await PaymentRequestController.getRequests();
                const rs = Object.values(rsObj).sort((a,b) => new Date(b.requestDate) - new Date(a.date));
                const tbody = document.getElementById('paymentRequestsTable').getElementsByTagName('tbody')[0]; 
                tbody.innerHTML = '';
                if (rs.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-3">No requests found.</td></tr>'; }
                else { rs.forEach(req => {
                        const r = tbody.insertRow(); r.insertCell().textContent = req.id.slice(-6).toUpperCase(); r.insertCell().textContent = Utils.formatDateForDisplay(req.requestDate);
                        r.insertCell().textContent = Utils.formatCurrency(req.amount); r.insertCell().textContent = req.description;
                        const sc = r.insertCell(), ss = document.createElement('select'); ss.classList.add('p-1','border','rounded-md','text-sm','bg-white','w-full');
                        ['Pending','Approved','Paid','Rejected'].forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; if(s===req.status)o.selected=true; ss.appendChild(o); });
                        ss.onchange=async (e)=> await PaymentRequestController.updateStatus(req.id,e.target.value); sc.appendChild(ss);
                        const ac = r.insertCell(), delBtn = document.createElement('button'); delBtn.innerHTML='<i class="fas fa-trash-alt"></i>'; delBtn.classList.add('btn','btn-danger','btn-icon','text-xs');
                        delBtn.onclick=()=>PaymentRequestController.deleteRequest(req.id); ac.appendChild(delBtn);
                    }); }
                await PaymentRequestController.updatePaymentSummary();
            },
            updateStatus: async (id, newStatus) => {
                const requests = await PaymentRequestController.getRequests(); 
                const requestToUpdate = requests[id];
                if (!requestToUpdate) { Utils.showMessage('Error', 'Payment request not found.'); return; }

                const oldStatus = requestToUpdate.status;
                await db.ref(`users/${auth.currentUser.uid}/${PaymentRequestController.STORAGE_KEY}/${id}/status`).set(newStatus);

                if (newStatus === 'Approved' && oldStatus !== 'Approved') {
                    const amountToDeduct = parseFloat(requestToUpdate.amount); 
                    const reason = `Approved Payment: ${requestToUpdate.description.substring(0,25)} (ID: ${requestToUpdate.id.slice(-6).toUpperCase()})`;
                    const adjId = Utils.generateId();
                    const newAdjustment = { id: adjId, date: Utils.getTodayDateString(), amount: -amountToDeduct, reason: reason, type: 'Debit (Payment Appr.)' };
                    await db.ref(`users/${auth.currentUser.uid}/balanceAdjustments/${adjId}`).set(newAdjustment);

                    await BalanceTrackingController.updateOverallBalanceDisplay(); 
                    Utils.showMessage('Status & Balance Updated', `Request status: ${newStatus}. ${Utils.formatCurrency(amountToDeduct)} has been deducted from the balance.`);
                    if (AppState.currentPage === 'balanceTracking') await BalanceTrackingController.loadAdjustmentHistory();
                } else { Utils.showMessage('Status Updated', `Request status: ${newStatus}.`); }
                await PaymentRequestController.updatePaymentSummary(); 
            },
            deleteRequest: (id) => {
                Utils.showConfirmationModal('Delete Request', 'Are you sure you want to delete this payment request?', async () => {
                    await FirebaseStorageService.removeItem(`${PaymentRequestController.STORAGE_KEY}/${id}`);
                    await PaymentRequestController.loadRequests(); 
                    Utils.showMessage('Deleted', 'The request has been deleted.');
                });
            },
            updatePaymentSummary: async () => {
                const rsObj = await PaymentRequestController.getRequests();
                const rs = Object.values(rsObj);
                const cm = Utils.getCurrentMonthYearString();
                document.getElementById('paymentSummaryMonth').textContent = Utils.formatMonthForDisplay(cm);
                let tr=0, ta=0, tp=0; 
                rs.filter(req => req.requestDate.startsWith(cm)).forEach(req => { 
                    tr+=parseFloat(req.amount); 
                    if(req.status==='Approved'||req.status==='Paid') ta+=parseFloat(req.amount); 
                    if(req.status==='Paid') tp+=parseFloat(req.amount); 
                });
                const ua = ta - tp;
                document.getElementById('totalRequestedAmount').textContent=Utils.formatCurrency(tr); 
                document.getElementById('totalApprovedAmount').textContent=Utils.formatCurrency(ta);
                document.getElementById('totalPaidAmount').textContent=Utils.formatCurrency(tp); 
                document.getElementById('totalUnpaidApprovedAmount').textContent=Utils.formatCurrency(ua);
            },
            carryOverUnpaidApproved: async () => {
                const rsObj = await PaymentRequestController.getRequests();
                const rs = Object.values(rsObj);
                const cm = Utils.getCurrentMonthYearString(); 
                let unpaidApprovedForCarryOver = 0;
                rs.filter(req => req.requestDate.startsWith(cm) && req.status === 'Approved').forEach(req => unpaidApprovedForCarryOver += parseFloat(req.amount));
                
                if (unpaidApprovedForCarryOver <= 0) { Utils.showMessage('No Amount', 'There is no unpaid "Approved" amount to carry over for this month.'); return; }
                
                Utils.showConfirmationModal('Carry Over Balance', `Carry over ${Utils.formatCurrency(unpaidApprovedForCarryOver)} (unpaid "Approved" from ${Utils.formatMonthForDisplay(cm)}) as a negative (debit) entry in balance adjustments? This will be shown as an expense.`, async () => {
                    const rsn = `Carried over unpaid approved from ${Utils.formatMonthForDisplay(cm)}`; 
                    const adjAmt = -unpaidApprovedForCarryOver; 
                    const adjId = Utils.generateId();
                    const adj = { id: adjId, date: Utils.getTodayDateString(), amount: adjAmt, reason: rsn, type: 'Debit (Carry Over)' };
                    await db.ref(`users/${auth.currentUser.uid}/balanceAdjustments/${adjId}`).set(adj);
                    await BalanceTrackingController.updateOverallBalanceDisplay(); 
                    if(AppState.currentPage === 'balanceTracking') await BalanceTrackingController.loadAdjustmentHistory();
                    Utils.showMessage('Carried Over', `${Utils.formatCurrency(unpaidApprovedForCarryOver)} has been adjusted in the balance.`);
                });
            }
        };
        
        const CourierTrackingController = {
            STORAGE_KEY: 'courierEntries',
            getEntries: async () => await FirebaseStorageService.getItem(CourierTrackingController.STORAGE_KEY) || {},
            saveEntries: (e) => FirebaseStorageService.setItem(CourierTrackingController.STORAGE_KEY, e),

            handleAddEntry: async (e) => {
                e.preventDefault(); const typ = document.getElementById('courierType').value, dt = document.getElementById('courierDateSent').value, tid = document.getElementById('courierTrackingId').value.trim(),
                sn = document.getElementById('courierSenderName').value.trim(), rn = document.getElementById('courierReceiverName').value.trim(), dst = document.getElementById('courierDestination').value.trim(),
                st = document.getElementById('courierStatus').value.trim(), dsc = document.getElementById('courierDescription').value.trim();
                if (!dt||!sn||!rn||!dst||!st) { Utils.showMessage('Validation Error', 'Please fill in the required courier fields.'); return; }
                const id = Utils.generateId();
                const ne = { id:id,type:typ,date:dt,trackingId:tid,senderName:sn,receiverName:rn,destination:dst,status:st,description:dsc,entryDate:Utils.getTodayDateString() };
                await db.ref(`users/${auth.currentUser.uid}/${CourierTrackingController.STORAGE_KEY}/${id}`).set(ne);
                await CourierTrackingController.loadEntries(); 
                document.getElementById('courierTrackingForm').reset(); Utils.showMessage('Success', 'Courier entry added successfully.');
            },
            loadEntries: async () => {
                const esObj = await CourierTrackingController.getEntries();
                const es = Object.values(esObj).sort((a,b) => new Date(b.date) - new Date(a.date));
                const tbody = document.getElementById('courierTrackingTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
                if (es.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-3">No courier records found.</td></tr>'; return; }
                es.forEach(en => {
                    const r = tbody.insertRow(); r.insertCell().textContent = en.id.slice(-6).toUpperCase(); r.insertCell().textContent = en.type.charAt(0).toUpperCase()+en.type.slice(1);
                    r.insertCell().textContent = Utils.formatDateForDisplay(en.date); r.insertCell().textContent = en.trackingId||'N/A'; r.insertCell().textContent = en.senderName;
                    r.insertCell().textContent = en.receiverName; r.insertCell().textContent = en.destination; r.insertCell().textContent = en.description||'N/A';
                    const sc = r.insertCell(), si = document.createElement('input'); si.type='text'; si.value=en.status; si.classList.add('p-1','border','rounded-md','text-sm','w-full','bg-white');
                    si.onchange= (e) => CourierTrackingController.updateStatus(en.id,e.target.value); sc.appendChild(si);
                    const ac = r.insertCell(), delBtn = document.createElement('button'); delBtn.innerHTML='<i class="fas fa-trash-alt"></i>'; delBtn.classList.add('btn','btn-danger','btn-icon','text-xs');
                    delBtn.onclick=()=>CourierTrackingController.deleteEntry(en.id); ac.appendChild(delBtn);
                });
            },
            updateStatus: (id, newStatus) => {
                db.ref(`users/${auth.currentUser.uid}/${CourierTrackingController.STORAGE_KEY}/${id}/status`).set(newStatus);
            },
            deleteEntry: (id) => {
                 Utils.showConfirmationModal('Delete Courier Entry', 'Are you sure you want to delete this courier entry?', async () => {
                    await FirebaseStorageService.removeItem(`${CourierTrackingController.STORAGE_KEY}/${id}`);
                    await CourierTrackingController.loadEntries(); 
                    Utils.showMessage('Deleted', 'The courier entry has been deleted.');
                });
            }
        };

        const BranchBudgetController = {
            STORAGE_KEY: 'branchBudgetEntries', 

            getEntries: async () => await FirebaseStorageService.getItem(BranchBudgetController.STORAGE_KEY) || {},

            handleAddEntry: async (e) => {
                e.preventDefault(); 
                const dt = document.getElementById('budgetEntryDate').value;
                const type = document.getElementById('budgetEntryType').value;
                const itm = document.getElementById('budgetItem').value.trim();
                const amt = parseFloat(document.getElementById('budgetAmount').value);

                if (!dt||!itm||isNaN(amt)||amt<=0) { Utils.showMessage('Validation Error', 'Please enter Date, Details, and a valid Amount.'); return; }
                
                const id = Utils.generateId();
                const newEntry = { id:id, date:dt, type: type, item:itm, amount:amt, entryDate:Utils.getTodayDateString() };
                
                await db.ref(`users/${auth.currentUser.uid}/${BranchBudgetController.STORAGE_KEY}/${id}`).set(newEntry);
                
                await BranchBudgetController.loadEntries();
                document.getElementById('branchBudgetForm').reset();
                document.getElementById('budgetEntryDate').value = Utils.getTodayDateString(); // Reset date to today
                Utils.showMessage('Success', 'Budget entry added successfully.');
            },

            loadEntries: async (isInitialLoad = false) => {
                const reportDiv = document.getElementById('monthlyBudgetReportDisplay');
                
                if (isInitialLoad) {
                    reportDiv.classList.add('hidden');
                    return;
                }

                const month = document.getElementById('budgetReportMonth').value;
                if (!month) {
                    Utils.showMessage("Input required", "Please select a month to view the report.");
                    return;
                }
                
                reportDiv.classList.remove('hidden');

                const allEntriesObj = await BranchBudgetController.getEntries();
                const allEntries = Object.values(allEntriesObj);
                
                const monthlyEntries = allEntries.filter(entry => entry.date.startsWith(month)).sort((a,b) => new Date(b.date) - new Date(a.date));

                const tbody = document.getElementById('branchBudgetTable').getElementsByTagName('tbody')[0]; 
                tbody.innerHTML = '';
                
                let totalIn = 0;
                let totalOut = 0;

                if (monthlyEntries.length === 0) { 
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-3">No budget entries found for ${Utils.formatMonthForDisplay(month)}.</td></tr>`; 
                } else {
                    monthlyEntries.forEach(en => {
                        const r = tbody.insertRow(); 
                        
                        // Calculate totals
                        if (en.type === 'cash-in') {
                            totalIn += parseFloat(en.amount);
                        } else {
                            totalOut += parseFloat(en.amount);
                        }
                        
                        r.insertCell().textContent = en.id.slice(-6).toUpperCase(); 
                        r.insertCell().textContent = Utils.formatDateForDisplay(en.date);
                        
                        const typeCell = r.insertCell();
                        typeCell.textContent = en.type === 'cash-in' ? 'Cash In' : 'Cash Out';
                        typeCell.className = en.type === 'cash-in' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';

                        r.insertCell().textContent = en.item; 
                        r.insertCell().textContent = Utils.formatCurrency(en.amount);
                        
                        const ac = r.insertCell(); 
                        ac.classList.add('action-column'); 
                        const delBtn = document.createElement('button'); 
                        delBtn.innerHTML='<i class="fas fa-trash-alt"></i>'; 
                        delBtn.classList.add('btn','btn-danger','btn-icon','text-xs'); 
                        delBtn.onclick=()=>BranchBudgetController.deleteEntry(en.id); 
                        ac.appendChild(delBtn);
                    });
                }
                
                const remainingBalance = totalIn - totalOut;

                document.getElementById('totalCashIn').textContent = Utils.formatCurrency(totalIn);
                document.getElementById('totalCashOut').textContent = Utils.formatCurrency(totalOut);
                const balanceEl = document.getElementById('remainingBudgetBalance');
                balanceEl.textContent = Utils.formatCurrency(remainingBalance);
                balanceEl.className = `text-2xl font-bold ${remainingBalance >= 0 ? 'text-blue-700' : 'text-red-700'}`;
            },

            deleteEntry: (id) => {
                Utils.showConfirmationModal('Delete Budget Entry', 'Are you sure you want to delete this budget entry?', async () => {
                    await FirebaseStorageService.removeItem(`${BranchBudgetController.STORAGE_KEY}/${id}`);
                    await BranchBudgetController.loadEntries(); 
                    Utils.showMessage('Deleted', 'The budget entry has been deleted.');
                });
            },
        };

        const EmployeeController = {
            STORAGE_KEY: 'employees',
            tempPictureBase64: null,

            getEmployees: async () => await FirebaseStorageService.getItem(EmployeeController.STORAGE_KEY) || {},
            saveEmployees: (employees) => FirebaseStorageService.setItem(EmployeeController.STORAGE_KEY, employees),
            
            clearForm: () => {
                document.getElementById('employeeForm').reset();
                document.getElementById('employeeId').value = '';
                document.getElementById('employeePicturePreview').src = 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=.';
                EmployeeController.tempPictureBase64 = null;
            },

            previewEmployeePicture: async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        Utils.showMessage('Compressing...', 'Optimizing image, please wait.');
                        const compressedFile = await Utils.compressImage(file);
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('employeePicturePreview').src = e.target.result;
                            EmployeeController.tempPictureBase64 = e.target.result;
                            Utils.hideMessageModal();
                        };
                        reader.readAsDataURL(compressedFile);
                    } catch (error) {
                        console.error("Image compression error:", error);
                        Utils.showMessage('Error', 'Image could not be compressed. Please try another image.');
                        Utils.hideMessageModal();
                    }
                }
            },
            
            handleAddOrUpdateEmployee: async (e) => {
                e.preventDefault();
                const id = document.getElementById('employeeId').value;
                const employeeData = {
                    name: document.getElementById('employeeName').value.trim(),
                    designation: document.getElementById('employeeDesignation').value.trim(),
                    address: document.getElementById('employeeAddress').value.trim(),
                    cnic: document.getElementById('employeeCnic').value.trim(),
                    joiningDate: document.getElementById('employeeJoiningDate').value,
                };

                if (!employeeData.name || !employeeData.designation || !employeeData.joiningDate) {
                    Utils.showMessage('Validation Error', 'Please fill in Name, Designation, and Joining Date.');
                    return;
                }

                if (id) { // Update existing employee
                     if (EmployeeController.tempPictureBase64) {
                        employeeData.pictureBase64 = EmployeeController.tempPictureBase64;
                    }
                    await db.ref(`users/${auth.currentUser.uid}/${EmployeeController.STORAGE_KEY}/${id}`).update(employeeData);
                } else { // Add new employee
                    const newId = Utils.generateId();
                    employeeData.id = newId;
                    employeeData.pictureBase64 = EmployeeController.tempPictureBase64;
                    employeeData.salaries = {};
                    employeeData.leaves = {};
                    await db.ref(`users/${auth.currentUser.uid}/${EmployeeController.STORAGE_KEY}/${newId}`).set(employeeData);
                }

                await EmployeeController.loadEmployees();
                EmployeeController.clearForm();
                Utils.showMessage('Success', `Employee has been ${id ? 'updated' : 'saved'}.`);
            },
            
            loadEmployees: async () => {
                const employeesObj = await EmployeeController.getEmployees();
                const employees = Object.values(employeesObj);
                const listContainer = document.getElementById('employeeList');
                listContainer.innerHTML = '';
                if (employees.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500 md:col-span-3 text-center">No employees have been added yet.</p>`;
                    return;
                }
                employees.forEach(emp => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow border flex flex-col items-center text-center';
                    card.innerHTML = `
                        <img src="${emp.pictureBase64 || 'https://placehold.co/100x100/1a3b5d/ffffff?text=' + emp.name.charAt(0)}" alt="${emp.name}" class="w-24 h-24 rounded-full object-cover mb-4 border-4 border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800">${emp.name}</h4>
                        <p class="text-gray-500 mb-4">${emp.designation}</p>
                        <button class="btn btn-primary w-full mt-auto">View Details & Salary</button>
                    `;
                    card.querySelector('button').onclick = () => EmployeeController.showEmployeeDetailModal(emp.id);
                    listContainer.appendChild(card);
                });
            },

            showEmployeeDetailModal: async (id) => {
                const employees = await EmployeeController.getEmployees();
                const employee = employees[id];
                if (!employee) return;
                
                // Populate Profile
                document.getElementById('modalEmployeePicture').src = employee.pictureBase64 || 'https://placehold.co/150x150/1a3b5d/ffffff?text=' + employee.name.charAt(0);
                document.getElementById('modalEmployeeName').textContent = employee.name;
                document.getElementById('modalEmployeeDesignation').textContent = employee.designation;
                document.getElementById('modalEmployeeAddress').textContent = employee.address;
                document.getElementById('modalEmployeeCnic').textContent = employee.cnic;
                document.getElementById('modalEmployeeJoiningDate').textContent = Utils.formatDateForDisplay(employee.joiningDate);

                // Set up forms
                document.getElementById('salaryEmployeeId').value = id;
                document.getElementById('leaveEmployeeId').value = id;
                document.getElementById('salaryMonth').value = Utils.getCurrentMonthYearString();
                document.getElementById('leaveMonth').value = Utils.getCurrentMonthYearString();
                
                // Store id in buttons for later use
                document.getElementById('editEmployeeFromModalBtn').dataset.employeeId = id;
                document.getElementById('deleteEmployeeFromModalBtn').dataset.employeeId = id;
                document.getElementById('printProfileFromModalBtn').dataset.employeeId = id;

                EmployeeController.renderSalaryHistory(employee);
                EmployeeController.renderLeaveHistory(employee);
                document.getElementById('employeeDetailModal').classList.remove('hidden');
            },

            hideEmployeeDetailModal: () => {
                document.getElementById('employeeDetailModal').classList.add('hidden');
            },
            
            handleEditEmployeeFromModal: async (e) => {
                const id = e.currentTarget.dataset.employeeId;
                const employees = await EmployeeController.getEmployees();
                const employee = employees[id];
                if (!employee) return;
                
                document.getElementById('employeeId').value = employee.id;
                document.getElementById('employeeName').value = employee.name;
                document.getElementById('employeeDesignation').value = employee.designation;
                document.getElementById('employeeAddress').value = employee.address;
                document.getElementById('employeeCnic').value = employee.cnic;
                document.getElementById('employeeJoiningDate').value = employee.joiningDate;
                document.getElementById('employeePicturePreview').src = employee.pictureBase64 || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=.';

                EmployeeController.hideEmployeeDetailModal();
                window.scrollTo(0, 0); 
            },

            handleDeleteEmployeeFromModal: (e) => {
                const id = e.currentTarget.dataset.employeeId;
                Utils.showConfirmationModal('Delete Employee?', 'Are you sure you want to delete this employee and all their records? This action cannot be undone.', async () => {
                    await EmployeeController.deleteEmployee(id);
                });
            },

             handlePrintProfileFromModal: async (e) => {
                const id = e.currentTarget.dataset.employeeId;
                const employees = await EmployeeController.getEmployees();
                const employee = employees[id];
                if(employee) {
                    await UIController.printReport('employeeProfile', { employee });
                }
            },

            deleteEmployee: async (id) => {
                await FirebaseStorageService.removeItem(`${EmployeeController.STORAGE_KEY}/${id}`);
                EmployeeController.hideEmployeeDetailModal();
                await EmployeeController.loadEmployees();
                Utils.showMessage('Success', 'Employee has been deleted.');
            },

            renderSalaryHistory: (employee) => {
                const tbody = document.getElementById('salaryHistoryTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';
                const salaries = employee.salaries ? Object.values(employee.salaries) : [];
                if (salaries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3">No salary records found.</td></tr>';
                    return;
                }
                const sortedSalaries = salaries.sort((a, b) => b.month.localeCompare(a.month));

                sortedSalaries.forEach(salary => {
                    const row = tbody.insertRow();
                    const totalSalary = (salary.amount || 0) + (salary.allowances || 0) + (salary.incentives || 0);
                    row.insertCell().textContent = Utils.formatMonthForDisplay(salary.month);
                    row.insertCell().textContent = Utils.formatCurrency(totalSalary);
                    
                    const statusCell = row.insertCell();
                    const statusSelect = document.createElement('select');
                    statusSelect.className = `p-1 border rounded-md text-sm w-full ${salary.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                    statusSelect.innerHTML = `<option value="Unpaid">Unpaid</option><option value="Paid">Paid</option>`;
                    statusSelect.value = salary.status;
                    statusSelect.onchange = (e) => {
                        statusSelect.className = `p-1 border rounded-md text-sm w-full ${e.target.value === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                        EmployeeController.updateSalaryStatus(employee.id, salary.month, e.target.value);
                    };
                    statusCell.appendChild(statusSelect);

                    const actionsCell = row.insertCell(); actionsCell.className = 'no-print';
                    const printBtn = document.createElement('button');
                    printBtn.innerHTML = '<i class="fas fa-print"></i>'; printBtn.title = 'Print Slip';
                    printBtn.className = 'btn btn-secondary btn-icon text-xs';
                    printBtn.onclick = () => EmployeeController.printSalarySlip(employee, salary);
                    actionsCell.appendChild(printBtn);
                });
            },

            handleAddSalaryRecord: async (e) => {
                e.preventDefault();
                const employeeId = document.getElementById('salaryEmployeeId').value;
                const month = document.getElementById('salaryMonth').value;
                const amount = parseFloat(document.getElementById('salaryAmount').value) || 0;
                const allowances = parseFloat(document.getElementById('salaryAllowances').value) || 0;
                const incentives = parseFloat(document.getElementById('salaryIncentives').value) || 0;

                if (!month || (amount + allowances + incentives) <= 0) {
                    Utils.showMessage('Validation Error', 'Select a month and enter a valid salary amount.'); return;
                }
                const newSalaryRecord = { month, amount, allowances, incentives, status: 'Unpaid' };
                await db.ref(`users/${auth.currentUser.uid}/${EmployeeController.STORAGE_KEY}/${employeeId}/salaries/${month}`).set(newSalaryRecord);
                
                const updatedEmployee = (await EmployeeController.getEmployees())[employeeId];
                EmployeeController.renderSalaryHistory(updatedEmployee);
                document.getElementById('salaryForm').reset();
                document.getElementById('salaryMonth').value = Utils.getCurrentMonthYearString();
            },

            updateSalaryStatus: (employeeId, month, newStatus) => {
                 db.ref(`users/${auth.currentUser.uid}/${EmployeeController.STORAGE_KEY}/${employeeId}/salaries/${month}/status`).set(newStatus);
            },
            
            printSalarySlip: async (employee, salary) => {
                const netSalary = (salary.amount || 0) + (salary.allowances || 0) + (salary.incentives || 0);
                document.getElementById('slipEmployeeName').textContent = employee.name;
                document.getElementById('slipEmployeeDesignation').textContent = employee.designation;
                document.getElementById('slipEmployeeAddress').textContent = employee.address;
                document.getElementById('slipEmployeeCnic').textContent = employee.cnic;
                document.getElementById('slipSalaryMonth').textContent = Utils.formatMonthForDisplay(salary.month);
                document.getElementById('slipPrintDate').textContent = Utils.formatDateForDisplay(Utils.getTodayDateString());
                document.getElementById('slipBasicSalary').textContent = parseFloat(salary.amount || 0).toFixed(2);
                document.getElementById('slipAllowances').textContent = parseFloat(salary.allowances || 0).toFixed(2);
                document.getElementById('slipIncentives').textContent = parseFloat(salary.incentives || 0).toFixed(2);
                document.getElementById('slipNetSalary').textContent = parseFloat(netSalary).toFixed(2);
                
                 await UIController.printReport('salarySlip', { employee: employee, salary: salary });
            },

            populateProfilePrintView: (employee) => {
                const salaries = employee.salaries ? Object.values(employee.salaries) : [];
                let salaryHistoryHtml = '<tr><td colspan="3" class="text-center">No salary history found.</td></tr>';
                if(salaries.length > 0) {
                    salaryHistoryHtml = salaries.sort((a,b) => b.month.localeCompare(a.month)).map(s => `
                        <tr>
                            <td>${Utils.formatMonthForDisplay(s.month)}</td>
                            <td>${Utils.formatCurrency((s.amount || 0) + (s.allowances || 0) + (s.incentives || 0))}</td>
                            <td>${s.status}</td>
                        </tr>
                    `).join('');
                }

                const leaves = employee.leaves ? Object.values(employee.leaves) : [];
                let leaveHistoryHtml = '<tr><td colspan="2" class="text-center">No leave history found.</td></tr>';
                if(leaves.length > 0) {
                     leaveHistoryHtml = leaves.sort((a,b) => b.month.localeCompare(a.month)).map(l => `
                        <tr>
                            <td>${Utils.formatMonthForDisplay(l.month)}</td>
                            <td>${l.count}</td>
                        </tr>
                    `).join('');
                }

                const printHTML = `
                     <div class="p-8" style="font-family: Arial, sans-serif;">
                        <header class="text-center mb-8 pb-4 border-b-2 border-black">
                            <h1 class="text-3xl font-bold text-black">Darson Securities Limited</h1>
                            <p class="text-lg text-black">Sargodha Branch</p>
                            <h2 class="text-2xl font-semibold mt-4 text-black">Employee Profile</h2>
                        </header>
                        <section class="mb-6 grid grid-cols-3 gap-6 items-center">
                             <div class="col-span-1">
                                <img src="${employee.pictureBase64 || 'https://placehold.co/150x150/1a3b5d/ffffff?text=' + employee.name.charAt(0)}" alt="Pic" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200">
                             </div>
                             <div class="col-span-2 space-y-2 text-sm">
                                <p><strong>Name:</strong> ${employee.name}</p>
                                <p><strong>Designation:</strong> ${employee.designation}</p>
                                <p><strong>Address:</strong> ${employee.address}</p>
                                <p><strong>CNIC:</strong> ${employee.cnic}</p>
                                <p><strong>Joining Date:</strong> ${Utils.formatDateForDisplay(employee.joiningDate)}</p>
                             </div>
                        </section>
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-2">Salary History</h3>
                                <table class="w-full"><thead><tr><th>Month</th><th>Total Salary</th><th>Status</th></tr></thead><tbody>${salaryHistoryHtml}</tbody></table>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-2">Leave History</h3>
                                <table class="w-full"><thead><tr><th>Month</th><th>Leaves</th></tr></thead><tbody>${leaveHistoryHtml}</tbody></table>
                            </div>
                        </div>
                        <footer class="text-center text-xs text-gray-600 mt-12 pt-4 border-t">
                            Generated on ${Utils.formatDateForDisplay(Utils.getTodayDateString())}
                        </footer>
                    </div>
                `;
                document.getElementById('employeeProfilePrintView').innerHTML = printHTML;
            },

            renderLeaveHistory: (employee) => {
                const tbody = document.getElementById('leaveHistoryTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';
                const leaves = employee.leaves ? Object.values(employee.leaves) : [];
                if (leaves.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-3">No leave records found.</td></tr>';
                    return;
                }
                const sortedLeaves = leaves.sort((a, b) => b.month.localeCompare(a.month));
                sortedLeaves.forEach(leave => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = Utils.formatMonthForDisplay(leave.month);
                    row.insertCell().textContent = leave.count;
                });
            },

            handleAddLeaveRecord: async (e) => {
                e.preventDefault();
                const employeeId = document.getElementById('leaveEmployeeId').value;
                const month = document.getElementById('leaveMonth').value;
                const count = parseInt(document.getElementById('leaveCount').value);

                if (!month || isNaN(count) || count < 0) {
                    Utils.showMessage('Validation Error', 'Select a month and enter a valid number of leaves.'); return;
                }

                await db.ref(`users/${auth.currentUser.uid}/${EmployeeController.STORAGE_KEY}/${employeeId}/leaves/${month}`).set({ month, count });
                const updatedEmployee = (await EmployeeController.getEmployees())[employeeId];
                EmployeeController.renderLeaveHistory(updatedEmployee);
                document.getElementById('leaveForm').reset();
                document.getElementById('leaveMonth').value = Utils.getCurrentMonthYearString();
            },
        };

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
             auth.onAuthStateChanged(AuthController.handleAuthStateChange);
             AuthController.addAuthEventListeners();
        });
    </script>
</body>
</html>
