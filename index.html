<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darson Securities Commission Software</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* General body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            color: #333; /* Dark gray text */
        }

        /* Navigation styling */
        nav {
            background-color: #1a3b5d; /* Darson blue */
            color: white;
        }
        nav a, nav button {
            transition: background-color 0.3s ease, color 0.3s ease;
            border-radius: 0.375rem; /* md */
        }
        nav a:hover, nav button:hover, nav a.active, nav button.active {
            background-color: #2a5282; /* Slightly lighter blue */
            color: #e0f2fe; /* Light cyan */
        }
        .nav-icon {
            margin-right: 0.5rem; /* space between icon and text */
        }

        /* Page container styling */
        .page-container {
            background-color: white;
            border-radius: 0.75rem; /* lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Tailwind shadow-lg */
            padding: 1.5rem; /* p-6 */
            margin-top: 1.5rem; /* mt-6 */
        }
        .page-title {
            color: #1a3b5d; /* Darson blue */
            border-bottom: 2px solid #2a5282;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* Form elements styling */
        input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, textarea {
            border: 1px solid #cbd5e1; /* cool-gray-300 */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* md */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
            border-color: #2a5282; /* Darson blue */
            box-shadow: 0 0 0 3px rgba(42, 82, 130, 0.2); /* Darson blue focus ring */
            outline: none;
        }
        label {
            font-weight: 500; /* medium */
            color: #4a5568; /* cool-gray-700 */
        }

        /* Button styling */
        .btn {
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.375rem; /* md */
            font-weight: 500; /* medium */
            transition: background-color 0.3s ease, transform 0.1s ease;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background-color: #1a3b5d; /* Darson blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2a5282; /* Lighter Darson blue */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* cool-gray-200 */
            color: #1a3b5d; /* Darson blue */
            border: 1px solid #cbd5e1; /* cool-gray-300 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* cool-gray-300 */
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #e53e3e; /* red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #c53030; /* red-700 */
            transform: translateY(-1px);
        }
        .btn-icon {
            padding: 0.5rem;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem; /* py-3 px-4 */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* cool-gray-200 */
        }
        th {
            background-color: #f8fafc; /* cool-gray-50 */
            font-weight: 600; /* semibold */
            color: #374151; /* cool-gray-700 */
        }
        tbody tr:hover {
            background-color: #f9fafb; /* cool-gray-50 slightly different for hover */
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto; /* For long modals */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem; /* lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            width: 90%;
            max-width: 500px; /* Default max-width */
        }
        .modal-content.modal-lg { /* For larger modals like image preview */
            max-width: 800px; 
        }
        .modal-title {
            font-size: 1.25rem; /* xl */
            font-weight: 600; /* semibold */
            margin-bottom: 1rem;
            color: #1a3b5d;
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: white;
                color: black;
                font-size: 10pt; /* Smaller font for print */
                margin: 0;
                padding: 0;
            }
            nav, .no-print, #sidebar {
                display: none !important;
            }
            .page-container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                width: 100% !important;
                max-width: 100% !important;
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
            }
            .print-header h1 {
                font-size: 18pt;
                font-weight: bold;
                margin: 0;
                color: black !important;
            }
            .print-header h2 {
                font-size: 14pt;
                margin: 0;
                color: black !important;
            }
            .print-header p {
                font-size: 10pt;
                margin: 5px 0;
                color: black !important;
            }
            .print-footer {
                display: block !important;
                text-align: center;
                font-size: 8pt;
                position: fixed;
                bottom: 10px;
                width: 100%;
                color: black !important;
            }
            table {
                font-size: 9pt;
                border: 1px solid #ccc; /* Add borders for tables in print */
            }
            th, td {
                border: 1px solid #ccc;
                padding: 4px 6px;
            }
            th {
                background-color: #eee !important; /* Light gray for table headers */
                color: black !important;
            }
            a {
                text-decoration: none;
                color: black;
            }
            img {
                max-width: 100% !important; /* Ensure images fit */
                page-break-inside: avoid;
            }
            .page-break-before {
                page-break-before: always;
            }
            .page-break-after {
                page-break-after: always;
            }
            /* Optimize content per page */
            @page {
                size: A4;
                margin: 0.75in;
            }
        }
        .print-header, .print-footer {
            display: none; /* Hidden by default, shown by print styles */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Navigation -->
        <nav id="sidebar" class="p-4 shadow-md">
            <div class="container mx-auto flex flex-wrap items-center justify-between">
                <div class="text-2xl font-bold">Darson Securities</div>
                <button id="mobileMenuButton" class="md:hidden p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                    <i class="fas fa-bars"></i>
                </button>
                <div id="navLinks" class="hidden md:flex md:items-center md:space-x-3 w-full md:w-auto mt-4 md:mt-0">
                    <a href="#" class="block md:inline-block px-3 py-2 active" data-page="dashboard"><i class="fas fa-tachometer-alt nav-icon"></i>Dashboard</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="reports"><i class="fas fa-chart-line nav-icon"></i>Reports</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="balanceTracking"><i class="fas fa-balance-scale nav-icon"></i>Balance Tracking</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="paymentRequests"><i class="fas fa-file-invoice-dollar nav-icon"></i>Payment Requests</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="courierTracking"><i class="fas fa-truck nav-icon"></i>Courier Tracking</a>
                    <a href="#" class="block md:inline-block px-3 py-2" data-page="branchBudget"><i class="fas fa-landmark nav-icon"></i>Branch Budget</a>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="container mx-auto p-4 flex-grow">
            <!-- Print Header (for all printable sections) -->
            <div class="print-header">
                <h1>Darson Securities Limited</h1>
                <h2 id="printReportTitle">Commission Report</h2>
                <p>Date: <span id="printReportDate"></span></p>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-container">
                <h2 class="text-2xl font-semibold mb-6 page-title">Commission Calculator</h2>
                
                <div class="mb-6 p-4 border rounded-lg bg-indigo-50">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-700">Select Date for Transactions</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="dashboardDateInput" class="block text-sm font-medium text-gray-700">Transaction Date:</label>
                            <input type="date" id="dashboardDateInput" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="loadDashboardDateBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-calendar-day mr-2"></i>Load/Refresh for Selected Date</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="stockName" class="block text-sm font-medium text-gray-700">Stock Name</label>
                        <input type="text" id="stockName" class="mt-1 p-2 border rounded-md w-full">
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="quantity" class="mt-1 p-2 border rounded-md w-full" min="0">
                    </div>
                    <div>
                        <label for="rate" class="block text-sm font-medium text-gray-700">Rate (PKR)</label>
                        <input type="number" id="rate" step="0.01" class="mt-1 p-2 border rounded-md w-full" min="0">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Commission per Stock</label>
                        <p id="commissionPerStock" class="mt-1 p-2 bg-gray-100 rounded-md">PKR 0.00</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Total Stock Commission</label>
                        <p id="totalStockCommission" class="mt-1 p-2 bg-gray-100 rounded-md">PKR 0.00</p>
                    </div>
                    <div class="flex items-end">
                        <button id="addTransactionBtn" class="btn btn-primary w-full"><i class="fas fa-plus-circle mr-2"></i>Add Transaction to List</button>
                    </div>
                </div>

                <h3 class="text-xl font-semibold mb-4 mt-8">Transactions for <span id="currentDateDisplay"></span></h3>
                <div class="overflow-x-auto mb-6">
                    <table id="dailyTransactionsTable" class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">Stock Name</th>
                                <th class="py-2 px-4 border-b">Quantity</th>
                                <th class="py-2 px-4 border-b">Rate</th>
                                <th class="py-2 px-4 border-b">Comm. per Stock</th>
                                <th class="py-2 px-4 border-b">Total Comm.</th>
                                <th class="py-2 px-4 border-b">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="dailySummary" class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="text-lg font-semibold mb-2">Summary for <span id="summaryDateDisplay"></span></h4>
                    <p>Gross Commission: <span id="dailyGrossCommission" class="font-bold">PKR 0.00</span></p>
                    <p>Head Office Deduction (40%): <span id="dailyHODeduction" class="font-bold">PKR 0.00</span></p>
                    <p>Tax Deduction (12% of remaining): <span id="dailyTaxDeduction" class="font-bold">PKR 0.00</span></p>
                    <p class="text-blue-600">Final House Commission: <span id="dailyFinalHouseCommission" class="font-bold text-xl">PKR 0.00</span></p>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="saveDayTransactionsBtn" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save Transactions for Selected Date</button>
                    <button id="printDayTransactionsBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Report for Selected Date</button>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reportsPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Reports</h2>
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3">View Daily Report</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="reportDate" class="block text-sm font-medium text-gray-700">Select Date:</label>
                            <input type="date" id="reportDate" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="viewDailyReportBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-eye mr-2"></i>View Report</button>
                        <button id="printDailyReportBtn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-print mr-2"></i>Print Report</button>
                        <button id="deleteDailyReportBtn" class="btn btn-danger w-full sm:w-auto"><i class="fas fa-trash-alt mr-2"></i>Delete Report</button>
                    </div>
                </div>
                <div id="dailyReportDisplay" class="mt-6 hidden">
                    <!-- Daily report content will be injected here -->
                </div>

                <div class="my-8 border-t pt-8"></div>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3">View Monthly Report</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                         <div class="flex-grow">
                            <label for="reportMonth" class="block text-sm font-medium text-gray-700">Select Month:</label>
                            <input type="month" id="reportMonth" class="mt-1 p-2 border rounded-md w-full">
                        </div>
                        <button id="viewMonthlyReportBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-calendar-alt mr-2"></i>View Report</button>
                        <button id="printMonthlyReportBtn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-print mr-2"></i>Print Report</button>
                         <button id="deleteMonthlyReportBtn" class="btn btn-danger w-full sm:w-auto"><i class="fas fa-trash-alt mr-2"></i>Delete Report</button>
                    </div>
                </div>
                <div id="monthlyReportDisplay" class="mt-6 hidden">
                    <!-- Monthly report content will be injected here -->
                </div>
            </div>

            <!-- Balance Tracking Page -->
            <div id="balanceTrackingPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Balance Tracking & Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-6 bg-blue-50 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-blue-700 mb-2">Current Overall Balance</h3>
                        <p id="currentOverallBalance" class="text-3xl font-bold text-blue-800">PKR 0.00</p>
                        <p class="text-sm text-gray-600">This balance reflects the cumulative final house commission after all deductions from saved daily transactions and adjustments.</p>
                    </div>
                    <div class="p-6 bg-green-50 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-green-700 mb-2">Manual Balance Adjustment</h3>
                         <label for="manualCommissionAmount" class="block text-sm font-medium text-gray-700">Amount to Add/Subtract:</label>
                        <input type="number" id="manualCommissionAmount" step="0.01" class="mt-1 mb-2 p-2 border rounded-md w-full" placeholder="Enter amount (e.g., 1000 or -500)">
                        <label for="manualCommissionReason" class="block text-sm font-medium text-gray-700">Reason:</label>
                        <input type="text" id="manualCommissionReason" class="mt-1 mb-3 p-2 border rounded-md w-full" placeholder="e.g., Previous month carry-over">
                        <button id="addManualCommissionBtn" class="btn btn-primary w-full"><i class="fas fa-plus-circle mr-2"></i>Adjust Balance</button>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-yellow-50 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-3">Month End Operations</h3>
                    <p class="text-sm text-gray-600 mb-3">At the end of a month, you can finalize the month's earnings. This does not automatically reset the overall balance but logs the month's performance.</p>
                    <button id="newMonthBtn" class="btn btn-primary"><i class="fas fa-calendar-check mr-2"></i>Finalize Current Month & Prepare for New Month</button>
                    <p id="newMonthStatus" class="mt-2 text-sm text-gray-700"></p>
                </div>
                 <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">Balance Adjustment History</h3>
                    <div class="overflow-x-auto">
                        <table id="balanceAdjustmentHistoryTable" class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reason</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- History will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="mt-8 p-6 bg-sky-50 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-sky-700 mb-4"><i class="fas fa-database mr-2"></i>Data Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Download all application data to a backup file. This file can be used to restore your data later.</p>
                            <button id="downloadDataBtn" class="btn btn-secondary w-full"><i class="fas fa-download mr-2"></i>Download All Data</button>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Restore application data from a previously downloaded backup file. <strong class="text-red-600">Warning: This will overwrite all current data in the application.</strong></p>
                            <input type="file" id="restoreDataInput" accept=".json" class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 mb-3">
                            <button id="restoreDataBtn" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Restore Data from File</button>
                        </div>
                    </div>
                </div>

                <div class="mt-12 p-6 bg-red-50 border border-red-300 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-red-700 mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Danger Zone</h3>
                    <p class="text-sm text-gray-700 mb-4">Warning: Resetting the application will permanently erase ALL data, including transactions, reports, balances, and settings. This action cannot be undone.</p>
                    <button id="resetApplicationDataBtn" class="btn btn-danger"><i class="fas fa-bomb mr-2"></i>Reset All Application Data</button>
                </div>
            </div>

            <!-- Payment Requests Page -->
            <div id="paymentRequestsPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Payment Requests</h2>
                <form id="paymentRequestForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Create New Payment Request</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="paymentRequestDate" class="block text-sm font-medium">Request Date</label>
                            <input type="date" id="paymentRequestDate" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="paymentRequestAmount" class="block text-sm font-medium">Amount (PKR)</label>
                            <input type="number" id="paymentRequestAmount" class="mt-1 w-full" min="0.01" step="0.01" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="paymentRequestDescription" class="block text-sm font-medium">Description</label>
                            <textarea id="paymentRequestDescription" rows="3" class="mt-1 w-full" required></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-paper-plane mr-2"></i>Submit Request</button>
                </form>

                <div id="paymentRequestsSummary" class="mb-6 p-4 bg-indigo-50 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-3">Current Month Summary (<span id="paymentSummaryMonth"></span>)</h3>
                    <p>Total Requested: <span id="totalRequestedAmount" class="font-bold">PKR 0.00</span></p>
                    <p>Total Approved: <span id="totalApprovedAmount" class="font-bold">PKR 0.00</span></p>
                    <p>Total Paid: <span id="totalPaidAmount" class="font-bold">PKR 0.00</span></p>
                    <p>Unpaid Approved Amount: <span id="totalUnpaidApprovedAmount" class="font-bold">PKR 0.00</span></p>
                    <button id="carryOverPaymentBtn" class="btn btn-secondary mt-3 text-sm"><i class="fas fa-random mr-2"></i>Carry Over Unpaid Approved to Next Month Balance</button>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Payment Request History</h3>
                    <button id="printPaymentRequestsBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Requests</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="paymentRequestsTable" class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Request Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Payment requests will be listed here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Courier Tracking Page -->
            <div id="courierTrackingPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Courier Tracking</h2>
                <form id="courierTrackingForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Add New Courier Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="courierType" class="block text-sm font-medium">Type</label>
                            <select id="courierType" class="mt-1 w-full">
                                <option value="outgoing">Outgoing</option>
                                <option value="incoming">Incoming</option>
                            </select>
                        </div>
                        <div>
                            <label for="courierDateSent" class="block text-sm font-medium">Date Sent/Received</label>
                            <input type="date" id="courierDateSent" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="courierTrackingId" class="block text-sm font-medium">Tracking ID</label>
                            <input type="text" id="courierTrackingId" class="mt-1 w-full"> <!-- Not always required e.g. local hand delivery -->
                        </div>
                         <div>
                            <label for="courierSenderName" class="block text-sm font-medium">Sender Name</label>
                            <input type="text" id="courierSenderName" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="courierReceiverName" class="block text-sm font-medium">Receiver Name</label>
                            <input type="text" id="courierReceiverName" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="courierDestination" class="block text-sm font-medium">Destination/Origin</label>
                            <input type="text" id="courierDestination" class="mt-1 w-full" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="courierStatus" class="block text-sm font-medium">Status</label>
                            <input type="text" id="courierStatus" class="mt-1 w-full" placeholder="e.g., Sent, In Transit, Delivered, Received" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="courierDescription" class="block text-sm font-medium">Description/Contents</label>
                            <textarea id="courierDescription" rows="2" class="mt-1 w-full"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-plus-circle mr-2"></i>Add Courier Entry</button>
                </form>

                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Courier Records</h3>
                    <button id="printCourierReportBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Courier Report</button>
                </div>
                 <div class="overflow-x-auto">
                    <table id="courierTrackingTable" class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Track ID</th>
                                <th>Sender</th>
                                <th>Receiver</th>
                                <th>Dest./Origin</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Courier records will be listed here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Branch Budget Page -->
            <div id="branchBudgetPage" class="page-container hidden">
                <h2 class="text-2xl font-semibold mb-6 page-title">Branch Budget Management</h2>
                 <form id="branchBudgetForm" class="mb-8 p-6 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4">Add New Budget Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="budgetEntryDate" class="block text-sm font-medium">Date</label>
                            <input type="date" id="budgetEntryDate" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="budgetItem" class="block text-sm font-medium">Item/Expense Description</label>
                            <input type="text" id="budgetItem" class="mt-1 w-full" required>
                        </div>
                        <div>
                            <label for="budgetAmount" class="block text-sm font-medium">Amount (PKR)</label>
                            <input type="number" id="budgetAmount" class="mt-1 w-full" min="0.01" step="0.01" required>
                        </div>
                        <div>
                            <label for="budgetBillImages" class="block text-sm font-medium">Upload Bill(s) (Image)</label>
                            <input type="file" id="budgetBillImages" accept="image/*" multiple class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div class="md:col-span-2">
                            <div id="billImagePreviewsContainer" class="hidden mt-2 flex flex-wrap gap-2 p-2 border rounded-md bg-gray-50 min-h-[50px]">
                                <!-- Image previews will be shown here -->
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-save mr-2"></i>Save Budget Entry</button>
                </form>

                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Budget Entries</h3>
                    <button id="printBudgetReportBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Budget Report</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="branchBudgetTable" class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Amount</th>
                                <th>Bill(s)</th>
                                <th class="action-column">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Budget entries will be listed here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Authentication Modal -->
            <div id="authModal" class="modal hidden">
                <div class="modal-content">
                    <h3 class="modal-title">Authentication Required</h3>
                    <p class="text-sm text-gray-600 mb-4">Please enter credentials to proceed.</p>
                    <div>
                        <label for="username" class="block text-sm font-medium">Username</label>
                        <input type="text" id="username" class="mt-1 w-full">
                    </div>
                    <div class="mt-4">
                        <label for="password" class="block text-sm font-medium">Password</label>
                        <input type="password" id="password" class="mt-1 w-full">
                    </div>
                    <p id="authError" class="text-red-500 text-sm mt-2 hidden"></p>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancelAuthBtn" class="btn btn-secondary">Cancel</button>
                        <button id="submitAuthBtn" class="btn btn-primary">Login</button>
                    </div>
                </div>
            </div>
            
            <!-- Generic Message Modal (can be used for info or simple confirmation) -->
            <div id="messageModal" class="modal hidden">
                <div class="modal-content">
                    <h3 id="messageModalTitle" class="modal-title">Notification</h3>
                    <p id="messageModalText" class="text-sm text-gray-700 my-4"></p>
                    <div id="messageModalButtons" class="mt-6 flex justify-end space-x-3">
                        <button id="messageModalOkBtn" class="btn btn-primary">OK</button>
                        <!-- Optional Cancel button for confirmation -->
                        <button id="messageModalCancelBtn" class="btn btn-secondary hidden">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Bill Preview Modal -->
            <div id="billPreviewModal" class="modal hidden">
                <div class="modal-content modal-lg"> 
                    <h3 id="billPreviewModalTitle" class="modal-title">Bill Preview</h3>
                    <div id="billPreviewImagesContainer" class="my-4 flex flex-col items-center gap-4 max-h-[70vh] overflow-y-auto bg-gray-100 p-2 rounded">
                        <!-- Multiple bill images will be shown here -->
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="printBillFromModalBtn" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Print Current Bill</button>
                        <button id="closeBillPreviewModalBtn" class="btn btn-primary">Close</button>
                    </div>
                </div>
            </div>


            <!-- Print Footer -->
            <div class="print-footer">
                <p>Developed by Afrasiab Asghar. Visit www.nextgensites.org or Contact +923060406003</p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white text-center p-4 no-print">
            <p>&copy; <span id="currentYear"></span> Darson Securities Limited. All rights reserved.</p>
            <p class="text-sm text-gray-400">Developed by Afrasiab Asghar. Visit <a href="http://www.nextgensites.org" target="_blank" class="underline hover:text-gray-200">www.nextgensites.org</a> or Contact +923060406003</p>
        </footer>
    </div>

    <script>
        // --- UTILITY FUNCTIONS ---
        const Utils = {
            formatDateForStorage: (date) => {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = ('0' + (d.getMonth() + 1)).slice(-2);
                const day = ('0' + d.getDate()).slice(-2);
                return `${year}-${month}-${day}`;
            },
            formatDateForDisplay: (dateString) => {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}-${month}-${year}`;
            },
            formatMonthForDisplay: (monthString) => {
                if (!monthString) return '';
                const [year, month] = monthString.split('-');
                const monthNames = ["January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            },
            formatCurrency: (amount) => `PKR ${parseFloat(amount).toFixed(2)}`,
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9),
            showMessage: (title, message) => {
                document.getElementById('messageModalTitle').textContent = title;
                document.getElementById('messageModalText').textContent = message;
                document.getElementById('messageModalOkBtn').onclick = () => Utils.hideMessageModal();
                document.getElementById('messageModalCancelBtn').classList.add('hidden');
                document.getElementById('messageModal').classList.remove('hidden');
            },
            showConfirmationModal: (title, message, onOkCallback, onCancelCallback) => {
                document.getElementById('messageModalTitle').textContent = title;
                document.getElementById('messageModalText').textContent = message;
                const okBtn = document.getElementById('messageModalOkBtn');
                const cancelBtn = document.getElementById('messageModalCancelBtn');
                okBtn.onclick = () => { Utils.hideMessageModal(); if (onOkCallback) onOkCallback(); };
                cancelBtn.onclick = () => { Utils.hideMessageModal(); if (onCancelCallback) onCancelCallback(); };
                cancelBtn.classList.remove('hidden');
                document.getElementById('messageModal').classList.remove('hidden');
            },
            hideMessageModal: () => document.getElementById('messageModal').classList.add('hidden'),
            getTodayDateString: () => Utils.formatDateForStorage(new Date()),
            getCurrentMonthYearString: () => {
                const now = new Date();
                return `${now.getFullYear()}-${('0' + (now.getMonth() + 1)).slice(-2)}`;
            }
        };
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- APPLICATION STATE AND DATA MANAGEMENT ---
        const AppState = {
            currentPage: 'dashboard',
            currentTransactions: [], 
            targetDateForDashboard: Utils.getTodayDateString(), 
            dailyDataCache: {}, 
            monthlyDataCache: {}, 
            authCallback: null, 
            itemToDeleteType: null, 
            itemToDeleteId: null, 
        };

        const StorageService = {
            prefix: 'darsonApp_',
            getItem: (key) => { 
                const item = localStorage.getItem(StorageService.prefix + key); 
                try {
                    return item ? JSON.parse(item) : null; 
                } catch (e) {
                    console.error(`Error parsing localStorage item ${key}:`, e, item);
                    return null; // Return null if parsing fails
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(StorageService.prefix + key, JSON.stringify(value));
                } catch (e) {
                    console.error(`Error stringifying or setting localStorage item ${key}:`, e, value);
                    Utils.showMessage("Storage Error", "Could not save data. Local storage might be full or unavailable.");
                }
            },
            removeItem: (key) => localStorage.removeItem(StorageService.prefix + key),
            getAllKeysWithSubPrefix: (subPrefix) => {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(StorageService.prefix + subPrefix)) keys.push(key.replace(StorageService.prefix, ''));
                }
                return keys;
            },
            clearAllAppData: () => {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    if (localStorage.key(i).startsWith(StorageService.prefix)) keysToRemove.push(localStorage.key(i));
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
            },
            // New methods for backup/restore
            exportAllData: () => {
                const allData = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const prefixedKey = localStorage.key(i);
                    if (prefixedKey.startsWith(StorageService.prefix)) {
                        const unprefixedKey = prefixedKey.replace(StorageService.prefix, '');
                        const value = StorageService.getItem(unprefixedKey); // getItem handles parsing
                        if (value !== null) { 
                            allData.push({ key: unprefixedKey, value: value });
                        }
                    }
                }
                return allData;
            },
            importAllData: (dataToRestore) => { 
                try {
                    StorageService.clearAllAppData(); 
                    if (Array.isArray(dataToRestore)) {
                        dataToRestore.forEach(item => {
                            if (item && typeof item.key === 'string' && item.value !== undefined) {
                                StorageService.setItem(item.key, item.value); // setItem handles stringify & prefix
                            }
                        });
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error("Error during data import:", e);
                    Utils.showMessage("Import Error", "Failed to import data. The file might be corrupted or incompatible.");
                    return false;
                }
            }
        };
        
        // --- COMMISSION CALCULATION LOGIC ---
        const CommissionService = {
            calculateCommission: (rate, quantity) => {
                let commissionPerStockValue;
                rate = parseFloat(rate); quantity = parseInt(quantity);
                if (isNaN(rate) || isNaN(quantity) || rate <= 0 || quantity <= 0) return { commissionPerStock: 0, totalStockCommission: 0 };
                if (rate >= 0.01 && rate <= 3.00) commissionPerStockValue = 0.03;
                else if (rate >= 3.01 && rate <= 20.00) commissionPerStockValue = 0.07;
                else if (rate >= 20.01 && rate <= 40.00) commissionPerStockValue = 0.09;
                else if (rate >= 40.01 && rate <= 50.00) commissionPerStockValue = 0.12;
                else if (rate >= 50.01 && rate <= 90.00) commissionPerStockValue = 0.14;
                else if (rate >= 90.01 && rate <= 100.00) commissionPerStockValue = 0.17;
                else if (rate > 100.00) commissionPerStockValue = rate * 0.0017;
                else commissionPerStockValue = 0;
                return { commissionPerStock: commissionPerStockValue, totalStockCommission: commissionPerStockValue * quantity };
            },
            calculateDeductions: (grossCommission) => {
                const hoDeduction = grossCommission * 0.40;
                const remainingAfterHO = grossCommission - hoDeduction;
                const taxDeduction = remainingAfterHO * 0.12;
                const finalHouseCommission = remainingAfterHO - taxDeduction;
                return { grossCommission, hoDeduction, taxDeduction, finalHouseCommission };
            }
        };

        // --- UI RENDERING AND EVENT HANDLERS ---
        const UIController = {
            init: () => {
                // Navigation
                document.querySelectorAll('nav a[data-page]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault(); UIController.navigateTo(link.dataset.page);
                        document.querySelectorAll('nav a[data-page]').forEach(l => l.classList.remove('active'));
                        link.classList.add('active'); document.getElementById('navLinks').classList.add('hidden');
                    });
                });
                document.getElementById('mobileMenuButton').addEventListener('click', () => document.getElementById('navLinks').classList.toggle('hidden'));

                // Set dates
                document.getElementById('dashboardDateInput').value = AppState.targetDateForDashboard; 
                document.getElementById('reportDate').value = Utils.getTodayDateString();
                document.getElementById('reportMonth').value = Utils.getCurrentMonthYearString();

                // Dashboard Listeners
                document.getElementById('dashboardDateInput').addEventListener('change', () => {
                    AppState.targetDateForDashboard = document.getElementById('dashboardDateInput').value || Utils.getTodayDateString();
                    UIController.loadTransactionsForDashboard(AppState.targetDateForDashboard);
                });
                document.getElementById('loadDashboardDateBtn').addEventListener('click', () => {
                    const selectedDate = document.getElementById('dashboardDateInput').value || Utils.getTodayDateString();
                    UIController.loadTransactionsForDashboard(selectedDate);
                });
                ['quantity', 'rate'].forEach(id => document.getElementById(id).addEventListener('input', UIController.updateDashboardCommissionDisplay));
                document.getElementById('addTransactionBtn').addEventListener('click', UIController.addTransactionToCurrentList);
                document.getElementById('saveDayTransactionsBtn').addEventListener('click', UIController.saveCurrentDayTransactions);
                document.getElementById('printDayTransactionsBtn').addEventListener('click', () => UIController.printReport('daily_current'));

                // Reports Page Listeners
                document.getElementById('viewDailyReportBtn').addEventListener('click', UIController.displayDailyReport);
                document.getElementById('printDailyReportBtn').addEventListener('click', () => UIController.printReport('daily_historical'));
                document.getElementById('deleteDailyReportBtn').addEventListener('click', () => {
                     const d = document.getElementById('reportDate').value; if (!d) { Utils.showMessage('Input Required', 'Select date to delete.'); return; }
                    UIController.requestAuthThenDelete('dailyReport', d);
                });
                document.getElementById('viewMonthlyReportBtn').addEventListener('click', UIController.displayMonthlyReport);
                document.getElementById('printMonthlyReportBtn').addEventListener('click', () => UIController.printReport('monthly'));
                document.getElementById('deleteMonthlyReportBtn').addEventListener('click', () => {
                    const m = document.getElementById('reportMonth').value; if (!m) { Utils.showMessage('Input Required', 'Select month to delete.'); return; }
                    UIController.requestAuthThenDelete('monthlyReport', m);
                });

                // Balance Tracking & Settings Listeners
                document.getElementById('addManualCommissionBtn').addEventListener('click', BalanceTrackingController.addManualBalanceAdjustment);
                document.getElementById('newMonthBtn').addEventListener('click', BalanceTrackingController.finalizeCurrentMonth);
                document.getElementById('resetApplicationDataBtn').addEventListener('click', DataResetService.initiateFullResetProcess);
                // New Data Management Listeners
                document.getElementById('downloadDataBtn').addEventListener('click', DataBackupRestoreController.downloadData);
                document.getElementById('restoreDataBtn').addEventListener('click', DataBackupRestoreController.initiateRestoreData);


                // Payment Requests Listeners
                document.getElementById('paymentRequestForm').addEventListener('submit', PaymentRequestController.handleAddRequest);
                document.getElementById('printPaymentRequestsBtn').addEventListener('click', () => UIController.printReport('paymentRequests'));
                document.getElementById('carryOverPaymentBtn').addEventListener('click', PaymentRequestController.carryOverUnpaidApproved);
                
                // Courier Tracking Listeners
                document.getElementById('courierTrackingForm').addEventListener('submit', CourierTrackingController.handleAddEntry);
                document.getElementById('printCourierReportBtn').addEventListener('click', () => UIController.printReport('courierTracking'));

                // Branch Budget Listeners
                document.getElementById('branchBudgetForm').addEventListener('submit', BranchBudgetController.handleAddEntry);
                document.getElementById('budgetBillImages').addEventListener('change', BranchBudgetController.previewBillImages); 
                document.getElementById('printBudgetReportBtn').addEventListener('click', () => UIController.printReport('branchBudget'));
                document.getElementById('closeBillPreviewModalBtn').addEventListener('click', BranchBudgetController.hideBillPreviewModal);
                document.getElementById('printBillFromModalBtn').addEventListener('click', BranchBudgetController.printSpecificBillFromModal);

                // Modal Listeners
                document.getElementById('cancelAuthBtn').addEventListener('click', UIController.hideAuthModal);
                document.getElementById('submitAuthBtn').addEventListener('click', AuthController.handleLogin);
                
                UIController.navigateTo('dashboard'); 
            },

            navigateTo: (pageId) => {
                document.querySelectorAll('.page-container').forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden'); AppState.currentPage = pageId;
                    if (pageId === 'dashboard') UIController.loadTransactionsForDashboard(AppState.targetDateForDashboard); 
                    if (pageId === 'balanceTracking') { BalanceTrackingController.updateOverallBalanceDisplay(); BalanceTrackingController.loadAdjustmentHistory(); }
                    if (pageId === 'paymentRequests') PaymentRequestController.loadRequests();
                    if (pageId === 'courierTracking') CourierTrackingController.loadEntries();
                    if (pageId === 'branchBudget') BranchBudgetController.loadEntries();
                    if (pageId === 'reports') { document.getElementById('dailyReportDisplay').classList.add('hidden').innerHTML = ''; document.getElementById('monthlyReportDisplay').classList.add('hidden').innerHTML = ''; }
                } else console.error(`Page ${pageId}Page not found.`);
            },

            loadTransactionsForDashboard: (dateString) => {
                AppState.targetDateForDashboard = dateString; 
                document.getElementById('dashboardDateInput').value = dateString; 
                
                const displayDate = Utils.formatDateForDisplay(dateString);
                const isToday = dateString === Utils.getTodayDateString();
                const dateLabel = `${displayDate} ${isToday ? '(Today)' : '(Selected Date)'}`;
                document.getElementById('currentDateDisplay').textContent = dateLabel;
                document.getElementById('summaryDateDisplay').textContent = displayDate;

                const data = StorageService.getItem(`transactions_${dateString}`);
                if (data && data.transactions) {
                    AppState.currentTransactions = data.transactions.map(tx => ({...tx, tempId: tx.tempId || Utils.generateId()}));
                } else {
                    AppState.currentTransactions = []; 
                }
                UIController.renderCurrentTransactionsTable(); 
                UIController.updateDailySummaryDisplay();    
                UIController.resetDashboardCalculatorFields(); 
            },

            updateDashboardCommissionDisplay: () => {
                const q = parseFloat(document.getElementById('quantity').value) || 0, r = parseFloat(document.getElementById('rate').value) || 0;
                const { commissionPerStock, totalStockCommission } = CommissionService.calculateCommission(r, q);
                document.getElementById('commissionPerStock').textContent = Utils.formatCurrency(commissionPerStock);
                document.getElementById('totalStockCommission').textContent = Utils.formatCurrency(totalStockCommission);
            },

            addTransactionToCurrentList: () => {
                const sn = document.getElementById('stockName').value.trim(), q = parseInt(document.getElementById('quantity').value), r = parseFloat(document.getElementById('rate').value);
                if (!sn || isNaN(q) || q <= 0 || isNaN(r) || r <= 0) { Utils.showMessage('Validation Error', 'Enter valid Stock Name, Quantity, and Rate.'); return; }
                const { commissionPerStock, totalStockCommission } = CommissionService.calculateCommission(r, q);
                AppState.currentTransactions.push({ 
                    tempId: Utils.generateId(), 
                    stockName: sn, quantity: q, rate: r, 
                    commissionPerStock, totalStockCommission, 
                    transactionTime: new Date().toLocaleTimeString() 
                });
                UIController.renderCurrentTransactionsTable(); 
                UIController.updateDailySummaryDisplay(); 
                UIController.resetDashboardCalculatorFields();
            },

            resetDashboardCalculatorFields: () => {
                document.getElementById('stockName').value = ''; document.getElementById('quantity').value = ''; document.getElementById('rate').value = '';
                document.getElementById('stockName').focus(); UIController.updateDashboardCommissionDisplay();
            },
            
            renderCurrentTransactionsTable: () => {
                const tbody = document.getElementById('dailyTransactionsTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
                if (AppState.currentTransactions.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No transactions for this date.</td></tr>'; return; }
                AppState.currentTransactions.forEach(tx => {
                    const row = tbody.insertRow(); 
                    row.insertCell().textContent = tx.stockName; 
                    row.insertCell().textContent = tx.quantity; 
                    row.insertCell().textContent = Utils.formatCurrency(tx.rate);
                    row.insertCell().textContent = Utils.formatCurrency(tx.commissionPerStock); 
                    row.insertCell().textContent = Utils.formatCurrency(tx.totalStockCommission);
                    const ac = row.insertCell(); const rmBtn = document.createElement('button'); 
                    rmBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; rmBtn.classList.add('btn', 'btn-danger', 'btn-icon', 'text-xs');
                    rmBtn.onclick = () => UIController.removeTransactionFromCurrentList(tx.tempId); 
                    ac.appendChild(rmBtn);
                });
            },

            removeTransactionFromCurrentList: (tempId) => { 
                AppState.currentTransactions = AppState.currentTransactions.filter(tx => tx.tempId !== tempId);
                UIController.renderCurrentTransactionsTable(); 
                UIController.updateDailySummaryDisplay();
            },

            updateDailySummaryDisplay: () => { 
                const gc = AppState.currentTransactions.reduce((s, tx) => s + tx.totalStockCommission, 0);
                const d = CommissionService.calculateDeductions(gc);
                document.getElementById('dailyGrossCommission').textContent = Utils.formatCurrency(d.grossCommission);
                document.getElementById('dailyHODeduction').textContent = Utils.formatCurrency(d.hoDeduction);
                document.getElementById('dailyTaxDeduction').textContent = Utils.formatCurrency(d.taxDeduction);
                document.getElementById('dailyFinalHouseCommission').textContent = Utils.formatCurrency(d.finalHouseCommission);
            },

            saveCurrentDayTransactions: () => {
                const targetDate = AppState.targetDateForDashboard;
                const existingDataForDate = StorageService.getItem(`transactions_${targetDate}`);
                if (AppState.currentTransactions.length === 0 && !existingDataForDate) {
                    Utils.showMessage('No Transactions', `No transactions to save for ${Utils.formatDateForDisplay(targetDate)}.`);
                    return;
                }

                const grossCommission = AppState.currentTransactions.reduce((sum, tx) => sum + tx.totalStockCommission, 0);
                const deductions = CommissionService.calculateDeductions(grossCommission);
                const transactionsToSave = AppState.currentTransactions.map(tx => {
                    const { tempId, ...rest } = tx; 
                    return { ...rest, transactionTime: tx.transactionTime || new Date().toLocaleTimeString() }; 
                });

                const dailyReportDataToSave = {
                    date: targetDate,
                    transactions: transactionsToSave,
                    ...deductions
                };

                StorageService.setItem(`transactions_${targetDate}`, dailyReportDataToSave);
                BalanceTrackingController.updateOverallBalanceDisplay(); 
                Utils.showMessage('Success', `Transactions for ${Utils.formatDateForDisplay(targetDate)} saved successfully.`);
                UIController.resetDashboardCalculatorFields(); 
            },

            displayDailyReport: () => {
                const rd = document.getElementById('reportDate').value; if (!rd) { Utils.showMessage('Input Required', 'Select date.'); return; }
                const data = StorageService.getItem(`transactions_${rd}`), displayDiv = document.getElementById('dailyReportDisplay');
                if (!data) { displayDiv.innerHTML = `<p class="text-red-500">No data for ${Utils.formatDateForDisplay(rd)}.</p>`; displayDiv.classList.remove('hidden'); return; }
                AppState.dailyDataCache[rd] = data;
                let html = `<h3 class="text-xl font-semibold mb-2">Daily Report for ${Utils.formatDateForDisplay(rd)}</h3><div class="overflow-x-auto"><table class="min-w-full bg-white mb-4"><thead><tr><th>Stock</th><th>Qty</th><th>Rate</th><th>Comm/S</th><th>Total Comm.</th><th>Time</th></tr></thead><tbody>`;
                data.transactions.forEach(tx => { html += `<tr><td>${tx.stockName}</td><td>${tx.quantity}</td><td>${Utils.formatCurrency(tx.rate)}</td><td>${Utils.formatCurrency(tx.commissionPerStock)}</td><td>${Utils.formatCurrency(tx.totalStockCommission)}</td><td>${tx.transactionTime||'N/A'}</td></tr>`; });
                html += `</tbody></table></div><div class="p-4 bg-gray-100 rounded"><p>Gross: <span class="font-bold">${Utils.formatCurrency(data.grossCommission)}</span></p><p>HO Deduct: <span class="font-bold">${Utils.formatCurrency(data.hoDeduction)}</span></p><p>Tax: <span class="font-bold">${Utils.formatCurrency(data.taxDeduction)}</span></p><p class="text-blue-600">Final: <span class="font-bold text-xl">${Utils.formatCurrency(data.finalHouseCommission)}</span></p></div>`;
                displayDiv.innerHTML = html; displayDiv.classList.remove('hidden');
            },

            displayMonthlyReport: () => {
                const rmy = document.getElementById('reportMonth').value; if (!rmy) { Utils.showMessage('Input Required', 'Select month.'); return; }
                const keys = StorageService.getAllKeysWithSubPrefix('transactions_');
                const reports = keys.filter(k => k.startsWith(`transactions_${rmy}`)).map(k => StorageService.getItem(k)).filter(d => d).sort((a,b) => new Date(a.date) - new Date(b.date));
                const displayDiv = document.getElementById('monthlyReportDisplay');
                if (reports.length === 0) { displayDiv.innerHTML = `<p class="text-red-500">No data for ${Utils.formatMonthForDisplay(rmy)}.</p>`; displayDiv.classList.remove('hidden'); return; }
                let tg=0, th=0, tt=0, tf=0; reports.forEach(d => { tg+=d.grossCommission; th+=d.hoDeduction; tt+=d.taxDeduction; tf+=d.finalHouseCommission; });
                AppState.monthlyDataCache[rmy] = { month: rmy, dailySummaries: reports, totalGross:tg, totalHO:th, totalTax:tt, totalFinal:tf };
                let html = `<h3 class="text-xl font-semibold mb-2">Monthly Report for ${Utils.formatMonthForDisplay(rmy)}</h3><div class="overflow-x-auto"><table class="min-w-full bg-white mb-4"><thead><tr><th>Date</th><th>Gross</th><th>HO</th><th>Tax</th><th>Final</th></tr></thead><tbody>`;
                reports.forEach(d => { html += `<tr><td>${Utils.formatDateForDisplay(d.date)}</td><td>${Utils.formatCurrency(d.grossCommission)}</td><td>${Utils.formatCurrency(d.hoDeduction)}</td><td>${Utils.formatCurrency(d.taxDeduction)}</td><td>${Utils.formatCurrency(d.finalHouseCommission)}</td></tr>`; });
                html += `</tbody></table></div><div class="p-4 bg-gray-100 rounded mt-4"><h4 class="text-lg font-semibold mb-2">Totals:</h4><p>Gross: <span class="font-bold">${Utils.formatCurrency(tg)}</span></p><p>HO: <span class="font-bold">${Utils.formatCurrency(th)}</span></p><p>Tax: <span class="font-bold">${Utils.formatCurrency(tt)}</span></p><p class="text-blue-600">Final: <span class="font-bold text-xl">${Utils.formatCurrency(tf)}</span></p></div>`;
                displayDiv.innerHTML = html; displayDiv.classList.remove('hidden');
            },
            
            printReport: (type) => {
                const titleEl = document.getElementById('printReportTitle'), dateEl = document.getElementById('printReportDate');
                let content = '', rTitle = 'Report', rDateStr = Utils.formatDateForDisplay(Utils.getTodayDateString());

                if (type === 'daily_current') {
                    if (AppState.currentTransactions.length === 0) { Utils.showMessage('Error', 'No transactions on dashboard to print.'); return; }
                    rTitle = `Daily Commission Report`;
                    rDateStr = Utils.formatDateForDisplay(AppState.targetDateForDashboard); 

                    let tempTableHtml = '<table class="min-w-full bg-white"><thead><tr><th>Stock Name</th><th>Quantity</th><th>Rate</th><th>Comm. per Stock</th><th>Total Comm.</th><th>Time</th></tr></thead><tbody>';
                    AppState.currentTransactions.forEach(tx => {
                        tempTableHtml += `<tr><td>${tx.stockName}</td><td>${tx.quantity}</td><td>${Utils.formatCurrency(tx.rate)}</td><td>${Utils.formatCurrency(tx.commissionPerStock)}</td><td>${Utils.formatCurrency(tx.totalStockCommission)}</td><td>${tx.transactionTime || 'N/A'}</td></tr>`;
                    });
                    tempTableHtml += '</tbody></table>';

                    const currentGross = AppState.currentTransactions.reduce((sum, tx) => sum + tx.totalStockCommission, 0);
                    const currentDeductions = CommissionService.calculateDeductions(currentGross);
                    let tempSummaryHtml = `<div class="p-4 bg-gray-100 rounded-lg shadow mt-4">
                        <h4 class="text-lg font-semibold mb-2">Summary for ${rDateStr}</h4>
                        <p>Gross Commission: <span class="font-bold">${Utils.formatCurrency(currentDeductions.grossCommission)}</span></p>
                        <p>Head Office Deduction (40%): <span class="font-bold">${Utils.formatCurrency(currentDeductions.hoDeduction)}</span></p>
                        <p>Tax Deduction (12% of remaining): <span class="font-bold">${Utils.formatCurrency(currentDeductions.taxDeduction)}</span></p>
                        <p class="text-blue-600">Final House Commission: <span class="font-bold text-xl">${Utils.formatCurrency(currentDeductions.finalHouseCommission)}</span></p>
                    </div>`;
                    content = `<div class="page-container">${tempTableHtml}${tempSummaryHtml}</div>`;
                }
                else if (type === 'daily_historical') { const d = document.getElementById('reportDate').value, data = AppState.dailyDataCache[d]; if (!data) { Utils.showMessage('Error', 'View daily report first.'); return; } rTitle = 'Daily Commission Report'; rDateStr = Utils.formatDateForDisplay(data.date); content = `<div class="page-container">${document.getElementById('dailyReportDisplay').innerHTML}</div>`; }
                else if (type === 'monthly') { const m = document.getElementById('reportMonth').value, data = AppState.monthlyDataCache[m]; if (!data) { Utils.showMessage('Error', 'View monthly report first.'); return; } rTitle = 'Monthly Commission Report'; rDateStr = Utils.formatMonthForDisplay(data.month); content = `<div class="page-container">${document.getElementById('monthlyReportDisplay').innerHTML}</div>`; }
                else if (type === 'paymentRequests') { rTitle = 'Payment Requests Report'; content = `<div class="page-container"><h3>${document.getElementById('paymentRequestsSummary').innerHTML.replace(/<button.*?<\/button>/gi, '')}</h3>${document.getElementById('paymentRequestsTable').outerHTML}</div>`; }
                else if (type === 'courierTracking') { rTitle = 'Courier Tracking Report'; content = `<div class="page-container">${document.getElementById('courierTrackingTable').outerHTML}</div>`; }
                else if (type === 'branchBudget') { rTitle = 'Branch Budget Report'; let tbl = '<table>' + document.getElementById('branchBudgetTable').innerHTML + '</table>'; tbl = tbl.replace(/<th class="action-column">Actions<\/th>/gi, '<th></th>').replace(/<td class="action-column">.*?<\/td>/gi, '<td></td>'); content = `<div class="page-container">${tbl}</div>`; }
                else { Utils.showMessage('Error', 'Unknown report type.'); return; }
                
                titleEl.textContent = rTitle; dateEl.textContent = rDateStr; const origBody = document.body.innerHTML;
                document.body.innerHTML = document.querySelector('.print-header').outerHTML + content + document.querySelector('.print-footer').outerHTML;
                window.print(); document.body.innerHTML = origBody; UIController.init(); UIController.navigateTo(AppState.currentPage);
                if (AppState.currentPage === 'dashboard') { UIController.loadTransactionsForDashboard(AppState.targetDateForDashboard); } 
                if (AppState.currentPage === 'reports') { if (document.getElementById('reportDate').value && AppState.dailyDataCache[document.getElementById('reportDate').value]) UIController.displayDailyReport(); if (document.getElementById('reportMonth').value && AppState.monthlyDataCache[document.getElementById('reportMonth').value]) UIController.displayMonthlyReport(); }
                if (AppState.currentPage === 'paymentRequests') PaymentRequestController.loadRequests(); if (AppState.currentPage === 'courierTracking') CourierTrackingController.loadEntries(); if (AppState.currentPage === 'branchBudget') BranchBudgetController.loadEntries();
            },

            showAuthModal: (callback, itemType, itemId) => {
                AppState.authCallback = callback; AppState.itemToDeleteType = itemType; AppState.itemToDeleteId = itemId;
                document.getElementById('username').value = ''; document.getElementById('password').value = '';
                document.getElementById('authError').classList.add('hidden'); document.getElementById('authModal').classList.remove('hidden'); document.getElementById('username').focus();
            },
            hideAuthModal: () => {
                document.getElementById('authModal').classList.add('hidden'); AppState.authCallback = null; AppState.itemToDeleteType = null; AppState.itemToDeleteId = null;
            },
            requestAuthThenDelete: (itemType, itemId) => {
                UIController.showAuthModal(() => {
                    if (itemType === 'dailyReport') { StorageService.removeItem(`transactions_${itemId}`); delete AppState.dailyDataCache[itemId]; document.getElementById('dailyReportDisplay').innerHTML = `<p class="text-green-500">Report for ${Utils.formatDateForDisplay(itemId)} deleted.</p>`; Utils.showMessage('Success', `Daily report for ${Utils.formatDateForDisplay(itemId)} deleted.`); }
                    else if (itemType === 'monthlyReport') { const keys = StorageService.getAllKeysWithSubPrefix('transactions_'); let c = 0; keys.forEach(k => { if (k.startsWith(`transactions_${itemId}`)) { StorageService.removeItem(k); c++; } }); delete AppState.monthlyDataCache[itemId]; document.getElementById('monthlyReportDisplay').innerHTML = `<p class="text-green-500">Data for ${Utils.formatMonthForDisplay(itemId)} (${c} days) deleted.</p>`; Utils.showMessage('Success', `Data for ${Utils.formatMonthForDisplay(itemId)} deleted.`); }
                    BalanceTrackingController.updateOverallBalanceDisplay();
                }, itemType, itemId);
            },
            refreshAllPagesAfterDataChange: () => {
                // Reset caches
                AppState.dailyDataCache = {};
                AppState.monthlyDataCache = {};
                // Optionally, try to restore targetDateForDashboard if it was part of settings in backup
                // For now, default to today or keep current if not restoring settings affecting it
                AppState.targetDateForDashboard = Utils.getTodayDateString();


                // Reload data for all relevant sections by calling their main load functions
                UIController.loadTransactionsForDashboard(AppState.targetDateForDashboard); // Handles dashboard
                BalanceTrackingController.updateOverallBalanceDisplay();
                BalanceTrackingController.loadAdjustmentHistory();
                PaymentRequestController.loadRequests();
                CourierTrackingController.loadEntries();
                BranchBudgetController.loadEntries();

                // If on reports page, clear current display
                if (AppState.currentPage === 'reports') {
                    document.getElementById('dailyReportDisplay').classList.add('hidden').innerHTML = '';
                    document.getElementById('monthlyReportDisplay').classList.add('hidden').innerHTML = '';
                }
                // Navigate to dashboard to ensure a clean state or refresh current page
                UIController.navigateTo(AppState.currentPage); 
            }
        };

        const AuthController = {
            USERNAME: "DARSON", PASSWORD: "AFRASIAB", 
            handleLogin: () => {
                const u = document.getElementById('username').value.toUpperCase(), p = document.getElementById('password').value, errEl = document.getElementById('authError');
                if (u === AuthController.USERNAME && p === AuthController.PASSWORD) { errEl.classList.add('hidden'); if (typeof AppState.authCallback === 'function') AppState.authCallback(); UIController.hideAuthModal(); }
                else { errEl.textContent = 'Invalid credentials.'; errEl.classList.remove('hidden'); }
            }
        };
        
        const DataResetService = {
            initiateFullResetProcess: () => {
                Utils.showConfirmationModal(
                    "Confirm Data Reset", 
                    "Are you sure you want to start the full application data reset process? This is irreversible.",
                    () => { 
                        UIController.showAuthModal(() => { 
                            DataResetService.finalConfirmationForReset();
                        }, 'fullReset', null); 
                    },
                    () => { Utils.showMessage('Cancelled', 'Data reset process cancelled.'); } 
                );
            },
            finalConfirmationForReset: () => {
                Utils.showConfirmationModal(
                    "FINAL WARNING: Erase All Data?",
                    "All application data (transactions, reports, balances, settings, etc.) will be PERMANENTLY ERASED. This action CANNOT BE UNDONE. Are you absolutely sure you want to proceed?",
                    () => { 
                        DataResetService.performFullReset();
                    },
                    () => { Utils.showMessage('Cancelled', 'Final data reset cancelled.'); } 
                );
            },
            performFullReset: () => {
                StorageService.clearAllAppData(); 
                UIController.refreshAllPagesAfterDataChange(); // Use centralized refresh
                Utils.showMessage('Success', 'All application data has been reset successfully.');
            }
        };

        const BalanceTrackingController = {
            SETTINGS_KEY: 'appSettings', ADJUSTMENT_HISTORY_KEY: 'balanceAdjustments',
            getSettings: () => StorageService.getItem(BalanceTrackingController.SETTINGS_KEY) || { overallBalance: 0, lastFinalizedMonth: null },
            saveSettings: (s) => StorageService.setItem(BalanceTrackingController.SETTINGS_KEY, s),
            getAdjustmentHistory: () => StorageService.getItem(BalanceTrackingController.ADJUSTMENT_HISTORY_KEY) || [],
            saveAdjustmentHistory: (h) => StorageService.setItem(BalanceTrackingController.ADJUSTMENT_HISTORY_KEY, h),

            updateOverallBalanceDisplay: () => {
                let bal = 0; const keys = StorageService.getAllKeysWithSubPrefix('transactions_');
                keys.forEach(k => { const d = StorageService.getItem(k); if (d && d.finalHouseCommission) bal += parseFloat(d.finalHouseCommission); });
                const adj = BalanceTrackingController.getAdjustmentHistory(); adj.forEach(a => bal += parseFloat(a.amount));
                const s = BalanceTrackingController.getSettings(); s.overallBalance = bal; BalanceTrackingController.saveSettings(s);
                document.getElementById('currentOverallBalance').textContent = Utils.formatCurrency(s.overallBalance);
            },
            addManualBalanceAdjustment: () => {
                const amtIn = document.getElementById('manualCommissionAmount'), rsnIn = document.getElementById('manualCommissionReason');
                const amt = parseFloat(amtIn.value), rsn = rsnIn.value.trim();
                if (isNaN(amt) || amt === 0) { Utils.showMessage('Validation Error', 'Enter valid non-zero amount.'); return; }
                if (!rsn) { Utils.showMessage('Validation Error', 'Enter reason.'); return; }
                const adj = { id: Utils.generateId(), date: Utils.getTodayDateString(), amount: amt, reason: rsn, type: amt > 0 ? 'Credit' : 'Debit (Manual)' };
                const hist = BalanceTrackingController.getAdjustmentHistory(); hist.unshift(adj); BalanceTrackingController.saveAdjustmentHistory(hist);
                BalanceTrackingController.updateOverallBalanceDisplay(); BalanceTrackingController.loadAdjustmentHistory();
                amtIn.value = ''; rsnIn.value = ''; Utils.showMessage('Success', 'Balance adjusted.');
            },
            loadAdjustmentHistory: () => {
                const hist = BalanceTrackingController.getAdjustmentHistory(), tbody = document.getElementById('balanceAdjustmentHistoryTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
                if (hist.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-3">No adjustments.</td></tr>'; return; }
                hist.forEach(adj => {
                    const r = tbody.insertRow(); r.insertCell().textContent = Utils.formatDateForDisplay(adj.date); r.insertCell().textContent = adj.reason;
                    r.insertCell().textContent = Utils.formatCurrency(adj.amount); r.insertCell().textContent = adj.type;
                    r.cells[2].classList.toggle('text-green-600', parseFloat(adj.amount) > 0); r.cells[2].classList.toggle('text-red-600', parseFloat(adj.amount) < 0);
                });
            },
            finalizeCurrentMonth: () => {
                const cmy = Utils.getCurrentMonthYearString(), s = BalanceTrackingController.getSettings();
                if (s.lastFinalizedMonth === cmy) { Utils.showMessage('Info', `Month ${Utils.formatMonthForDisplay(cmy)} already finalized.`); return; }
                const keys = StorageService.getAllKeysWithSubPrefix('transactions_'); let me = 0;
                keys.forEach(k => { if (k.startsWith(`transactions_${cmy}`)) { const d = StorageService.getItem(k); if (d && d.finalHouseCommission) me += parseFloat(d.finalHouseCommission); } });
                s.lastFinalizedMonth = cmy; BalanceTrackingController.saveSettings(s);
                const stEl = document.getElementById('newMonthStatus');
                stEl.textContent = `Month ${Utils.formatMonthForDisplay(cmy)} finalized (Earnings: ${Utils.formatCurrency(me)}). Ready for new month.`;
                stEl.classList.add('text-green-600'); Utils.showMessage('Month Finalized', `Month ${Utils.formatMonthForDisplay(cmy)} earnings: ${Utils.formatCurrency(me)}.`);
            }
        };

        const PaymentRequestController = {
            STORAGE_KEY: 'paymentRequests',
            getRequests: () => StorageService.getItem(PaymentRequestController.STORAGE_KEY) || [],
            saveRequests: (r) => StorageService.setItem(PaymentRequestController.STORAGE_KEY, r),

            handleAddRequest: (e) => {
                e.preventDefault(); const d = document.getElementById('paymentRequestDate').value, a = parseFloat(document.getElementById('paymentRequestAmount').value), desc = document.getElementById('paymentRequestDescription').value.trim();
                if (!d || isNaN(a) || a <= 0 || !desc) { Utils.showMessage('Validation Error', 'Fill all fields.'); return; }
                const nr = { id: Utils.generateId(), requestDate: d, amount: a, description: desc, status: 'Pending', entryDate: Utils.getTodayDateString() };
                const rs = PaymentRequestController.getRequests(); rs.unshift(nr); PaymentRequestController.saveRequests(rs);
                PaymentRequestController.loadRequests(); document.getElementById('paymentRequestForm').reset(); Utils.showMessage('Success', 'Request submitted.');
            },
            loadRequests: () => {
                const rs = PaymentRequestController.getRequests(), tbody = document.getElementById('paymentRequestsTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
                if (rs.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-3">No requests.</td></tr>'; }
                else { rs.forEach(req => {
                        const r = tbody.insertRow(); r.insertCell().textContent = req.id.slice(-6).toUpperCase(); r.insertCell().textContent = Utils.formatDateForDisplay(req.requestDate);
                        r.insertCell().textContent = Utils.formatCurrency(req.amount); r.insertCell().textContent = req.description;
                        const sc = r.insertCell(), ss = document.createElement('select'); ss.classList.add('p-1','border','rounded-md','text-sm','bg-white','w-full');
                        ['Pending','Approved','Paid','Rejected'].forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; if(s===req.status)o.selected=true; ss.appendChild(o); });
                        ss.onchange=(e)=>PaymentRequestController.updateStatus(req.id,e.target.value); sc.appendChild(ss);
                        const ac = r.insertCell(), delBtn = document.createElement('button'); delBtn.innerHTML='<i class="fas fa-trash-alt"></i>'; delBtn.classList.add('btn','btn-danger','btn-icon','text-xs');
                        delBtn.onclick=()=>PaymentRequestController.deleteRequest(req.id); ac.appendChild(delBtn);
                    }); }
                PaymentRequestController.updatePaymentSummary();
            },
            updateStatus: (id, newStatus) => {
                let requests = PaymentRequestController.getRequests();
                const requestIndex = requests.findIndex(req => req.id === id);

                if (requestIndex === -1) {
                    Utils.showMessage('Error', 'Payment request not found.');
                    return;
                }

                const oldStatus = requests[requestIndex].status;
                requests[requestIndex].status = newStatus;
                PaymentRequestController.saveRequests(requests);

                if (newStatus === 'Approved' && oldStatus !== 'Approved') {
                    const approvedRequest = requests[requestIndex];
                    const amountToDeduct = parseFloat(approvedRequest.amount);
                    const reason = `Approved Payment: ${approvedRequest.description.substring(0,25)} (ID: ${approvedRequest.id.slice(-6).toUpperCase()})`;

                    const adjustmentHistory = BalanceTrackingController.getAdjustmentHistory();
                    const newAdjustment = {
                        id: Utils.generateId(),
                        date: Utils.getTodayDateString(),
                        amount: -amountToDeduct, 
                        reason: reason,
                        type: 'Debit (Payment Appr.)' 
                    };
                    adjustmentHistory.unshift(newAdjustment);
                    BalanceTrackingController.saveAdjustmentHistory(adjustmentHistory);
                    BalanceTrackingController.updateOverallBalanceDisplay(); 

                    Utils.showMessage('Status & Balance Updated', `Request status: ${newStatus}. ${Utils.formatCurrency(amountToDeduct)} deducted from balance.`);
                    
                    if (AppState.currentPage === 'balanceTracking') {
                        BalanceTrackingController.loadAdjustmentHistory();
                    }
                } else {
                     Utils.showMessage('Status Updated', `Request status: ${newStatus}.`);
                }
                PaymentRequestController.updatePaymentSummary(); 
            },
            deleteRequest: (id) => {
                Utils.showConfirmationModal('Delete Request', 'Are you sure you want to delete this payment request?', () => {
                    let rs = PaymentRequestController.getRequests(); rs = rs.filter(req => req.id !== id);
                    PaymentRequestController.saveRequests(rs); PaymentRequestController.loadRequests(); Utils.showMessage('Deleted', 'Request deleted.');
                });
            },
            updatePaymentSummary: () => {
                const rs = PaymentRequestController.getRequests(), cm = Utils.getCurrentMonthYearString();
                document.getElementById('paymentSummaryMonth').textContent = Utils.formatMonthForDisplay(cm);
                let tr=0, ta=0, tp=0; rs.filter(req => req.requestDate.startsWith(cm)).forEach(req => { tr+=parseFloat(req.amount); if(req.status==='Approved'||req.status==='Paid')ta+=parseFloat(req.amount); if(req.status==='Paid')tp+=parseFloat(req.amount); });
                const ua = ta - tp;
                document.getElementById('totalRequestedAmount').textContent=Utils.formatCurrency(tr); document.getElementById('totalApprovedAmount').textContent=Utils.formatCurrency(ta);
                document.getElementById('totalPaidAmount').textContent=Utils.formatCurrency(tp); document.getElementById('totalUnpaidApprovedAmount').textContent=Utils.formatCurrency(ua);
            },
            carryOverUnpaidApproved: () => {
                const rs = PaymentRequestController.getRequests(), cm = Utils.getCurrentMonthYearString();
                let unpaidApprovedForCarryOver = 0;
                rs.filter(req => req.requestDate.startsWith(cm) && req.status === 'Approved').forEach(req => unpaidApprovedForCarryOver += parseFloat(req.amount));

                if (unpaidApprovedForCarryOver <= 0) { Utils.showMessage('No Amount', 'No unpaid "Approved" amounts from current month to carry over.'); return; }
                Utils.showConfirmationModal('Carry Over Balance', `Carry over ${Utils.formatCurrency(unpaidApprovedForCarryOver)} (unpaid "Approved" from ${Utils.formatMonthForDisplay(cm)}) to balance adjustments as a negative (debit) entry? This will reflect as an expense covered.`, () => {
                    const rsn = `Carried over unpaid approved from ${Utils.formatMonthForDisplay(cm)}`;
                    const adjAmt = -unpaidApprovedForCarryOver; 
                    const adj = { id: Utils.generateId(), date: Utils.getTodayDateString(), amount: adjAmt, reason: rsn, type: 'Debit (Carry Over)' };
                    const hist = BalanceTrackingController.getAdjustmentHistory(); hist.unshift(adj); BalanceTrackingController.saveAdjustmentHistory(hist);
                    BalanceTrackingController.updateOverallBalanceDisplay(); BalanceTrackingController.loadAdjustmentHistory();
                    Utils.showMessage('Carried Over', `${Utils.formatCurrency(unpaidApprovedForCarryOver)} adjusted in balance.`);
                });
            }
        };
        
        const CourierTrackingController = {
            STORAGE_KEY: 'courierEntries',
            getEntries: () => StorageService.getItem(CourierTrackingController.STORAGE_KEY) || [],
            saveEntries: (e) => StorageService.setItem(CourierTrackingController.STORAGE_KEY, e),

            handleAddEntry: (e) => {
                e.preventDefault(); const typ = document.getElementById('courierType').value, dt = document.getElementById('courierDateSent').value, tid = document.getElementById('courierTrackingId').value.trim(),
                sn = document.getElementById('courierSenderName').value.trim(), rn = document.getElementById('courierReceiverName').value.trim(), dst = document.getElementById('courierDestination').value.trim(),
                st = document.getElementById('courierStatus').value.trim(), dsc = document.getElementById('courierDescription').value.trim();
                if (!dt||!sn||!rn||!dst||!st) { Utils.showMessage('Validation Error', 'Fill required courier fields.'); return; }
                const ne = { id:Utils.generateId(),type:typ,date:dt,trackingId:tid,senderName:sn,receiverName:rn,destination:dst,status:st,description:dsc,entryDate:Utils.getTodayDateString() };
                const es = CourierTrackingController.getEntries(); es.unshift(ne); CourierTrackingController.saveEntries(es);
                CourierTrackingController.loadEntries(); document.getElementById('courierTrackingForm').reset(); Utils.showMessage('Success', 'Courier entry added.');
            },
            loadEntries: () => {
                const es = CourierTrackingController.getEntries(), tbody = document.getElementById('courierTrackingTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
                if (es.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-3">No courier records.</td></tr>'; return; }
                es.forEach(en => {
                    const r = tbody.insertRow(); r.insertCell().textContent = en.id.slice(-6).toUpperCase(); r.insertCell().textContent = en.type.charAt(0).toUpperCase()+en.type.slice(1);
                    r.insertCell().textContent = Utils.formatDateForDisplay(en.date); r.insertCell().textContent = en.trackingId||'N/A'; r.insertCell().textContent = en.senderName;
                    r.insertCell().textContent = en.receiverName; r.insertCell().textContent = en.destination; r.insertCell().textContent = en.description||'N/A';
                    const sc = r.insertCell(), si = document.createElement('input'); si.type='text'; si.value=en.status; si.classList.add('p-1','border','rounded-md','text-sm','w-full','bg-white');
                    si.onchange=(e)=>CourierTrackingController.updateStatus(en.id,e.target.value); sc.appendChild(si);
                    const ac = r.insertCell(), delBtn = document.createElement('button'); delBtn.innerHTML='<i class="fas fa-trash-alt"></i>'; delBtn.classList.add('btn','btn-danger','btn-icon','text-xs');
                    delBtn.onclick=()=>CourierTrackingController.deleteEntry(en.id); ac.appendChild(delBtn);
                });
            },
            updateStatus: (id, newStatus) => {
                let es = CourierTrackingController.getEntries(); es = es.map(e => e.id === id ? { ...e, status: newStatus } : e); CourierTrackingController.saveEntries(es);
            },
            deleteEntry: (id) => {
                 Utils.showConfirmationModal('Delete Courier Entry', 'Are you sure you want to delete this courier entry?', () => {
                    let es = CourierTrackingController.getEntries(); es = es.filter(e => e.id !== id); CourierTrackingController.saveEntries(es);
                    CourierTrackingController.loadEntries(); Utils.showMessage('Deleted', 'Courier entry deleted.');
                });
            }
        };

        const BranchBudgetController = {
            STORAGE_KEY: 'branchBudgetEntries', 
            tempBillImagesBase64: [], 
            currentEditingBillIndex: null, 

            getEntries: () => StorageService.getItem(BranchBudgetController.STORAGE_KEY) || [],
            saveEntries: (e) => StorageService.setItem(BranchBudgetController.STORAGE_KEY, e),

            previewBillImages: (ev) => { 
                BranchBudgetController.tempBillImagesBase64 = [];
                const previewsContainer = document.getElementById('billImagePreviewsContainer');
                previewsContainer.innerHTML = ''; 
                const files = ev.target.files;

                if (files.length > 0) {
                    previewsContainer.classList.remove('hidden');
                    Array.from(files).forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            BranchBudgetController.tempBillImagesBase64.push(e.target.result);
                            const imgWrapper = document.createElement('div');
                            imgWrapper.classList.add('relative', 'inline-block');
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = `Preview ${index + 1}`;
                            img.classList.add('max-h-32', 'max-w-xs', 'rounded', 'border', 'p-1', 'object-contain');
                            imgWrapper.appendChild(img);
                            previewsContainer.appendChild(imgWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    previewsContainer.classList.add('hidden');
                }
            },

            handleAddEntry: (e) => {
                e.preventDefault(); 
                const dt = document.getElementById('budgetEntryDate').value, 
                      itm = document.getElementById('budgetItem').value.trim(), 
                      amt = parseFloat(document.getElementById('budgetAmount').value);

                if (!dt||!itm||isNaN(amt)||amt<=0) { Utils.showMessage('Validation Error', 'Fill Date, Item, and Amount.'); return; }
                
                const ne = {
                    id:Utils.generateId(),
                    date:dt,
                    item:itm,
                    amount:amt,
                    billImagesBase64: BranchBudgetController.tempBillImagesBase64, 
                    entryDate:Utils.getTodayDateString()
                };
                const es = BranchBudgetController.getEntries(); 
                es.unshift(ne); 
                BranchBudgetController.saveEntries(es); 
                BranchBudgetController.loadEntries();
                
                document.getElementById('branchBudgetForm').reset(); 
                document.getElementById('billImagePreviewsContainer').innerHTML = ''; 
                document.getElementById('billImagePreviewsContainer').classList.add('hidden');
                BranchBudgetController.tempBillImagesBase64 = []; 
                Utils.showMessage('Success', 'Budget entry added.');
            },

            loadEntries: () => {
                const es = BranchBudgetController.getEntries(), tbody = document.getElementById('branchBudgetTable').getElementsByTagName('tbody')[0]; 
                tbody.innerHTML = '';
                if (es.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-3">No budget entries.</td></tr>'; return; }
                
                es.forEach(en => {
                    const r = tbody.insertRow(); 
                    r.insertCell().textContent = en.id.slice(-6).toUpperCase(); 
                    r.insertCell().textContent = Utils.formatDateForDisplay(en.date);
                    r.insertCell().textContent = en.item; 
                    r.insertCell().textContent = Utils.formatCurrency(en.amount);
                    
                    const bc = r.insertCell(); 
                    if (en.billImagesBase64 && en.billImagesBase64.length > 0) { 
                        const viewBtn = document.createElement('button');
                        viewBtn.textContent = `View Bill(s) (${en.billImagesBase64.length})`;
                        viewBtn.classList.add('text-blue-600', 'hover:underline', 'text-sm', 'p-0', 'bg-transparent', 'border-none', 'cursor-pointer');
                        viewBtn.onclick = () => BranchBudgetController.showBillPreviewModal(en.billImagesBase64, en.item);
                        bc.appendChild(viewBtn);
                    } else { 
                        bc.textContent='No Bill(s)'; 
                    }
                    
                    const ac = r.insertCell(); 
                    ac.classList.add('action-column'); 
                    const delBtn = document.createElement('button'); 
                    delBtn.innerHTML='<i class="fas fa-trash-alt"></i>'; 
                    delBtn.classList.add('btn','btn-danger','btn-icon','text-xs');
                    delBtn.onclick=()=>BranchBudgetController.deleteEntry(en.id); 
                    ac.appendChild(delBtn);
                });
            },

            deleteEntry: (id) => {
                Utils.showConfirmationModal('Delete Budget Entry', 'Are you sure you want to delete this budget entry?', () => {
                    let es = BranchBudgetController.getEntries(); 
                    es = es.filter(e => e.id !== id); 
                    BranchBudgetController.saveEntries(es);
                    BranchBudgetController.loadEntries(); 
                    Utils.showMessage('Deleted', 'Budget entry deleted.');
                });
            },

            showBillPreviewModal: (imagesBase64Array, itemName) => {
                document.getElementById('billPreviewModalTitle').textContent = `Bill Preview: ${itemName || 'Bill'}`;
                const modalImagesContainer = document.getElementById('billPreviewImagesContainer');
                modalImagesContainer.innerHTML = ''; 
                BranchBudgetController.currentEditingBillIndex = null; 

                const printBillBtnModal = document.getElementById('printBillFromModalBtn');

                if (imagesBase64Array && imagesBase64Array.length > 0) {
                    imagesBase64Array.forEach((base64, index) => {
                        const img = document.createElement('img');
                        img.src = base64;
                        img.alt = `Bill ${index + 1}`;
                        img.classList.add('max-w-full', 'max-h-[60vh]', 'object-contain', 'mb-2', 'border', 'rounded');
                        img.dataset.billIndex = index; 
                        modalImagesContainer.appendChild(img);
                    });
                    if (imagesBase64Array.length === 1) {
                        printBillBtnModal.classList.remove('hidden');
                        printBillBtnModal.dataset.billImage = imagesBase64Array[0]; 
                    } else {
                        printBillBtnModal.classList.add('hidden');
                        delete printBillBtnModal.dataset.billImage;
                    }
                } else {
                     modalImagesContainer.textContent = "No bills to display.";
                     printBillBtnModal.classList.add('hidden');
                     delete printBillBtnModal.dataset.billImage;
                }
                document.getElementById('billPreviewModal').classList.remove('hidden');
            },

            hideBillPreviewModal: () => {
                document.getElementById('billPreviewModal').classList.add('hidden');
                document.getElementById('billPreviewImagesContainer').innerHTML = ""; 
                BranchBudgetController.currentEditingBillIndex = null;
                const printBillBtnModal = document.getElementById('printBillFromModalBtn');
                printBillBtnModal.classList.add('hidden');
                delete printBillBtnModal.dataset.billImage;
            },
            
            printSpecificBillFromModal: () => {
                const imageBase64 = document.getElementById('printBillFromModalBtn').dataset.billImage;
                if (!imageBase64) { 
                    Utils.showMessage('Error', 'No specific bill selected or available to print from modal.'); 
                    return; 
                }
                
                const printWindow = window.open('', '_blank', 'height=700,width=900'); 
                printWindow.document.write('<html><head><title>Print Bill</title>');
                printWindow.document.write('<style> body { margin: 20mm; display: flex; justify-content: center; align-items: flex-start; } img { max-width: 100%; height: auto; object-fit: contain; } @page { size: A4; margin: 20mm; } </style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<img src="' + imageBase64 + '" onload="window.focus(); setTimeout(function() { window.print(); setTimeout(function(){ printWindow.close(); }, 200); }, 200);">');
                printWindow.document.write('</body></html>');
                printWindow.document.close(); 
            }
        };

        // --- DATA BACKUP AND RESTORE CONTROLLER ---
        const DataBackupRestoreController = {
            downloadData: () => {
                try {
                    const allData = StorageService.exportAllData();
                    if (allData.length === 0) {
                        Utils.showMessage("No Data", "There is no data to download.");
                        return;
                    }
                    const jsonData = JSON.stringify(allData, null, 2); // Beautify JSON
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `darson_securities_backup_${Utils.formatDateForStorage(new Date())}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    Utils.showMessage("Success", "Data downloaded successfully.");
                } catch (error) {
                    console.error("Error downloading data:", error);
                    Utils.showMessage("Error", "Could not download data. " + error.message);
                }
            },

            initiateRestoreData: () => {
                const fileInput = document.getElementById('restoreDataInput');
                if (!fileInput.files || fileInput.files.length === 0) {
                    Utils.showMessage("No File", "Please select a backup file to restore.");
                    return;
                }
                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const fileContent = event.target.result;
                        const parsedData = JSON.parse(fileContent);
                        
                        Utils.showConfirmationModal(
                            "Confirm Data Restore",
                            "Are you sure you want to restore data from this file? ALL CURRENT DATA in the application will be overwritten. This action cannot be undone.",
                            () => {
                                if (StorageService.importAllData(parsedData)) {
                                    UIController.refreshAllPagesAfterDataChange();
                                    Utils.showMessage("Success", "Data restored successfully from " + file.name + ".");
                                } else {
                                    Utils.showMessage("Restore Failed", "Could not restore data. The file might be invalid or empty.");
                                }
                                fileInput.value = ''; // Reset file input
                            },
                            () => {
                                Utils.showMessage("Cancelled", "Data restore cancelled.");
                                fileInput.value = ''; // Reset file input
                            }
                        );
                    } catch (error) {
                        console.error("Error reading or parsing backup file:", error);
                        Utils.showMessage("File Error", "Could not read or parse the backup file. It may be corrupted or not a valid JSON backup. " + error.message);
                        fileInput.value = ''; // Reset file input
                    }
                };

                reader.onerror = () => {
                    Utils.showMessage("File Read Error", "Could not read the selected file.");
                    fileInput.value = ''; // Reset file input
                };
                reader.readAsText(file);
            }
        };

        document.addEventListener('DOMContentLoaded', UIController.init);
    </script>
</body>
</html>
